!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).LCC={})}(this,(function(t){"use strict";const e=0,s=1,i=2,a=0,r=1,n=2,h={1:"\n        data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQQAAAAVCAYAAACg9ZCAAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAuESURBVHhe7ZvrjuO4EYUpuW+TSX4k+ZEAm8dOgDzNIg+1wc5Mt62c7xSLotyS+rLpxS5Gp6dMqi6HRUksy/ZwmIRy4MCBA8JY2wMHDhwo7QnhL38/l5++nMrptpTLINXNVIbboZS7Syn3UxkfhjKdzjoeynAv3c2lTA+ncvkkkj+UMuF3qxjF3ny+K+XTKN1QLoq74C+/cieek0IfxvL0SfGyn+7l9zCVST4XOBRaNO54Yjzx3Z0k4lDcNF6KehJSniLP8qjuV+meyjR8UfuoST3KKr1eo/1W5Wfl98Ux03RTboYfy6fpX4q5NaemXm4k99NQ7jX18XImlfIwyheuSTnr+AflANR1RVVqjrtNDqV1kgv606i54HjRXKR3jF5uJKdhlI/Op3S6EOrr3BGDaCCO7/R6O8gLf3mO4mBMhJzwv5SvPja35G64Myv+wQX3oDGDc9SxBZtzCT/iNUl5BCKv4OSIY+LDV7lwXHniWK9yGvRCy/knO/fUyFUe4RtmKdBLdHosuqhlIER968/KR7cdupNsjEHMYJ2cZC/qN5FPuSgjWjiYD+PIBp/5yVjnd3qU7fHi6zBMmtmT1N/OZXjStXIOcCn2SQeMo4ZcdBe4dR5S42v/J/GeFSM5i2cSz3geda7FT07EMMZZ9/pFLHDqeLREjrrJ9aKGnD0+Bxwra90Hl6/n8vjlUa6j7rOTlqGurPMW56NyF8f47Ulr5t7c6OK8KJfLTbl8eSLSOmLwL5p/+fm/DMt9yMil/OnP5/Lzk06KbK0gaCGWW2WkBTt+YlFqQK0QCoILgBYzC374LHIWPQVBd+zNZy2NT7pt5NsKgorGakGg0DxEfF8QBq0YCsJ4rwAXBNmUThaESTlOnikzoyBokWdB0OKfuLq6SpOKg4uGFs1cELDfiPbH8sfyb/mrEOpuycVMMbjXHT3qwlEQ7rMgeLxS/uHXAJePBcLCJHVai3iUvm42zUUcStL/rMMu3W5BUD99KSAj+VRflVBLjoUfeYQNXlpmFQv9eUG4tMJCfuEfohPDa0NyDtyQap2X9fVY/hFb8yMAaYAvOKGOohjzsIJ/Eq0PixetEItMV5ubui7QmKciselSsBC8YOttYFkrCPjAzTEFgQWqRcuCXRQE3lu8qDRe44Jfwa3wwCc/9Z2r1MzJC1eLn2IwSViI8J+0YE/idiz5Vo6LeSUaf1Bh8lwoJvXkRUFQB17l4YKgv8uT7nAVhfPTOQqCxAXhaxYErm9cDcaaXMzEwTlUfhSUUfe+dRrbxZaCcGaN1HsAUIwYP8ENyMX1BQYyeuIV0cfBhxHcBLLO2W+RM5SaeIMfglqTFmgRlZMbskcbfw3pu+mDLvS+Qe1XITUnHw7nJ9ukJwXmE8sr4gC9XoD7ldO8vrASXRfr+BMxQ+gS+k+3R+Xgr+JqvomZW74p6DtZh4LihAiKUQ6+xtK1mw8RAfNuEt7272XkyUcyIFWHs2mg04ufqNyGzly8MKYWhBeW9KyNsNc/Fi1Ln4UaAQHOSS+daRfpxxg1j9XYzq8BXa/32Nmv4nnwVqUr6flKqX8syzgvXO8UmSTjqOXt+bEEuwGS01Kd95C+DcToH3lwVMN5A23D0IZbUyVaQehJTRIvampIHDZEnozsw9mOkAyVDXQx66gE3fgLVM5n52WPN21u14hn3bNzjunqrrGPe0yqi72ShspZ36TCBhXSX/89bPmYRy9uxSzJMdpY74H5orvAlv5DEPPx4wvt9YzqfJt0pl2kn+bRruVabOfXgC7Fl583hqVLwvpqtLte+vCUXSS5Rd7IHtK3h47zFqE2WTXfxC0R262YMReELRBB5FuA/1tjDhz4LSLvZeSFYl7X2W8Kb12Gc0FYifTjJPqcaTfbKFwyZlzvI3mpsL0aW3x7/Glzu3ZKZt2zIuz56sW6MNjHveUdQa+XhsrpNzod2gYVsnzI2MaWj3n04lbMkhyjjfUemC+6C2zpPwQxn3i0ytkgFXW+TTrTLtJP82jXci2282vI+SO+dtuDYtm2vhL9eDnPPaTvBjL8zR8Zev8ZutkyCoLOIfoyYgfVZ833PUjama9pjDb+GtJ30wdd6OFZ5IraJ8OdUOFD+4qPDO5Xzjku+qZ74V0moIir+SZmbop1FfSd7OO5F+kk7zW29P9PQB9DKC/mo0oa1/sqV3S9dKZdpF+diw/XYju/hkwO8bXbHhTLtvWV6MfLee4hfTeQ4W/+yND7J7jVfDMkQecQfRmxg+qz5vseQGvqysU3wz2Cf6lryDvYbSbYA13EBre7AUw+Ge6ECh+1fMsbvQC9XgBt/xE4banzz1NqMW9DEZ5vsgaSZ1RufJMc7VufEMxS2wC5kFs+0STsWfUfCehjCN6ANCc9ITCvyKDLCF0vnWkX6cf8EPprsZ1fQyaH/F6eEKrO6hruAptUtFDXbo+2onr/BLcaehsg6ByiLyN2UH3WfN8DaE1duSavpBnBv9Q1OOlsM8Ee6CI2uN0NYPLJcCdU+KjlF4HoBej1Amj7J960pS7XOeZtKCIrR4fk4Wfhi+zRvucJYclNLuTmHENl2LPqPxLQxxDxZHBRBYr/Y5JSga6XzrSL9GN+CP212M6vIZNDfO22B8WybX0l+vFynntI3wZi9DrEG4V/cuWL0LwhAZTh9izfVhDaierw7icEKduvE9ZZ2ZA/dTV1fiXagUOr5BPnpaVqxPhLXYOTzvaK2EAXscHtbkCmeLxSliSo7mk4xU909pv56PUCaP1OqzWHP3H+rZ8+69C/Y3OByCD++IkNap9vSGA5nhB8vMgIXS+daRfpx/wQ+muxnV9DJoe4jm4PimXb+kr04+U895C+DZHFYvkhbeJCuFifqsS8ohakiboIKkEfHXnKmHG9Tz84WOWe0bv2cJiMcV6uSBy0QZyEjlnzmfXPzjnqq/zTe/5cG2j6Kglz6sy65Th1VV6FldyXPCoeKWmr8jJWPJO3HgJ7Vf2vgzofVaD5XHcZoeulM+0i/fo5rsV2fg30U1xHtwfFsm19Jfrxcp57SN+GZUya3vwdwpI08P5fGfLd9DVYGbhH5XzGt8efNrdr/LMO3gU3pv7k9WBefeyVNMBZnxAW+rdgbXyAnicXt2J3TnMOv2i8tTG39B+CmE98dsnZIBV1vk060y7ST/No12QttvNryPkjv5cnhC4mTS6wqabFrXZ7zAXhwIED3z12PzL4vxhnGUmpiCIkY8b1Pgp6qbDNWBm4R+V8xrfHnza3a/yzDt4FN6att3bm1cdeSQOc3UeGd2FtfIA+v3NxnpFRL++C+aK7wJb+QxDziS8zcjZIRZ1vk860i/TTPNo1WYvt/Bpy/sj3/pEBdy+WStBHx5gyZlzvo6CX5jFjdWDDFvHEebnyM/9GbI7tmDWfWR/c7gZQ9ydPSO/IAQk0fZWEObuPDJY6zmKsPazkvuThHFdJW5WXseKZvPUQ2Kvqfx3U+egjw3yuu4zQ9dKZdpF+/RzXYju/Bvop38FHhrbb8a9/O5efvp7KeCtHVWjvamQr3d3FuxCf7XZkF+TabkcNvLrbcXP787C+27Fuf379bsdu+/Pqbsd++3PsdrwZ/lMeyj/lf+tde949qLMRux1VLbvdjuzyYzxO4A8+lQEqKluefKqk9+5DjuXi3Yr8OkEQManDLt1rdjveSZPbn71ZRrbr3Y7T9M15hI3c17Y/MybH7IbjOGzBpVjZgoPnwiX8O4huMvTOC131j63U4ZNxMV8gg0QuBmqbONbldEujNjc6ZT8LAzsd2QJNgfUvNTBgZ5feL9ntqPZVux0JYrejfH0b5XhQmq+O68VLX7zsdvxGDOdLawpufLyjkblI8K/jF7Yhw4+PzyrDQq4O/OQq/9Xtz2u7Hdn+fKtFJb7Fbkedl83djtfbnw8cOHAgytGBAwcOCEdBOHDgQEUp/wMm4LHFroKZGQAAAABJRU5ErkJggg==\n    "},o=0,l=1,c=1,u="Unknown",d="Windows",m="MacOS",p="Linux",x="Android",f="IOS",g="Unknown",M="Edge",y="Chrome",b="Firefox",w="Safari",v="Opera",S="IE",_="MicroMessenger",C="Feishu",T="DingTalk",D="Bytedance",P="NewsArticle",z="Zhihu",E="Weibo",A="AlipayClient",I="MQQBrowser",F="Unknown",R="NVIDIA",k="AMD",N="APPLE";class L{constructor(t=0,e=0,s=0,i=1){L.prototype.isVector4=!0,this.x=t,this.y=e,this.z=s,this.w=i}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,a=this.w,r=t.elements;return this.x=r[0]*e+r[4]*s+r[8]*i+r[12]*a,this.y=r[1]*e+r[5]*s+r[9]*i+r[13]*a,this.z=r[2]*e+r[6]*s+r[10]*i+r[14]*a,this.w=r[3]*e+r[7]*s+r[11]*i+r[15]*a,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,s,i,a;const r=.01,n=.1,h=t.elements,o=h[0],l=h[4],c=h[8],u=h[1],d=h[5],m=h[9],p=h[2],x=h[6],f=h[10];if(Math.abs(l-u)<r&&Math.abs(c-p)<r&&Math.abs(m-x)<r){if(Math.abs(l+u)<n&&Math.abs(c+p)<n&&Math.abs(m+x)<n&&Math.abs(o+d+f-3)<n)return this.set(1,0,0,0),this;e=Math.PI;const t=(o+1)/2,h=(d+1)/2,g=(f+1)/2,M=(l+u)/4,y=(c+p)/4,b=(m+x)/4;return t>h&&t>g?t<r?(s=0,i=.707106781,a=.707106781):(s=Math.sqrt(t),i=M/s,a=y/s):h>g?h<r?(s=.707106781,i=0,a=.707106781):(i=Math.sqrt(h),s=M/i,a=b/i):g<r?(s=.707106781,i=.707106781,a=0):(a=Math.sqrt(g),s=y/a,i=b/a),this.set(s,i,a,e),this}let g=Math.sqrt((x-m)*(x-m)+(c-p)*(c-p)+(u-l)*(u-l));return Math.abs(g)<.001&&(g=1),this.x=(x-m)/g,this.y=(c-p)/g,this.z=(u-l)/g,this.w=Math.acos((o+d+f-1)/2),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this.w=e[15],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(Math.max(t,Math.min(e,s)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this.w=t.w+(e.w-t.w)*s,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class B{type=u;version="Unknown"}class H{type=F;series="Unknown";model=0;textureSize=0;textureUnitsCount=0;limitLoadSplatCount=0}class q{type=g;version="Unknown"}class O{browser;gpu;os;libType;MaxCPUCacheSize;MaxGPUCacheSize;constructor(t){this.browser=this.#t(),this.gpu=this.#e(),this.os=this.#s(),this.libType=this.#i(t),this.MaxCPUCacheSize=1610612736,this.MaxGPUCacheSize=3221225472,this.os.type!==x&&this.os.type!==f||(this.MaxCPUCacheSize=104857600,this.MaxGPUCacheSize=209715200)}#i(t){let e=n;return t&&(t.BufferGeometry?e=a:t.Cartesian3&&(e=r)),console.log("engine type: "+e),e}#e(){const t=new H,e=document.createElement("canvas").getContext("experimental-webgl");if(!e)return console.log("WebGL not supported"),t;const s=e.getExtension("WEBGL_debug_renderer_info");if(s){const i=e.getParameter(s.UNMASKED_RENDERER_WEBGL),a=e.getParameter(s.UNMASKED_VENDOR_WEBGL);if(console.log(`GPU Renderer: ${i}`),console.log(`GPU Vendor: ${a}`),/NVIDIA/.test(a)){if(t.type=R,i){const e=i.match(/(?:GT|GTX|RTX)\s(\d+)/);if(e){const s=e[0],i=e[1];t.series=s,t.model=this.#a(i)?Number(i):i}}}else if(/AMD/.test(a)){if(t.type=k,i){const e=i.match(/(?:RX|HD|R7|R5)\s(\d+)/);if(e){const s=e[0],i=e[1];t.series=s,t.model=this.#a(i)?Number(i):i}}}else if(/Apple/.test(a)&&(t.type=N,i)){const e=i.match(/Apple\s+(M[12])/);if(e){const s=e[0],i=e[1];t.series=s,t.model=this.#a(i)?Number(i):i}}}else console.log("WEBGL_debug_renderer_info not available");return t.textureUnitsCount=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),t.textureSize=e.getParameter(e.MAX_TEXTURE_SIZE),t.limitLoadSplatCount=t.textureSize*t.textureSize/4,console.log("gpu: ",t.type,t.series,t.model),console.log("gl: ",t.textureUnitsCount,t.textureSize,t.limitLoadSplatCount),t}#s(){const t=navigator.userAgent.toLowerCase();let e=u,s="Unknown";if(t.includes("windows nt")){e=d;const i=t.match(/windows nt (\d+\.\d+)/);i&&i[1]&&(s=i[1])}else if(t.includes("macintosh")||t.includes("mac os x"))if(t.includes("iphone")||t.includes("ipad")){e=f;const i=t.match(/(iphone|cpu) os (\d+[._]\d+[._]?\d*)/);s=i.join("&"),i&&i[2]&&(s=i[2].replace(/_/g,"."))}else{e=m;const i=t.match(/mac os x (\d+[._]\d+)/);i&&i[1]&&(s=i[1].replace("_","."))}else if(t.includes("android")){e=x;const i=t.match(/android (\d+(\.\d+)?)/);i&&i[1]&&(s=i[1])}else t.includes("linux")&&(e=p);console.log("os: "+e+"/"+s);const i=new B;return i.type=e,i.version=s,i}#t(){console.log("userAgent: ",window.navigator.userAgent);const t=navigator.userAgent.toLowerCase();let e=g,s="Unknown";if(/Feishu|DingTalk|MicroMessenger|Bytedance|NewsArticle|Zhihu|Weibo|AlipayClient|MQQBrowser/.test(navigator.userAgent)){let t=navigator.userAgent.match(/Feishu|DingTalk|MicroMessenger|Bytedance|NewsArticle|Zhihu|Weibo|AlipayClient|MQQBrowser/);t=t&&t[0]?t[0]:"Unknown","Feishu"===t?e=C:"DingTalk"===t?e=T:"MicroMessenger"===t?e=_:"Bytedance"===t?e=D:"NewsArticle"===t?e=P:"Zhihu"===t?e=z:"Weibo"===t?e=E:"AlipayClient"===t?e=A:"MQQBrowser"===t&&(e=I),s=navigator.userAgent.match(/(?:Feishu|DingTalk|MicroMessenger|Bytedance|NewsArticle|Zhihu|Weibo|AlipayClient|MQQBrowser)\/([\d.]+)/),s=s&&s[1]?s[1]:"Unknown"}else/edg\//.test(t)?(e=M,s=t.match(/edg\/(\d+)/),s=s&&s[1]?s[1]:"Unknown"):/chrome|crios\//.test(t)&&!/edg\//.test(t)?(e=y,s=t.match(/(?:chrome|crios)\/(\d+)/),s=s&&s[1]?s[1]:"Unknown"):/firefox|fxios\//.test(t)?(e=b,s=t.match(/(?:firefox|fxios)\/(\d+)/),s=s&&s[1]?s[1]:"Unknown"):/safari/.test(t)&&!/chrome/.test(t)?(e=w,s=t.match(/version\/(\d+)/),s=s&&s[1]?s[1]:"Unknown"):/opr\//.test(t)||/opera/.test(t)?(e=v,s=t.match(/opr\/(\d+)/),s=s&&s[1]?s[1]:"Unknown"):(/msie/.test(t)||/trident/.test(t))&&(e=S,s=t.match(/(msie|rv:)(\d+)/),s=s&&s[2]?s[2]:"Unknown");console.log("browser: ",e,s);const i=new q;return i.type=e,i.version=s,i}#a(t){return/^-?\d+(\.\d+)?$/.test(t)}}const U=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let V=1234567;const j=Math.PI/180,G=180/Math.PI;function W(t,e,s){return Math.max(e,Math.min(s,t))}function Q(t,e){return(t%e+e)%e}function X(t,e,s){return(1-s)*t+s*e}const Z={DEG2RAD:j,RAD2DEG:G,generateUUID:function(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,s=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(U[255&t]+U[t>>8&255]+U[t>>16&255]+U[t>>24&255]+"-"+U[255&e]+U[e>>8&255]+"-"+U[e>>16&15|64]+U[e>>24&255]+"-"+U[63&s|128]+U[s>>8&255]+"-"+U[s>>16&255]+U[s>>24&255]+U[255&i]+U[i>>8&255]+U[i>>16&255]+U[i>>24&255]).toLowerCase()},clamp:W,euclideanModulo:Q,mapLinear:function(t,e,s,i,a){return i+(t-e)*(a-i)/(s-e)},inverseLerp:function(t,e,s){return t!==e?(s-t)/(e-t):0},lerp:X,damp:function(t,e,s,i){return X(t,e,1-Math.exp(-s*i))},pingpong:function(t,e=1){return e-Math.abs(Q(t,2*e)-e)},smoothstep:function(t,e,s){return t<=e?0:t>=s?1:(t=(t-e)/(s-e))*t*(3-2*t)},smootherstep:function(t,e,s){return t<=e?0:t>=s?1:(t=(t-e)/(s-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},seededRandom:function(t){void 0!==t&&(V=t);let e=V+=1831565813;return e=Math.imul(e^e>>>15,1|e),e^=e+Math.imul(e^e>>>7,61|e),((e^e>>>14)>>>0)/4294967296},degToRad:function(t){return t*j},radToDeg:function(t){return t*G},isPowerOfTwo:function(t){return!(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))},setQuaternionFromProperEuler:function(t,e,s,i,a){const r=Math.cos,n=Math.sin,h=r(s/2),o=n(s/2),l=r((e+i)/2),c=n((e+i)/2),u=r((e-i)/2),d=n((e-i)/2),m=r((i-e)/2),p=n((i-e)/2);switch(a){case"XYX":t.set(h*c,o*u,o*d,h*l);break;case"YZY":t.set(o*d,h*c,o*u,h*l);break;case"ZXZ":t.set(o*u,o*d,h*c,h*l);break;case"XZX":t.set(h*c,o*p,o*m,h*l);break;case"YXY":t.set(o*m,h*c,o*p,h*l);break;case"ZYZ":t.set(o*p,o*m,h*c,h*l);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+a)}},normalize:function(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return Math.round(4294967295*t);case Uint16Array:return Math.round(65535*t);case Uint8Array:return Math.round(255*t);case Int32Array:return Math.round(2147483647*t);case Int16Array:return Math.round(32767*t);case Int8Array:return Math.round(127*t);default:throw new Error("Invalid component type.")}},denormalize:function(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return t/4294967295;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int32Array:return Math.max(t/2147483647,-1);case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}};class Y{constructor(t=0,e=0,s=0,i=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=s,this._w=i}static slerpFlat(t,e,s,i,a,r,n){let h=s[i+0],o=s[i+1],l=s[i+2],c=s[i+3];const u=a[r+0],d=a[r+1],m=a[r+2],p=a[r+3];if(0===n)return t[e+0]=h,t[e+1]=o,t[e+2]=l,void(t[e+3]=c);if(1===n)return t[e+0]=u,t[e+1]=d,t[e+2]=m,void(t[e+3]=p);if(c!==p||h!==u||o!==d||l!==m){let t=1-n;const e=h*u+o*d+l*m+c*p,s=e>=0?1:-1,i=1-e*e;if(i>Number.EPSILON){const a=Math.sqrt(i),r=Math.atan2(a,e*s);t=Math.sin(t*r)/a,n=Math.sin(n*r)/a}const a=n*s;if(h=h*t+u*a,o=o*t+d*a,l=l*t+m*a,c=c*t+p*a,t===1-n){const t=1/Math.sqrt(h*h+o*o+l*l+c*c);h*=t,o*=t,l*=t,c*=t}}t[e]=h,t[e+1]=o,t[e+2]=l,t[e+3]=c}static multiplyQuaternionsFlat(t,e,s,i,a,r){const n=s[i],h=s[i+1],o=s[i+2],l=s[i+3],c=a[r],u=a[r+1],d=a[r+2],m=a[r+3];return t[e]=n*m+l*c+h*d-o*u,t[e+1]=h*m+l*u+o*c-n*d,t[e+2]=o*m+l*d+n*u-h*c,t[e+3]=l*m-n*c-h*u-o*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,s,i){return this._x=t,this._y=e,this._z=s,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const s=t._x,i=t._y,a=t._z,r=t._order,n=Math.cos,h=Math.sin,o=n(s/2),l=n(i/2),c=n(a/2),u=h(s/2),d=h(i/2),m=h(a/2);switch(r){case"XYZ":this._x=u*l*c+o*d*m,this._y=o*d*c-u*l*m,this._z=o*l*m+u*d*c,this._w=o*l*c-u*d*m;break;case"YXZ":this._x=u*l*c+o*d*m,this._y=o*d*c-u*l*m,this._z=o*l*m-u*d*c,this._w=o*l*c+u*d*m;break;case"ZXY":this._x=u*l*c-o*d*m,this._y=o*d*c+u*l*m,this._z=o*l*m+u*d*c,this._w=o*l*c-u*d*m;break;case"ZYX":this._x=u*l*c-o*d*m,this._y=o*d*c+u*l*m,this._z=o*l*m-u*d*c,this._w=o*l*c+u*d*m;break;case"YZX":this._x=u*l*c+o*d*m,this._y=o*d*c+u*l*m,this._z=o*l*m-u*d*c,this._w=o*l*c-u*d*m;break;case"XZY":this._x=u*l*c-o*d*m,this._y=o*d*c-u*l*m,this._z=o*l*m+u*d*c,this._w=o*l*c+u*d*m;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+r)}return!0===e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const s=e/2,i=Math.sin(s);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(s),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,s=e[0],i=e[4],a=e[8],r=e[1],n=e[5],h=e[9],o=e[2],l=e[6],c=e[10],u=s+n+c;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(l-h)*t,this._y=(a-o)*t,this._z=(r-i)*t}else if(s>n&&s>c){const t=2*Math.sqrt(1+s-n-c);this._w=(l-h)/t,this._x=.25*t,this._y=(i+r)/t,this._z=(a+o)/t}else if(n>c){const t=2*Math.sqrt(1+n-s-c);this._w=(a-o)/t,this._x=(i+r)/t,this._y=.25*t,this._z=(h+l)/t}else{const t=2*Math.sqrt(1+c-s-n);this._w=(r-i)/t,this._x=(a+o)/t,this._y=(h+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let s=t.dot(e)+1;return s<Number.EPSILON?(s=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=s):(this._x=0,this._y=-t.z,this._z=t.y,this._w=s)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=s),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(W(this.dot(t),-1,1)))}rotateTowards(t,e){const s=this.angleTo(t);if(0===s)return this;const i=Math.min(1,e/s);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const s=t._x,i=t._y,a=t._z,r=t._w,n=e._x,h=e._y,o=e._z,l=e._w;return this._x=s*l+r*n+i*o-a*h,this._y=i*l+r*h+a*n-s*o,this._z=a*l+r*o+s*h-i*n,this._w=r*l-s*n-i*h-a*o,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const s=this._x,i=this._y,a=this._z,r=this._w;let n=r*t._w+s*t._x+i*t._y+a*t._z;if(n<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,n=-n):this.copy(t),n>=1)return this._w=r,this._x=s,this._y=i,this._z=a,this;const h=1-n*n;if(h<=Number.EPSILON){const t=1-e;return this._w=t*r+e*this._w,this._x=t*s+e*this._x,this._y=t*i+e*this._y,this._z=t*a+e*this._z,this.normalize(),this}const o=Math.sqrt(h),l=Math.atan2(o,n),c=Math.sin((1-e)*l)/o,u=Math.sin(e*l)/o;return this._w=r*c+this._w*u,this._x=s*c+this._x*u,this._y=i*c+this._y*u,this._z=a*c+this._z*u,this._onChangeCallback(),this}slerpQuaternions(t,e,s){return this.copy(t).slerp(e,s)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),s=Math.random(),i=Math.sqrt(1-s),a=Math.sqrt(s);return this.set(i*Math.sin(t),i*Math.cos(t),a*Math.sin(e),a*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}fromCesiumMatrix4(t){let e,s,i,a,r,n=[1,2,0],h=new Array(3);const o=t[0],l=t[5],c=t[10],u=o+l+c;if(u>0)e=Math.sqrt(u+1),r=.5*e,e=.5/e,s=(t[6]-t[9])*e,i=(t[8]-t[2])*e,a=(t[1]-t[4])*e;else{const u=n;let d=0;l>o&&(d=1),c>o&&c>l&&(d=2);const m=u[d],p=u[m];e=Math.sqrt(t[K(d,d)]-t[K(m,m)]-t[K(p,p)]+1);const x=h;x[d]=.5*e,e=.5/e,r=(t[K(p,m)]-t[K(m,p)])*e,x[m]=(t[K(m,d)]+t[K(d,m)])*e,x[p]=(t[K(p,d)]+t[K(d,p)])*e,s=-x[0],i=-x[1],a=-x[2]}return this.x=s,this.y=i,this.z=a,this.w=r,this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}function K(t,e){return 4*t+e}class J{constructor(t=0,e=0,s=0){J.prototype.isVector3=!0,this.x=t,this.y=e,this.z=s}set(t,e,s){return void 0===s&&(s=this.z),this.x=t,this.y=e,this.z=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(tt.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(tt.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,s=this.y,i=this.z,a=t.elements;return this.x=a[0]*e+a[3]*s+a[6]*i,this.y=a[1]*e+a[4]*s+a[7]*i,this.z=a[2]*e+a[5]*s+a[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,s=this.y,i=this.z,a=t.elements,r=1/(a[3]*e+a[7]*s+a[11]*i+a[15]);return this.x=(a[0]*e+a[4]*s+a[8]*i+a[12])*r,this.y=(a[1]*e+a[5]*s+a[9]*i+a[13])*r,this.z=(a[2]*e+a[6]*s+a[10]*i+a[14])*r,this}applyQuaternion(t){const e=this.x,s=this.y,i=this.z,a=t.x,r=t.y,n=t.z,h=t.w,o=2*(r*i-n*s),l=2*(n*e-a*i),c=2*(a*s-r*e);return this.x=e+h*o+r*c-n*l,this.y=s+h*l+n*o-a*c,this.z=i+h*c+a*l-r*o,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,s=this.y,i=this.z,a=t.elements;return this.x=a[0]*e+a[4]*s+a[8]*i,this.y=a[1]*e+a[5]*s+a[9]*i,this.z=a[2]*e+a[6]*s+a[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(Math.max(t,Math.min(e,s)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this.z=t.z+(e.z-t.z)*s,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const s=t.x,i=t.y,a=t.z,r=e.x,n=e.y,h=e.z;return this.x=i*h-a*n,this.y=a*r-s*h,this.z=s*n-i*r,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const s=t.dot(this)/e;return this.copy(t).multiplyScalar(s)}projectOnPlane(t){return $.copy(this).projectOnVector(t),this.sub($)}reflect(t){return this.sub($.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(W(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y,i=this.z-t.z;return e*e+s*s+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,s){const i=Math.sin(e)*t;return this.x=i*Math.sin(s),this.y=Math.cos(e)*t,this.z=i*Math.cos(s),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,s){return this.x=t*Math.sin(e),this.y=s,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),s=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=s,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=2*Math.random()-1,s=Math.sqrt(1-e*e);return this.x=s*Math.cos(t),this.y=e,this.z=s*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const $=new J,tt=new Y;function et(t){return"number"==typeof t&&Number.isFinite(t)}function st(t){return!et(t)}function it(t){const e={x:2,y:2};for(;e.x*e.y<t;)e.y>e.x?e.x*=2:e.y*=2;return e}function at(t){if(!t)return 0;const e=Math.log2(t);return(e+1)*e/2}function rt(t,e){if(!e[t])return;const s=new J,i=e[t];if(Array.isArray(i)&&3===i.length)s.x=i[0],s.y=i[1],s.z=i[2];else{if(void 0===i?.x||void 0===i?.y||void 0===i?.z)return void console.error(`Set clip box ${t} failed, plase input [x, y, z] or {x, y, z}`);s.x=i.x,s.y=i.y,s.z=i.z}return s}function nt(t,e){let s,i;const a=e.x,r=e.y;if(t){const e=t.getBoundingClientRect(),n=e.left,h=e.top;s=(a-n)/e.width,i=(r-h)/e.height}else s=a/window.innerWidth,i=r/window.innerHeight,console.warn("没有传入canvas, 计算依据window窗口大小!");return new J(2*s-1,2*-i+1,.5)}class ht{LodStrategy=c;MaxLodDistance=200;LodStepDistance=20;MinValidSplatsInUnit=100;MinValidSplatsInNode=50;LodLevelUpSpatsInNode=8e5;MergeSplatsReqThreshold=8192;MergeSplatsReqEnable=!0;GloballHeight=20;CpuSortThreadNum=4;CameraPosChangedSortThreshold=.3;CameraAngleChangedSortThreshold=Math.cos(10*Math.PI/180);sortDrawCallCount=100;WebglSortingEnable=!1;AlwaysDownloadAround=!0;MinLodUsed=1;MaxDistaneLimit=200;maxLoadSplatCount=3e6;useSH=!1;useEnv=!0;pointsOnly=!1;visible=!0;alpha=1;pointsColor=l;gpuAcceleration=!1;constructor(t){if(!t)return;const e=t.os,s=t.gpu,i=t.browser;e.type===d?i.type!==b&&(s.type===R&&et(s.model)?s.model<1050?this.maxLoadSplatCount=1e6:s.model<2060&&(this.maxLoadSplatCount=2e6):s.type===k&&et(s.model)&&(s.model<560?this.maxLoadSplatCount=1e6:s.model<5600&&(this.maxLoadSplatCount=2e6))):e.type===m?this.maxLoadSplatCount=3e6:(e.type===f||e.type===x)&&(this.maxLoadSplatCount=8e5),e.type!==f&&e.type!==x||(this.MaxLodDistance=30,this.LodLevelUpSpatsInNode=5e5,this.CpuSortThreadNum=2,this.MinLodUsed=1,this.MaxDistaneLimit=100),this.maxLoadSplatCount=Math.min(s.limitLoadSplatCount,this.maxLoadSplatCount),console.log("m: ",this.maxLoadSplatCount)}getUserConfig(){return{useSH:this.useSH,useEnv:this.useEnv,pointsOnly:this.pointsOnly,pointsColor:this.pointsColor===o?"default":"rainbow",maxLoadSplatCount:this.maxLoadSplatCount,visible:this.visible}}setUserConfig(t){"boolean"==typeof t?.useSH&&(this.useSH=t.useSH),"boolean"==typeof t?.useEnv&&(this.useEnv=t.useEnv),"boolean"==typeof t?.pointsOnly&&(this.pointsOnly=t.pointsOnly),"default"!==t?.pointsColor&&"rainbow"!==t?.pointsColor||(this.pointsColor="default"===t?.pointsColor?o:l),"number"==typeof t?.maxLoadSplatCount&&(this.maxLoadSplatCount=t.maxLoadSplatCount),"boolean"==typeof t?.visible&&(this.visible=t.visible)}}class ot{constructor(){}get maxLoadSplatCount(){throw new Error("Must be implemented by subclass")}set maxLoadSplatCount(t){throw new Error("Must be implemented by subclass")}dispose(){throw new Error("Must be implemented by subclass")}update(t){throw new Error("Must be implemented by subclass")}load(t,e,s,i){throw new Error("Must be implemented by subclass")}getInstancedMesh(){throw new Error("Must be implemented by subclass")}getEnvInstancedMesh(){throw new Error("Must be implemented by subclass")}getBounds(){throw new Error("Must be implemented by subclass")}togglePointsDisplayMode(){throw new Error("Must be implemented by subclass")}useEnvironment(t){throw new Error("Must be implemented by subclass")}useShcoef(t,e){throw new Error("Must be implemented by subclass")}hasShcoef(){throw new Error("Must be implemented by subclass")}setVisible(t){throw new Error("Must be implemented by subclass")}setAlpha(t){throw new Error("Must be implemented by subclass")}setStartLod(t){throw new Error("Must be implemented by subclass")}setMaxDistance(t){throw new Error("Must be implemented by subclass")}setMaxSplats(t){throw new Error("Must be implemented by subclass")}setClipBox(t){throw new Error("Must be implemented by subclass")}setClipPlane(t,e){throw new Error("Must be implemented by subclass")}getCurrentConfig(){throw new Error("Must be implemented by subclass")}updateCurrentConfig(t){throw new Error("Must be implemented by subclass")}raycast(t){throw new Error("Must be implemented by subclass")}raycastFromOrigin(t){throw new Error("Must be implemented by subclass")}}class lt{constructor(t,e,s){this.prev=null,this.next=null,this.id=t,this.obj=e,this.size=s,this.refCnt=0}dispose(){this.prev=null,this.next=null,this.id=0,this.obj=null,this.size=0}}class ct{#r;#n;#h;#o;#l;#c;#u;constructor(t,e,s=null){this.#r=new lt(0,null,0),this.#r.prev=this.#r,this.#r.next=this.#r,this.#n=Object.create(null),this.#h=0,this.#o=0,this.#l=e,this.#c=s,this.#u=t||""}elements(){return this.#h}contains(t){return!!this.#n[t]}get(t,e=!0){let s=this.#n[t];return s?(e&&(s.prev.next=s.next,s.next.prev=s.prev,s.prev=this.#r,s.next=this.#r.next,this.#r.next.prev=s,this.#r.next=s),s.obj):null}add(t,e,s){if(this.contains(t))return!1;let i=new lt(t,e,s);return this.#n[t]=i,this.#h++,this.#o+=s,i.prev=this.#r,i.next=this.#r.next,this.#r.next.prev=i,this.#r.next=i,!0}flush(t,e,s){let i=this.#n[t];if(!i)return!1;let a=s-i.size;return i.obj=e,i.size=s,this.#o+=a,!0}remove(t){let e=this.#n[t];return!!e&&(this.#d(e),!0)}#d(t){t.prev.next=t.next,t.next.prev=t.prev,this.#h--,this.#o-=t.size,delete this.#n[t.id],this.#c&&this.#c(t.id,t.obj),t.dispose()}clear(){for(;this.#r.prev!=this.#r;){let t=this.#r.prev;this.#d(t)}}ref(t){let e=this.#n[t];e&&(e.refCnt+=1)}unref(t){let e=this.#n[t];e&&e.refCnt>0&&(e.refCnt-=1)}freeMemory(){if(this.#h<=1||this.#o<this.#l)return;let t=0,e=0,s=this.#r.prev;for(;this.#o>.7*this.#l;){let i=s;if(s=s.prev,i==this.#r){console.warn("you should never see this. (LRU free memory)");break}i.refCnt>0||(e+=i.size,t+=1,this.#d(i))}t>0&&console.log("LRU "+this.#u+" free memory(MB): ",t,(e/1048576).toFixed(1))}dispose(){this.clear(),this.#n={},this.#r.dispose(),console.log("LRU "+this.#u+" dispose !!!")}toString(){let t="{ ",e=this.#r.next;for(;e!=this.#r;)t+=e.id,e.next!=this.#r&&(t+=", "),e=e.next;return t+="}",t+="("+this.#h+")",t}}class ut{#m=!1;#p=0;#x;#f={};#l;#c;constructor(t,e){this.#l=t,this.#c=e,this.#x=new ct("CPU",t,e)}#g(t,e){return`${t}_${e}`}pushEnv(t,e,s,i,a){return!this.#m&&(this.#f[t]={splatCounts:e,data:s,sh:i,pos:a,size:0},!0)}queryEnv(t){return this.#m?null:this.#f[t]}pushData(t,e,s,i,a){if(this.#m)return!1;let r=this.#g(t,e),n=this.#x.get(r,!1);if(n){if(n.data)return!1;let t=n.size;return n.data=s,n.pos=a,n.size=t+i,this.#x.flush(r,n,n.size),!0}return n={data:s,sh:null,pos:a,size:i},this.#x.add(r,n,i),!0}pushSH(t,e,s,i){if(this.#m)return!1;let a=this.#g(t,e),r=this.#x.get(a,!1);if(r){if(r.sh)return!1;let t=r.size;return r.sh=s,r.size=t+i,this.#x.flush(a,r,r.size),!0}return r={data:null,sh:s,pos:null,size:i},this.#x.add(a,r,i),!0}queryOne(t,e,s=!0){if(this.#m)return null;let i=this.#g(t,e);return this.#x.get(i,s)}hasData(t,e){if(this.#m)return!1;let s=this.#g(t,e),i=this.#x.get(s,!1);return i&&i.data}hasSH(t,e){if(this.#m)return!1;let s=this.#g(t,e),i=this.#x.get(s,!1);return i&&i.sh}clear(t,e){if(this.#m)return!1;Array.isArray(e)?e.forEach((e=>{let s=this.#g(t,e);this.#x.remove(s)})):console.warn("nodeIDs must be Array !!!")}dispose(){this.#m=!0,this.#x.dispose(),Object.keys(this.#f).forEach((t=>{this.#c&&this.#c(t,this.#f[t])})),this.#f={}}update(t){this.#m||this.#x.freeMemory()}}function dt(t,e={}){return new Promise(((s,i)=>{const a=new Request(t,{headers:e});fetch(a).then((async t=>{if(t.ok)try{const e=await t.text();s(e)}catch(t){console.error(t),i("file fetch error, please ensure the path of file can access normally!")}else i("file fetch error, please ensure the path of file can access normally!")}))}))}function mt(t,e={}){return new Promise(((s,i)=>{const a=new Request(t,{headers:e});fetch(a).then((async t=>{if(t.ok)try{const e=await t.arrayBuffer();s(e)}catch(t){console.error(t),i("fetch bin error")}else i("fetch bin error")}))}))}class pt{constructor(){this.items=[]}traverse(t){this.items.forEach((e=>{t(e)}))}get isEmpty(){return 0===this.items.length}get length(){return this.items.length}enqueue(t){this.items.push(t)}dequeue(){return this.isEmpty?null:this.items.shift()}peek(){return this.isEmpty?null:this.items[0]}}async function xt(t){function e(t,e,s,i={}){return new Promise(((a,r)=>{if("bigint"==typeof e&&(e=Number(e)),("number"==typeof e||"bigint"==typeof e)&&"number"==typeof s){const t=`bytes=${e}-${e+s-1}`;i.Range=t}const n=new Request(`${t}?${Math.random()}`,{headers:i});try{fetch(n).then((t=>{try{if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);t.arrayBuffer().then((t=>{a(t)}))}catch(t){console.error("catch: ",t),a(void 0)}})).catch((()=>{a(void 0)}))}catch(t){a(void 0)}}))}const s=t.data,i=[];for(let t=0;t<s.length;t++){const{index:a,path:r,offset:n,size:h,headers:o}=s[t],l=e(r,n,h,o);i.push(l)}const a=async function(){const t=i.splice(0,5),e=await Promise.all(t),r=s.splice(0,5),n=[],h=[];for(let t=0;t<r.length;++t)e[t]&&(n.push(r[t]),h.push(e[t]));h.length>0?postMessage({payloads:n,data:h,isFinished:0===i.length},h):postMessage({payloads:n,data:h,isFinished:0===i.length}),i.length>0&&requestAnimationFrame(a)};a()}class ft{static GlobalID=0;isNode=!0;#M;#y=32;#b=64;#w;#v=-1;#S=null;#_=!1;#C=!1;#T=!1;#D=!1;visibleID=0;get id(){return this.#M}get level(){return this.#v}get points(){return this.#w.points}get offset(){return this.#w.offset}get size(){return this.#w.size}get shOffset(){return BigInt(Number(this.offset)/this.#y*this.#b)}get shSize(){return this.size/this.#y*this.#b}get parent(){return this.#S}set parent(t){this.#S=t}get renderID(){return this.#S.renderID}get unitID(){return this.#S.id}isDownloading(t){return t===e?this.#_:this.#C}setDownloading(t,s){t===e?this.#_=s:this.#C=s}isDecompressing(t){return t===e?this.#T:this.#D}setDecompressing(t,s){t===e?this.#T=s:this.#D=s}isDownloadingOrDecompressing(t){return t===e?this.#_||this.#T:this.#C||this.#D}isCache(t){let s=this.#S.cpuCache,i=this.#S.renderID;return t===e?s.hasData(i,this.id):s.hasSH(i,this.id)}queryCache(){let t=this.#S.cpuCache,e=this.#S.renderID;return t.queryOne(e,this.id,!0)}constructor(t,e){this.#M=ft.GlobalID++,this.#w=t,this.#v=e}dispose(){}}class gt{constructor(t=0,e=0){gt.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,s=this.y,i=t.elements;return this.x=i[0]*e+i[3]*s+i[6],this.y=i[1]*e+i[4]*s+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const s=this.length();return this.divideScalar(s||1).multiplyScalar(Math.max(t,Math.min(e,s)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const s=this.dot(t)/e;return Math.acos(W(s,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,s=this.y-t.y;return e*e+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,s){return this.x=t.x+(e.x-t.x)*s,this.y=t.y+(e.y-t.y)*s,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const s=Math.cos(e),i=Math.sin(e),a=this.x-t.x,r=this.y-t.y;return this.x=a*s-r*i+t.x,this.y=a*i+r*s+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Mt{constructor(t=new J(1/0,1/0,1/0),e=new J(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e+=3)this.expandByPoint(bt.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,s=t.count;e<s;e++)this.expandByPoint(bt.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,s=t.length;e<s;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const s=bt.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(s),this.max.copy(t).add(s),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const s=t.geometry;if(void 0!==s){const i=s.getAttribute("position");if(!0===e&&void 0!==i&&!0!==t.isInstancedMesh)for(let e=0,s=i.count;e<s;e++)!0===t.isMesh?t.getVertexPosition(e,bt):bt.fromBufferAttribute(i,e),bt.applyMatrix4(t.matrixWorld),this.expandByPoint(bt);else void 0!==t.boundingBox?(null===t.boundingBox&&t.computeBoundingBox(),wt.copy(t.boundingBox)):(null===s.boundingBox&&s.computeBoundingBox(),wt.copy(s.boundingBox)),wt.applyMatrix4(t.matrixWorld),this.union(wt)}const i=t.children;for(let t=0,s=i.length;t<s;t++)this.expandByObject(i[t],e);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,bt),bt.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,s;return t.normal.x>0?(e=t.normal.x*this.min.x,s=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,s=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,s+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,s+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,s+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,s+=t.normal.z*this.min.z),e<=-t.constant&&s>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(Pt),zt.subVectors(this.max,Pt),vt.subVectors(t.a,Pt),St.subVectors(t.b,Pt),_t.subVectors(t.c,Pt),Ct.subVectors(St,vt),Tt.subVectors(_t,St),Dt.subVectors(vt,_t);let e=[0,-Ct.z,Ct.y,0,-Tt.z,Tt.y,0,-Dt.z,Dt.y,Ct.z,0,-Ct.x,Tt.z,0,-Tt.x,Dt.z,0,-Dt.x,-Ct.y,Ct.x,0,-Tt.y,Tt.x,0,-Dt.y,Dt.x,0];return!!It(e,vt,St,_t,zt)&&(e=[1,0,0,0,1,0,0,0,1],!!It(e,vt,St,_t,zt)&&(Et.crossVectors(Ct,Tt),e=[Et.x,Et.y,Et.z],It(e,vt,St,_t,zt)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,bt).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=.5*this.getSize(bt).length()),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(yt[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),yt[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),yt[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),yt[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),yt[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),yt[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),yt[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),yt[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(yt)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const yt=[new J,new J,new J,new J,new J,new J,new J,new J],bt=new J,wt=new Mt,vt=new J,St=new J,_t=new J,Ct=new J,Tt=new J,Dt=new J,Pt=new J,zt=new J,Et=new J,At=new J;function It(t,e,s,i,a){for(let r=0,n=t.length-3;r<=n;r+=3){At.fromArray(t,r);const n=a.x*Math.abs(At.x)+a.y*Math.abs(At.y)+a.z*Math.abs(At.z),h=e.dot(At),o=s.dot(At),l=i.dot(At);if(Math.max(-Math.max(h,o,l),Math.min(h,o,l))>n)return!1}return!0}class Ft{#m=!1;#p=0;#x;#l;#c;constructor(t,e){this.#l=t,this.#c=e,this.#x=new ct("GPU",t,e)}#g(t,e){return`${t}_${e}`}pushMesh(t,e,s,i){if(this.#m)return!1;let a=this.#g(t,e);return this.#x.add(a,s,i)}flushMesh(t,e,s,i){if(this.#m)return!1;let a=this.#g(t,e);return this.#x.flush(a,s,i)}queryMesh(t,e,s=!0){if(this.#m)return null;let i=this.#g(t,e);return this.#x.get(i,s)}hasMesh(t,e){if(this.#m)return!1;let s=this.#g(t,e);return!!this.#x.get(s,!1)}clear(t,e){if(this.#m)return!1;Array.isArray(e)?e.forEach((e=>{let s=this.#g(t,e);this.#x.remove(s)})):console.warn("nodeIDs must be Array !!!")}dispose(){this.#m=!0,this.#x.dispose()}update(t){this.#m||this.#x.freeMemory()}test(){console.log("gpu lru info: "+this.#x.toString())}}class Rt{static GlobalID=0;renderID;#P;cpuCache;gpuCache;#y=32;#b=64;isUnit=!0;#z;#E;#A;#I;#o;#F;#R;#k;#N;#L;#B;#H;#q=0;#O=0;nodes=[];id;sequence;#U;#V;get x(){return this.#L}get y(){return this.#B}get center(){return this.#H}get totalPoints(){return this.#E}get startAddr(){return this.#A}get endAddr(){return this.#I}get totalSize(){return this.#o}get shStartAddr(){return this.#F}get shEndAddr(){return this.#R}get shTotalSize(){return this.#k}get distanceToCameraSq(){return this.#q}get distance2dToCameraSq(){return this.#O}updateDistanceToCamera(t){this.#q=this.#H.distanceToSquared(t);const e=this.#U.set(t.x,t.y),s=this.#V.set(this.#H.x,this.#H.y);this.#O=e.distanceToSquared(s)}getBBox(){return this.#N}searchNearestNode(t,e){null==e&&(e=this.nodes.length);for(let s=t;s<e;++s)if(this.nodes[s])return this.nodes[s];return null}searchNearestNodeInverse(t,e=-1){for(let s=t;s>e;--s)if(this.nodes[s])return this.nodes[s];return null}getNodeByLevel(t){return t>=this.nodes.length||t<0?null:this.nodes[t]}constructor(t,e,s,i,a){this.renderID=t,this.#P=e,this.cpuCache=e.cpuCache,this.gpuCache=e.gpuCache,this.#U=new gt,this.#V=new gt,this.id=Rt.GlobalID++,this.#z=s,this.#L=s.x,this.#B=s.y,this.#N=new Mt(i,a),this.#H=new J,this.#N.getCenter(this.#H),this.#E=0,this.#o=0,this.#A=BigInt(-1);for(let t=0;t<s.lods.length;t++){let e=s.lods[t];if(0==e.points){this.nodes[t]=null;continue}this.#A<0&&(this.#A=e.offset);let i=new ft(e,t);i.parent=this,this.nodes[t]=i,this.#E+=e.points,this.#o+=e.size}this.#I=this.#A+BigInt(this.#o),this.#k=this.#E*this.#b,this.#F=BigInt(Number(this.#A)/this.#y*this.#b),this.#R=this.#F+BigInt(this.#k)}dispose(){this.nodes.forEach((t=>{t&&(t.parent=null,t.dispose())})),this.nodes=[],this.cpuCache=null,this.gpuCache=null,this.#P=null}}class kt{isUnitChunk=!0;renderID;#j=[];#A=0n;#I=0n;#o=0;#F=0n;#R=0n;#k=0;#E=0;#q=0;#O=0;get startAddr(){return this.#A}get endAddr(){return this.#I}get totalSize(){return this.#o}get shStartAddr(){return this.#F}get shEndAddr(){return this.#R}get shTotalSize(){return this.#k}get totalPoints(){return this.#E}get distanceToCameraSq(){return this.#q}get distance2dToCameraSq(){return this.#O}get allUnits(){return this.#j}setDownloading(t,e){this.#j.forEach((s=>{const i=s.nodes;for(let s=0;s<i.length;++s)i[s]&&i[s].setDownloading(t,e)}))}constructor(t,e){if(!e||0==e.length)throw new Error("units is empty (UnitChunk)");this.renderID=t,this.#j=e,this.#A=e[0].startAddr,this.#I=e[e.length-1].endAddr,this.#o=Number(this.#I-this.#A),this.#F=e[0].shStartAddr,this.#R=e[e.length-1].shEndAddr,this.#k=Number(this.#R-this.#F),this.#q=e[0].distanceToCameraSq,this.#O=e[0].distance2dToCameraSq,e.forEach((t=>{this.#E+=t.totalPoints,this.#q=Math.min(this.#q,t.distanceToCameraSq),this.#O=Math.min(this.#O,t.distance2dToCameraSq)}))}}const Nt=function(t,e="application/javascript"){const s=`onmessage=${String(t)}`,i=URL.createObjectURL(new Blob([s],{type:e}));return new Worker(i)},Lt=function(t){return new Worker(URL.createObjectURL(new Blob(["(",t.toString(),")(self)"],{type:"application/javascript"})))};class Bt{constructor(){}dispose(){throw new Error("Must be implemented by subclass")}update(t){throw new Error("Must be implemented by subclass")}decompress(t,e,s,i){throw new Error("Must be implemented by subclass")}}class Ht{renderID;url;chunk;type;cpuCache;decompressor;header;offset;size;meta;constructor(t,s,i,a,r,n,h,o){this.renderID=t,this.url=s,this.chunk=i,this.type=a,this.header=r,this.cpuCache=n,this.decompressor=h,this.meta=o,this.chunk.isNode?(this.offset=a===e?this.chunk.offset:this.chunk.shOffset,this.size=a===e?this.chunk.size:this.chunk.shSize):(this.offset=a===e?this.chunk.startAddr:this.chunk.shStartAddr,this.size=a===e?this.chunk.totalSize:this.chunk.shTotalSize)}setPending(){this.chunk.setDownloading(this.type,!0)}setDone(){this.chunk.setDownloading(this.type,!1)}requestData(){return new Promise(((t,e)=>{(function(t,e,s,i={}){return new Promise(((a,r)=>{if("bigint"==typeof e&&(e=Number(e)),("number"==typeof e||"bigint"==typeof e)&&"number"==typeof s){const t=`bytes=${e}-${e+s-1}`;i.Range=t}const n=new Request(`${t}?${Math.random()}`,{headers:i});try{fetch(n).then((t=>{try{if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);t.arrayBuffer().then((t=>{a(t)}))}catch(t){console.error(t),r(t)}})).catch((()=>{r()}))}catch(t){r()}}))})(this.url,this.offset,this.size).then((e=>{t(e)})).catch((()=>{t(void 0)}))}))}processPayload(t,s){if(!t)return;const i=t.byteLength;if(this.chunk.isNode){const a=new Uint32Array(t);this.type===e?s?(this.chunk.setDecompressing(e,!0),this.decompressor.decompress(this.type,t,this.size,this.meta,((t,s,i)=>{this.chunk.setDecompressing(e,!1),this.cpuCache.pushData(this.renderID,this.chunk.id,t,this.size,s)}))):this.cpuCache.pushData(this.renderID,this.chunk.id,a,this.size):this.cpuCache.pushSH(this.renderID,this.chunk.id,a,this.size),this.size!=i&&console.warn("wrong data: ",this.chunk,this.size,i)}else{const a=this.type===e?this.chunk.startAddr:this.chunk.shStartAddr,r=this.chunk.allUnits;let n=0;r.forEach((i=>{const r=i.nodes;r&&r.forEach((i=>{if(i&&i.points>0){const r=i.id,h=this.type===e?i.offset:i.shOffset,o=this.type===e?i.size:i.shSize,l=Number(h-a),c=new Uint32Array(t,l,o/4);if(this.type===e)if(s){const t=new Uint32Array(o/4);for(let e=0;e<t.length;++e)t[e]=c[e];i.setDecompressing(e,!0),this.decompressor.decompress(this.type,t.buffer,o,this.meta,((t,s,a)=>{i.setDecompressing(e,!1),this.cpuCache.pushData(this.renderID,r,t,o,s)}))}else this.cpuCache.pushData(this.renderID,r,c,o);else this.cpuCache.pushSH(this.renderID,r,c,o);n+=o}}))})),i!=n&&console.warn("wrong data2: ",this.chunk,n,i)}}}class qt{#m=!1;#G=5;#W;#Q;#X=!0;#Z=!0;#Y=Object.create(null);#K=new pt;#J=new pt;#_=!1;#C=!1;#$=!1;isDownloadCompleted=!1;constructor(t,e,s=!0,i=!0){this.#W=t,this.#Q=e,this.#X=s,this.#Z=i}setRenderInfoMeta(t,e){this.#Y[t].meta=e}#tt(t){let e,s,i,a=new URL(t);const r=[];a.pathname.split("/").forEach((t=>{t.endsWith(".lcc")?s=t.substring(0,t.length-4):t.endsWith(".splat")?s=t.substring(0,t.length-6):r.push(t)})),e=`${a.origin}${r.join("/")}`,e=e.replace(/\/$/,"");const n=new URLSearchParams(a.search).toString().match(/(?:token)=([^&]*)/i);return n&&(i=n[1]),{rootPath:e,metaName:s,token:i}}init(t,e){let{rootPath:s,metaName:i,metaExtName:a,token:r}=this.#tt(e),n=s+"/meta.lcc",h=s+"/meta.splat",o={};r&&(o={Authorization:r}),i&&(n=s+"/"+i+".lcc",h=s+"/"+i+".splat"),this.#Y[t]={url:s,header:o,metaUrl:n,metaUrl2:h,indexUrl:s+"/index.bin",environmentUrl:s+"/environment.bin",dataUrl:s+"/data.bin",shUrl:s+"/shcoef.bin",meta:{}}}dispose(){this.#m=!0,this.#Y={},this.#W=null,this.#Q=null,this.#K.traverse((t=>{t.dispose()})),this.#J.traverse((t=>{t.dispose()})),this.#K=new pt,this.#J=new pt}checkNetworkIdle(){return!(this.#_||this.#C||this.#K.length>0||this.#J.length>0)}async#et(t,e){e?this.#C=!0:this.#_=!0;const s=[],i=[],a=t.length;for(let e=0;e<this.#G&&e<a;++e){let e=t.dequeue();i.push(e),s.push(e.requestData())}const r=()=>{this.#m||(e?this.#C=!1:this.#_=!1,i.forEach((t=>{t.setDone()})))};try{const t=await Promise.all(s);if(t&&!this.#m){this.#$=!0;for(let e=0;e<i.length;++e)i[e]?.processPayload(t[e],this.#X)}r()}catch(t){console.error(t),r()}}#st(t,e){e?this.#C=!0:this.#_=!0;const s=[],i=[];for(let e=0;e<400&&0!==t.length;e++){let a=t.dequeue();s.push(a),i.push({index:e,path:a.url,offset:a.offset,size:a.size,headers:a.headers})}const a=()=>{this.#m||(e?this.#C=!1:this.#_=!1,s.forEach((t=>{t.setDone()})))},r=Nt(xt);r.addEventListener("message",(t=>{if(this.#m)return;const e=t.data.payloads,i=t.data.data,n=t.data.isFinished;if(i){this.#$=!0;for(let t=0;t<e.length;++t){const a=e[t],r=i[t];s[a.index]?.processPayload(r,this.#X)}}n&&(r.terminate(),a())})),r.postMessage(i)}#it(){!this.#_&&this.#K.length>0&&(this.#Z?this.#st(this.#K,!1):this.#et(this.#K,!1)),!this.#C&&this.#J.length>0&&(this.#Z?this.#st(this.#J,!0):this.#et(this.#J,!0))}load(t,s,i=e){const a=this.#Y[t].header,r=i===e?this.#Y[t].dataUrl:this.#Y[t].shUrl,n=this.#Y[t].meta;for(let h=0;h<s.length;++h){const o=new Ht(t,r,s[h],i,a,this.#W,this.#Q,n);o.setPending(),i===e?this.#K.enqueue(o):this.#J.enqueue(o)}this.#it()}update(t){this.#m||(this.#$?(this.#$=!1,this.isDownloadCompleted=!0):this.isDownloadCompleted=!1,this.#it())}loadMetaIndex(t,e,s){this.#at(t,(i=>{this.#rt(t,(s=>{if(e){e(i,s);const a=this.#Y[t].meta.hasSH;this.#nt(t,(e=>{this.#ht(t,e,a)}),(()=>{console.log("load env failed...")}))}}),(()=>{s&&s()}))}),(()=>{s&&s()}))}#at(t,e,s){const i=this.#Y[t].metaUrl,a=this.#Y[t].metaUrl2,r=this.#Y[t].header;dt(i,r).then((t=>{e(t)})).catch((t=>{dt(a,r).then((t=>{e(t)})).catch((t=>{console.error("get meta failed",t),s()}))}))}#rt(t,e,s){mt(this.#Y[t].indexUrl,this.#Y[t].header).then((t=>{e(t)})).catch((t=>{console.error("get index failed",t),s()}))}#nt(t,e,s){mt(this.#Y[t].environmentUrl,this.#Y[t].header).then((t=>{e(t)})).catch((t=>{console.error("get env failed"),s()}))}#ht(t,s,a){if(a){const e=96,a=s.byteLength/e;this.#Q.decompress(i,s,s.byteLength,this.#Y[t]?.meta,((e,s,i)=>{this.#m||this.#W.pushEnv(t,a,e,i,s)}))}else{const i=32,a=s.byteLength/i;this.#Q.decompress(e,s,s.byteLength,this.#Y[t]?.meta,((e,s,i)=>{this.#m||this.#W.pushEnv(t,a,e,i,s)}))}}}class Ot{constructor(){}dispose(){throw new Error("Must be implemented by subclass")}update(){throw new Error("Must be implemented by subclass")}createRenderer(){throw new Error("Must be implemented by subclass")}destroyRenderer(t){throw new Error("Must be implemented by subclass")}getAllRenderers(){throw new Error("Must be implemented by subclass")}raycast(t){throw new Error("Must be implemented by subclass")}raycastFromOrigin(t){throw new Error("Must be implemented by subclass")}}const Ut=2e3,Vt=2001;class jt{constructor(t,e,s,i,a,r,n,h,o,l,c,u,d,m,p,x){jt.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,s,i,a,r,n,h,o,l,c,u,d,m,p,x)}set(t,e,s,i,a,r,n,h,o,l,c,u,d,m,p,x){const f=this.elements;return f[0]=t,f[4]=e,f[8]=s,f[12]=i,f[1]=a,f[5]=r,f[9]=n,f[13]=h,f[2]=o,f[6]=l,f[10]=c,f[14]=u,f[3]=d,f[7]=m,f[11]=p,f[15]=x,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new jt).fromArray(this.elements)}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],e[9]=s[9],e[10]=s[10],e[11]=s[11],e[12]=s[12],e[13]=s[13],e[14]=s[14],e[15]=s[15],this}copyPosition(t){const e=this.elements,s=t.elements;return e[12]=s[12],e[13]=s[13],e[14]=s[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,s){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),s.setFromMatrixColumn(this,2),this}makeBasis(t,e,s){return this.set(t.x,e.x,s.x,0,t.y,e.y,s.y,0,t.z,e.z,s.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,s=t.elements,i=1/Gt.setFromMatrixColumn(t,0).length(),a=1/Gt.setFromMatrixColumn(t,1).length(),r=1/Gt.setFromMatrixColumn(t,2).length();return e[0]=s[0]*i,e[1]=s[1]*i,e[2]=s[2]*i,e[3]=0,e[4]=s[4]*a,e[5]=s[5]*a,e[6]=s[6]*a,e[7]=0,e[8]=s[8]*r,e[9]=s[9]*r,e[10]=s[10]*r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,s=t.x,i=t.y,a=t.z,r=Math.cos(s),n=Math.sin(s),h=Math.cos(i),o=Math.sin(i),l=Math.cos(a),c=Math.sin(a);if("XYZ"===t.order){const t=r*l,s=r*c,i=n*l,a=n*c;e[0]=h*l,e[4]=-h*c,e[8]=o,e[1]=s+i*o,e[5]=t-a*o,e[9]=-n*h,e[2]=a-t*o,e[6]=i+s*o,e[10]=r*h}else if("YXZ"===t.order){const t=h*l,s=h*c,i=o*l,a=o*c;e[0]=t+a*n,e[4]=i*n-s,e[8]=r*o,e[1]=r*c,e[5]=r*l,e[9]=-n,e[2]=s*n-i,e[6]=a+t*n,e[10]=r*h}else if("ZXY"===t.order){const t=h*l,s=h*c,i=o*l,a=o*c;e[0]=t-a*n,e[4]=-r*c,e[8]=i+s*n,e[1]=s+i*n,e[5]=r*l,e[9]=a-t*n,e[2]=-r*o,e[6]=n,e[10]=r*h}else if("ZYX"===t.order){const t=r*l,s=r*c,i=n*l,a=n*c;e[0]=h*l,e[4]=i*o-s,e[8]=t*o+a,e[1]=h*c,e[5]=a*o+t,e[9]=s*o-i,e[2]=-o,e[6]=n*h,e[10]=r*h}else if("YZX"===t.order){const t=r*h,s=r*o,i=n*h,a=n*o;e[0]=h*l,e[4]=a-t*c,e[8]=i*c+s,e[1]=c,e[5]=r*l,e[9]=-n*l,e[2]=-o*l,e[6]=s*c+i,e[10]=t-a*c}else if("XZY"===t.order){const t=r*h,s=r*o,i=n*h,a=n*o;e[0]=h*l,e[4]=-c,e[8]=o*l,e[1]=t*c+a,e[5]=r*l,e[9]=s*c-i,e[2]=i*c-s,e[6]=n*l,e[10]=a*c+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(Qt,t,Xt)}lookAt(t,e,s){const i=this.elements;return Kt.subVectors(t,e),0===Kt.lengthSq()&&(Kt.z=1),Kt.normalize(),Zt.crossVectors(s,Kt),0===Zt.lengthSq()&&(1===Math.abs(s.z)?Kt.x+=1e-4:Kt.z+=1e-4,Kt.normalize(),Zt.crossVectors(s,Kt)),Zt.normalize(),Yt.crossVectors(Kt,Zt),i[0]=Zt.x,i[4]=Yt.x,i[8]=Kt.x,i[1]=Zt.y,i[5]=Yt.y,i[9]=Kt.y,i[2]=Zt.z,i[6]=Yt.z,i[10]=Kt.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,a=this.elements,r=s[0],n=s[4],h=s[8],o=s[12],l=s[1],c=s[5],u=s[9],d=s[13],m=s[2],p=s[6],x=s[10],f=s[14],g=s[3],M=s[7],y=s[11],b=s[15],w=i[0],v=i[4],S=i[8],_=i[12],C=i[1],T=i[5],D=i[9],P=i[13],z=i[2],E=i[6],A=i[10],I=i[14],F=i[3],R=i[7],k=i[11],N=i[15];return a[0]=r*w+n*C+h*z+o*F,a[4]=r*v+n*T+h*E+o*R,a[8]=r*S+n*D+h*A+o*k,a[12]=r*_+n*P+h*I+o*N,a[1]=l*w+c*C+u*z+d*F,a[5]=l*v+c*T+u*E+d*R,a[9]=l*S+c*D+u*A+d*k,a[13]=l*_+c*P+u*I+d*N,a[2]=m*w+p*C+x*z+f*F,a[6]=m*v+p*T+x*E+f*R,a[10]=m*S+p*D+x*A+f*k,a[14]=m*_+p*P+x*I+f*N,a[3]=g*w+M*C+y*z+b*F,a[7]=g*v+M*T+y*E+b*R,a[11]=g*S+M*D+y*A+b*k,a[15]=g*_+M*P+y*I+b*N,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[4],i=t[8],a=t[12],r=t[1],n=t[5],h=t[9],o=t[13],l=t[2],c=t[6],u=t[10],d=t[14];return t[3]*(+a*h*c-i*o*c-a*n*u+s*o*u+i*n*d-s*h*d)+t[7]*(+e*h*d-e*o*u+a*r*u-i*r*d+i*o*l-a*h*l)+t[11]*(+e*o*c-e*n*d-a*r*c+s*r*d+a*n*l-s*o*l)+t[15]*(-i*n*l-e*h*c+e*n*u+i*r*c-s*r*u+s*h*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,s){const i=this.elements;return t.isVector3?(i[12]=t.x,i[13]=t.y,i[14]=t.z):(i[12]=t,i[13]=e,i[14]=s),this}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],a=t[3],r=t[4],n=t[5],h=t[6],o=t[7],l=t[8],c=t[9],u=t[10],d=t[11],m=t[12],p=t[13],x=t[14],f=t[15],g=c*x*o-p*u*o+p*h*d-n*x*d-c*h*f+n*u*f,M=m*u*o-l*x*o-m*h*d+r*x*d+l*h*f-r*u*f,y=l*p*o-m*c*o+m*n*d-r*p*d-l*n*f+r*c*f,b=m*c*h-l*p*h-m*n*u+r*p*u+l*n*x-r*c*x,w=e*g+s*M+i*y+a*b;if(0===w)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const v=1/w;return t[0]=g*v,t[1]=(p*u*a-c*x*a-p*i*d+s*x*d+c*i*f-s*u*f)*v,t[2]=(n*x*a-p*h*a+p*i*o-s*x*o-n*i*f+s*h*f)*v,t[3]=(c*h*a-n*u*a-c*i*o+s*u*o+n*i*d-s*h*d)*v,t[4]=M*v,t[5]=(l*x*a-m*u*a+m*i*d-e*x*d-l*i*f+e*u*f)*v,t[6]=(m*h*a-r*x*a-m*i*o+e*x*o+r*i*f-e*h*f)*v,t[7]=(r*u*a-l*h*a+l*i*o-e*u*o-r*i*d+e*h*d)*v,t[8]=y*v,t[9]=(m*c*a-l*p*a-m*s*d+e*p*d+l*s*f-e*c*f)*v,t[10]=(r*p*a-m*n*a+m*s*o-e*p*o-r*s*f+e*n*f)*v,t[11]=(l*n*a-r*c*a-l*s*o+e*c*o+r*s*d-e*n*d)*v,t[12]=b*v,t[13]=(l*p*i-m*c*i+m*s*u-e*p*u-l*s*x+e*c*x)*v,t[14]=(m*n*i-r*p*i-m*s*h+e*p*h+r*s*x-e*n*x)*v,t[15]=(r*c*i-l*n*i+l*s*h-e*c*h-r*s*u+e*n*u)*v,this}scale(t){const e=this.elements,s=t.x,i=t.y,a=t.z;return e[0]*=s,e[4]*=i,e[8]*=a,e[1]*=s,e[5]*=i,e[9]*=a,e[2]*=s,e[6]*=i,e[10]*=a,e[3]*=s,e[7]*=i,e[11]*=a,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],i=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,s,i))}makeTranslation(t,e,s){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,s,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),s=Math.sin(t);return this.set(1,0,0,0,0,e,-s,0,0,s,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,0,s,0,0,1,0,0,-s,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,0,s,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const s=Math.cos(e),i=Math.sin(e),a=1-s,r=t.x,n=t.y,h=t.z,o=a*r,l=a*n;return this.set(o*r+s,o*n-i*h,o*h+i*n,0,o*n+i*h,l*n+s,l*h-i*r,0,o*h-i*n,l*h+i*r,a*h*h+s,0,0,0,0,1),this}makeScale(t,e,s){return this.set(t,0,0,0,0,e,0,0,0,0,s,0,0,0,0,1),this}makeShear(t,e,s,i,a,r){return this.set(1,s,a,0,t,1,r,0,e,i,1,0,0,0,0,1),this}compose(t,e,s){const i=this.elements,a=e._x,r=e._y,n=e._z,h=e._w,o=a+a,l=r+r,c=n+n,u=a*o,d=a*l,m=a*c,p=r*l,x=r*c,f=n*c,g=h*o,M=h*l,y=h*c,b=s.x,w=s.y,v=s.z;return i[0]=(1-(p+f))*b,i[1]=(d+y)*b,i[2]=(m-M)*b,i[3]=0,i[4]=(d-y)*w,i[5]=(1-(u+f))*w,i[6]=(x+g)*w,i[7]=0,i[8]=(m+M)*v,i[9]=(x-g)*v,i[10]=(1-(u+p))*v,i[11]=0,i[12]=t.x,i[13]=t.y,i[14]=t.z,i[15]=1,this}decompose(t,e,s){const i=this.elements;let a=Gt.set(i[0],i[1],i[2]).length();const r=Gt.set(i[4],i[5],i[6]).length(),n=Gt.set(i[8],i[9],i[10]).length();this.determinant()<0&&(a=-a),t.x=i[12],t.y=i[13],t.z=i[14],Wt.copy(this);const h=1/a,o=1/r,l=1/n;return Wt.elements[0]*=h,Wt.elements[1]*=h,Wt.elements[2]*=h,Wt.elements[4]*=o,Wt.elements[5]*=o,Wt.elements[6]*=o,Wt.elements[8]*=l,Wt.elements[9]*=l,Wt.elements[10]*=l,e.setFromRotationMatrix(Wt),s.x=a,s.y=r,s.z=n,this}makePerspective(t,e,s,i,a,r,n=2e3){const h=this.elements,o=2*a/(e-t),l=2*a/(s-i),c=(e+t)/(e-t),u=(s+i)/(s-i);let d,m;if(n===Ut)d=-(r+a)/(r-a),m=-2*r*a/(r-a);else{if(n!==Vt)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+n);d=-r/(r-a),m=-r*a/(r-a)}return h[0]=o,h[4]=0,h[8]=c,h[12]=0,h[1]=0,h[5]=l,h[9]=u,h[13]=0,h[2]=0,h[6]=0,h[10]=d,h[14]=m,h[3]=0,h[7]=0,h[11]=-1,h[15]=0,this}makeOrthographic(t,e,s,i,a,r,n=2e3){const h=this.elements,o=1/(e-t),l=1/(s-i),c=1/(r-a),u=(e+t)*o,d=(s+i)*l;let m,p;if(n===Ut)m=(r+a)*c,p=-2*c;else{if(n!==Vt)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+n);m=a*c,p=-1*c}return h[0]=2*o,h[4]=0,h[8]=0,h[12]=-u,h[1]=0,h[5]=2*l,h[9]=0,h[13]=-d,h[2]=0,h[6]=0,h[10]=p,h[14]=-m,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<16;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e=0){for(let s=0;s<16;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t[e+9]=s[9],t[e+10]=s[10],t[e+11]=s[11],t[e+12]=s[12],t[e+13]=s[13],t[e+14]=s[14],t[e+15]=s[15],t}fromCesiumMatrix4(t){return t&&this.fromArray(t),this}toCesiumMatrix4(t){if(t){const e=this.elements.length;for(let s=0;s<e;s++)t[s]=this.elements[s]}return t}}const Gt=new J,Wt=new jt,Qt=new J(0,0,0),Xt=new J(1,1,1),Zt=new J,Yt=new J,Kt=new J;class Jt{get isCameraChanged(){throw new Error("Must be implemented by subclass")}get fov(){throw new Error("Must be implemented by subclass")}get position(){throw new Error("Must be implemented by subclass")}get projectionMatrix(){throw new Error("Must be implemented by subclass")}get cam2WorldMatrix(){throw new Error("Must be implemented by subclass")}update(t){throw new Error("Must be implemented by subclass")}dispose(){throw new Error("Must be implemented by subclass")}}let $t=class extends Jt{#ot;#lt;#ct;#ut;#dt;#mt;#pt;#xt=!1;constructor(t){super(),this.#ot=t.camera,this.#lt=t.canvas,this.#ct=this.#ot.fov,this.#ut=this.#lt.width,this.#dt=this.#lt.height,this.#mt=this.#ot.position.clone(),this.#pt=this.#ot.quaternion.clone()}get isCameraChanged(){return this.#xt}get fov(){return this.#ot.fov}get position(){return this.#ot.position.clone()}get projectionMatrix(){return this.#ot.projectionMatrix}get cam2WorldMatrix(){return this.#ot.matrixWorld}update(t){this.#ot.updateMatrixWorld();let e=this.#ot.position,s=this.#ot.quaternion,i=this.#ot.fov,a=this.#lt.width,r=this.#lt.height;this.#xt=!1,i!=this.#ct&&(this.#ct=i,this.#xt=!0),a==this.#ut&&r==this.#dt||(this.#ut=a,this.#dt=r,this.#xt=!0),e.equals(this.#mt)||(this.#mt.copy(e),this.#xt=!0),s.equals(this.#pt)||(this.#pt.copy(s),this.#xt=!0)}dispose(){}};const te=new Mt,ee=new J,se=new J;class ie{constructor(t=new J,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const s=this.center;void 0!==e?s.copy(e):te.setFromPoints(t).getCenter(s);let i=0;for(let e=0,a=t.length;e<a;e++)i=Math.max(i,s.distanceToSquared(t[e]));return this.radius=Math.sqrt(i),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const s=this.center.distanceToSquared(t);return e.copy(t),s>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;ee.subVectors(t,this.center);const e=ee.lengthSq();if(e>this.radius*this.radius){const t=Math.sqrt(e),s=.5*(t-this.radius);this.center.addScaledVector(ee,s/t),this.radius+=s}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(!0===this.center.equals(t.center)?this.radius=Math.max(this.radius,t.radius):(se.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(ee.copy(t.center).add(se)),this.expandByPoint(ee.copy(t.center).sub(se))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}}class ae{constructor(t,e,s,i,a,r,n,h,o){ae.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,e,s,i,a,r,n,h,o)}set(t,e,s,i,a,r,n,h,o){const l=this.elements;return l[0]=t,l[1]=i,l[2]=n,l[3]=e,l[4]=a,l[5]=h,l[6]=s,l[7]=r,l[8]=o,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,s=t.elements;return e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=s[3],e[4]=s[4],e[5]=s[5],e[6]=s[6],e[7]=s[7],e[8]=s[8],this}extractBasis(t,e,s){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),s.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const s=t.elements,i=e.elements,a=this.elements,r=s[0],n=s[3],h=s[6],o=s[1],l=s[4],c=s[7],u=s[2],d=s[5],m=s[8],p=i[0],x=i[3],f=i[6],g=i[1],M=i[4],y=i[7],b=i[2],w=i[5],v=i[8];return a[0]=r*p+n*g+h*b,a[3]=r*x+n*M+h*w,a[6]=r*f+n*y+h*v,a[1]=o*p+l*g+c*b,a[4]=o*x+l*M+c*w,a[7]=o*f+l*y+c*v,a[2]=u*p+d*g+m*b,a[5]=u*x+d*M+m*w,a[8]=u*f+d*y+m*v,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],s=t[1],i=t[2],a=t[3],r=t[4],n=t[5],h=t[6],o=t[7],l=t[8];return e*r*l-e*n*o-s*a*l+s*n*h+i*a*o-i*r*h}invert(){const t=this.elements,e=t[0],s=t[1],i=t[2],a=t[3],r=t[4],n=t[5],h=t[6],o=t[7],l=t[8],c=l*r-n*o,u=n*h-l*a,d=o*a-r*h,m=e*c+s*u+i*d;if(0===m)return this.set(0,0,0,0,0,0,0,0,0);const p=1/m;return t[0]=c*p,t[1]=(i*o-l*s)*p,t[2]=(n*s-i*r)*p,t[3]=u*p,t[4]=(l*e-i*h)*p,t[5]=(i*a-n*e)*p,t[6]=d*p,t[7]=(s*h-o*e)*p,t[8]=(r*e-s*a)*p,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,s,i,a,r,n){const h=Math.cos(a),o=Math.sin(a);return this.set(s*h,s*o,-s*(h*r+o*n)+r+t,-i*o,i*h,-i*(-o*r+h*n)+n+e,0,0,1),this}scale(t,e){return this.premultiply(re.makeScale(t,e)),this}rotate(t){return this.premultiply(re.makeRotation(-t)),this}translate(t,e){return this.premultiply(re.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),s=Math.sin(t);return this.set(e,-s,0,s,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,s=t.elements;for(let t=0;t<9;t++)if(e[t]!==s[t])return!1;return!0}fromArray(t,e=0){for(let s=0;s<9;s++)this.elements[s]=t[s+e];return this}toArray(t=[],e=0){const s=this.elements;return t[e]=s[0],t[e+1]=s[1],t[e+2]=s[2],t[e+3]=s[3],t[e+4]=s[4],t[e+5]=s[5],t[e+6]=s[6],t[e+7]=s[7],t[e+8]=s[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}const re=new ae,ne=new J,he=new J,oe=new ae;class le{constructor(t=new J(1,0,0),e=0){this.isPlane=!0,this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,s,i){return this.normal.set(t,e,s),this.constant=i,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,s){const i=ne.subVectors(s,e).cross(he.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(i,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(t).addScaledVector(this.normal,-this.distanceToPoint(t))}intersectLine(t,e){const s=t.delta(ne),i=this.normal.dot(s);if(0===i)return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;const a=-(t.start.dot(this.normal)+this.constant)/i;return a<0||a>1?null:e.copy(t.start).addScaledVector(s,a)}intersectsLine(t){const e=this.distanceToPoint(t.start),s=this.distanceToPoint(t.end);return e<0&&s>0||s<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const s=e||oe.getNormalMatrix(t),i=this.coplanarPoint(ne).applyMatrix4(t),a=this.normal.applyMatrix3(s).normalize();return this.constant=-i.dot(a),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const ce=new ie,ue=new J;class de{constructor(t=new le,e=new le,s=new le,i=new le,a=new le,r=new le){this.planes=[t,e,s,i,a,r]}set(t,e,s,i,a,r){const n=this.planes;return n[0].copy(t),n[1].copy(e),n[2].copy(s),n[3].copy(i),n[4].copy(a),n[5].copy(r),this}copy(t){const e=this.planes;for(let s=0;s<6;s++)e[s].copy(t.planes[s]);return this}setFromProjectionMatrix(t,e=2e3){const s=this.planes,i=t.elements,a=i[0],r=i[1],n=i[2],h=i[3],o=i[4],l=i[5],c=i[6],u=i[7],d=i[8],m=i[9],p=i[10],x=i[11],f=i[12],g=i[13],M=i[14],y=i[15];if(s[0].setComponents(h-a,u-o,x-d,y-f).normalize(),s[1].setComponents(h+a,u+o,x+d,y+f).normalize(),s[2].setComponents(h+r,u+l,x+m,y+g).normalize(),s[3].setComponents(h-r,u-l,x-m,y-g).normalize(),s[4].setComponents(h-n,u-c,x-p,y-M).normalize(),e===Ut)s[5].setComponents(h+n,u+c,x+p,y+M).normalize();else{if(e!==Vt)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+e);s[5].setComponents(n,c,p,M).normalize()}return this}intersectsObject(t){if(void 0!==t.boundingSphere)null===t.boundingSphere&&t.computeBoundingSphere(),ce.copy(t.boundingSphere).applyMatrix4(t.matrixWorld);else{const e=t.geometry;null===e.boundingSphere&&e.computeBoundingSphere(),ce.copy(e.boundingSphere).applyMatrix4(t.matrixWorld)}return this.intersectsSphere(ce)}intersectsSprite(t){return ce.center.set(0,0,0),ce.radius=.7071067811865476,ce.applyMatrix4(t.matrixWorld),this.intersectsSphere(ce)}intersectsSphere(t){const e=this.planes,s=t.center,i=-t.radius;for(let t=0;t<6;t++){if(e[t].distanceToPoint(s)<i)return!1}return!0}intersectsBox(t){const e=this.planes;for(let s=0;s<6;s++){const i=e[s];if(ue.x=i.normal.x>0?t.max.x:t.min.x,ue.y=i.normal.y>0?t.max.y:t.min.y,ue.z=i.normal.z>0?t.max.z:t.min.z,i.distanceToPoint(ue)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let s=0;s<6;s++)if(e[s].distanceToPoint(t)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}class me{config;lccParam;cpuCache;gpuCache;resources;dataLoader;cameraMgr;platform;meta={};renderID;isRTK=!1;dynamicState={pointsOnly:!1,alpha:1,visible:!0,useEnv:!0,useSH:!1,useCustomColor:!0,viewport:{x:0,y:0},focal:0,frustum:new de,cmrPos:new J(0,0,0),cmrForward:new J(0,0,0),cmrPosLocal:new J(0,0,0),cmrPosModelLocal:new J(0,0,0),cmrProjMatrix:new jt,cmr2LocalMatrix:new jt,cmr2ModelLocalMatrix:new jt,clipPlane:new L(0,0,0,0),clipBoxMatrixInv:new jt,clipBoxSide:1,tick:0};performance={meshNum:0,totalPoints:0,maxPoints:0,minPoints:0,fps:0,drawcall:0};dispose(){}}class pe{#ft=[];#gt=0;constructor(t){t&&(this.#ft=t)}get length(){return this.#ft.length-this.#gt}isEmpty(){return this.#gt>=this.#ft.length}read(){if(this.isEmpty())return null;let t=this.#ft[this.#gt];return this.#gt+=1,t}}class xe{#Mt=!0;#yt;#P;#bt;#W;#wt=null;#vt;#St=[];#_t;#N;#Ct;#H;#Tt={x:0,y:0};#j=[];#Dt=[];#Pt=[];#zt=!1;#Et;#At=0;#It=!1;#Ft=!1;#Rt=void 0;#kt=void 0;#Nt=void 0;#Lt=void 0;#Bt=void 0;#Ht=void 0;#qt=void 0;#Ot=[];#Ut=[];#Vt=[];#jt=new pe;#Gt=0;#Wt=0;#Qt=0;#Xt=0;#Zt=!1;#Yt=!1;#U;#V;#Kt;#Jt;constructor(t,e,s){this.#U=new gt,this.#V=new gt,this.#Kt=new J,this.#Jt=new J,this.#P=t,this.#yt=this.#P.config,this.#W=this.#P.cpuCache,this.#bt=e,this.#wt=s,this.#Et=this.#P.renderID}get#$t(){return this.#_t.totalLevel}get#te(){return 0}get#ee(){return this.#_t.totalLevel-1}get#se(){return this.#_t.cellLengthX}get#ie(){return this.#_t.cellLengthY}get#ae(){return this.#_t.min}get#re(){return this.#_t.max}get#ne(){return this.#_t.splats?this.#_t.splats[0]:-1}get meta(){return this.#_t}get center(){return this.#H}get bbox(){return this.#N}get bboxWithEnv(){return this.#Ct}get hasSH(){return this.#_t.hasSH}getAllNodeID(t){this.#j.forEach((e=>{e.nodes.forEach((e=>{e&&t.push(e.id)}))}))}getRenderNodes(){return this.#Pt}getLoadingNodes(){return this.#Ot}getLoadingAroundNodes(){return this.#Ut}#he(t,e){return this.#Dt[t]&&this.#Dt[t][e]?this.#Dt[t][e]:null}#oe(t){let e=Math.floor((t.x-this.#ae.x)/this.#se),s=Math.floor((t.y-this.#ae.y)/this.#ie);return new gt(e,s)}#le(t){if(this.#zt)return 0;let e=t.distance2dToCameraSq;const s=this.#se/2,i=this.#yt.MaxLodDistance*this.#yt.MaxLodDistance,a=this.#yt.LodStepDistance*this.#yt.LodStepDistance,r=Math.min(this.#ee,this.#yt.MinLodUsed),n=this.#ee;e<s*s&&(e=0);let h=n;return e<i&&(h=Math.round(e/a)),h=Z.clamp(h,r,n),h}#ce(t,s=e){let i=[];return t.forEach((t=>{t&&(t.isDownloadingOrDecompressing(s)||t.isCache(s)||i.push(t))})),i}#ue(t){let e=[],s=0;if(t.forEach((t=>{const i=this.#le(t);let a=t.searchNearestNode(i);if(!this.#zt)for(;a&&a.points>this.#yt.LodLevelUpSpatsInNode;)a=t.searchNearestNode(a.level+1);!a||a.points<this.#yt.MinValidSplatsInNode||(e.push(a),s+=a.points)})),this.#zt||s<=this.#yt.maxLoadSplatCount)return e;let i=s-this.#yt.maxLoadSplatCount;for(let t=e.length-1;t>=0;--t){let s=e[t],a=s.parent,r=s.level,n=s.points,h=r;for(let t=r+1;t<=this.#ee;++t){if(!a.nodes[t]||a.nodes[t].points>n)continue;if(h=t,n-a.nodes[t].points>i)break}if(e[t]=a.nodes[h],i-=e[t]?n-e[t].points:n,i<=0)break}let a=[],r=0;for(let t=0;t<e.length;++t){let s=e[t];if(s){if(!this.#zt&&r+s.points>this.#yt.maxLoadSplatCount)break;a.push(s),r+=s.points}}return a}#de(t,e){let s=[];return t.forEach((t=>{const i=t.searchNearestNodeInverse(this.#ee);i&&i.visibleID!=this.#At&&(i.isDownloadingOrDecompressing(e)||i.isCache(e)||s.push(i))})),s}#me(){this.#zt=!1,0<this.#ne&&this.#ne<this.#yt.maxLoadSplatCount&&(this.#zt=!0),1===this.#$t&&1===this.#j.length&&(this.#zt=!0)}#pe(t=!1,i=!1){if(this.#At++,0==this.#Dt.length)return;this.#me();let a=this.#P.dynamicState.cmrPosModelLocal.clone(),r=this.#P.dynamicState.frustum;const n=this.#yt.useSH&&this.hasSH;let h=[],o=[],l=!!(a.z<this.#yt.GloballHeight);this.#j.forEach((t=>{t.totalPoints<this.#yt.MinValidSplatsInUnit||(t.updateDistanceToCamera(a),t.distance2dToCameraSq<1e4&&o.push(t),!this.#zt&&l&&t.distance2dToCameraSq>this.#yt.MaxDistaneLimit*this.#yt.MaxDistaneLimit||r.intersectsBox(t.getBBox())&&h.push(t))})),h.sort(((t,e)=>t.distanceToCameraSq-e.distanceToCameraSq));let c=this.#ue(h);c.forEach((t=>{t.visibleID=this.#At})),this.#Pt=c;let u=this.#ce(c,e),d=[];n&&(d=this.#ce(c,s));let m=this.#de(o,e);m.sort(((t,e)=>t.parent.distanceToCameraSq-e.parent.distanceToCameraSq));let p=u;t&&(this.#Ut=[...m],this.#Ot=[...u,...m],p=this.#Ot);let x=d;if(i&&n){let t=this.#de(o,s);t.sort(((t,e)=>t.parent.distanceToCameraSq-e.parent.distanceToCameraSq)),this.#Vt=[...d,...t],x=this.#Vt}let f=this.#xe(p);if(this.#wt.load(this.#Et,f,e),n){let t=this.#xe(x);this.#wt.load(this.#Et,t,s)}this.#yt.AlwaysDownloadAround&&!t&&(this.#jt=new pe(m))}#fe(){let t;for(;!this.#jt.isEmpty();){const s=this.#jt.read();if(s&&!s.isDownloadingOrDecompressing(e)&&!s.isCache(e)){t=s;break}}t&&this.#wt.load(this.#Et,[t],e)}#xe(t){if(!this.#yt.MergeSplatsReqEnable){let e=[];return t.forEach((t=>{e.push(t)})),e}t.sort(((t,e)=>t.parent.sequence-e.parent.sequence));let e=[],s=0,i=[];for(let a=0;a<t.length;++a){const r=t[a],n=r.parent,h=n.totalPoints;if(i.length>0){(i[i.length-1].parent.endAddr!=n.startAddr||s+h>this.#yt.MergeSplatsReqThreshold)&&(e.push(i),i=[],s=0)}i.push(r),s+=h}0!=i.length&&(e.push(i),i=[]);let a=[];return e.forEach((t=>{if(1==t.length)a.push(t[0]);else if(t.length>1){let e=[];t.forEach((t=>{e.push(t.parent)})),a.push(new kt(this.#Et,e))}})),a.sort(((t,e)=>(t.isNode?t.parent.distanceToCameraSq:t.distanceToCameraSq)-(e.isNode?e.parent.distanceToCameraSq:e.distanceToCameraSq))),a}load(t,e,s,i,a,r=void 0){this.#Mt&&t&&(this.#Mt=!1,this.#Rt=s,this.#kt=i,this.#Nt=a,this.#Lt=r,t=t.replace(/\/$/,""),this.#wt.init(this.#Et,t),this.#wt.loadMetaIndex(this.#Et,((t,s)=>{this.#ge(t),this.#Me(s),this.#j=this.#ye(),this.#me(),this.#zt&&console.log("full rendering: "+this.#ne),this.#It=!0,this.#Zt=!0,this.#Gt=Date.now(),e&&e(this.meta),this.#wt.setRenderInfoMeta(this.#Et,this.meta),this.#pe(!0,!1)}),(()=>{a&&a()})))}loadSH(t,e,s){return this.hasSH?this.#Yt?(console.error("loadSH is busy !!!"),void(s&&s())):(this.#Bt=t,this.#Ht=e,this.#qt=s,this.#Yt=!0,this.#Wt=Date.now(),void this.#pe(!1,!0)):(console.log("no sh data"),e&&e(1),void(t&&t()))}#ye(){let t=[],e=this.#Dt.length;for(let s=0;s<e;s++)if(this.#Dt[s]){let e=this.#Dt[s].length;for(let i=0;i<e;i++)this.#Dt[s][i]&&(this.#Dt[s][i].sequence=t.length,t.push(this.#Dt[s][i]))}return t}setConfigDirty(){this.#Ft=!0}update(t){this.#It&&(this.#Zt&&(this.#be(),this.#we()),this.#Yt&&(this.#ve(),this.#Se()),(this.#bt.isCameraChanged||this.#wt.isDownloadCompleted||this.#Ft)&&this.#pe(),this.#yt.AlwaysDownloadAround&&this.#wt.checkNetworkIdle()&&this.#fe(),this.#Ft=!1)}#be(){const t=this.#Ot.length;let s=0;if(0==t)return console.log("total is 0 !!!"),this.#kt&&this.#kt(1),this.#Rt&&this.#Rt(),void(this.#Zt=!1);this.#Ot.forEach((t=>{this.#Lt?this.#Lt(t)&&s++:t.isCache(e)&&s++}));let i=1*s/t;i>.99&&(i=1),(i-this.#Qt>=.005||1==i)&&(this.#kt&&this.#kt(i),this.#Qt=i),i>=1&&(this.#Rt&&this.#Rt(),this.#Zt=!1)}#ve(){const t=this.#Vt.length;let e=0;if(0==t)return console.log("total-sh is 0 !!!"),this.#Ht&&this.#Ht(1),this.#Bt&&this.#Bt(),void(this.#Yt=!1);this.#Vt.forEach((t=>{t.isCache(s)&&e++}));let i=1*e/t;i>.99&&(i=1),(i-this.#Xt>=.005||1==i)&&(this.#Ht&&this.#Ht(i),this.#Xt=i),i>=1&&(this.#Bt&&this.#Bt(),this.#Yt=!1)}#we(){if(!this.#Zt)return;const t=Date.now();if(t-this.#Gt<3e3)return;this.#Gt=t;let s=[];this.#Ot.forEach((t=>{!t||t.isDownloadingOrDecompressing(e)||t.isCache(e)||s.push(t)})),s.length>0&&(console.log("Recovering downloading data ..."),this.#wt.load(this.#Et,s,e))}#Se(){if(!this.#Yt)return;const t=Date.now();if(t-this.#Wt<3e3)return;this.#Wt=t;let e=[];this.#Vt.forEach((t=>{!t||t.isDownloadingOrDecompressing(s)||t.isCache(s)||e.push(t)})),e.length>0&&(console.log("Recovering downloading sh ..."),this.#wt.load(this.#Et,e,s))}dispose(){for(let t=0;t<this.#j.length;++t)this.#j[t].dispose();this.#Pt=[],this.#j=[],this.#Dt=[],this.#wt=null,this.#W=null,this.#P=null,this.#bt=null}#_e(t){(t.x>this.#Tt.x||t.y>this.#Tt.y)&&(this.#Tt.x=Math.max(t.x,this.#Tt.x),this.#Tt.y=Math.max(t.y,this.#Tt.y)),this.#Dt[t.x]||(this.#Dt[t.x]=[]);let e=this.#ae.clone();e.x+=t.x*this.#se,e.y+=t.y*this.#ie;let s=e.clone();s.x+=this.#se,s.y+=this.#ie,s.z=this.#re.z,this.#Dt[t.x][t.y]=new Rt(this.#Et,this.#P,t,e,s)}#Me(t){let e=0,s=new DataView(t);for(;!(e>s.byteLength-1);){let t={};t.x=s.getInt16(e,!0),e+=2,t.y=s.getInt16(e,!0),e+=2,t.lods=[];for(let i=0;i<this.#$t;i++){let i=s.getInt32(e,!0);e+=4;let a=s.getBigInt64(e,!0);e+=8;let r=s.getInt32(e,!0);e+=4,t.lods.push({points:i,offset:a,size:r})}this.#_e(t)}}#ge(t){t=t.replace(/,[\s\t\r\n]*}/g,"}");let e=JSON.parse(t);e.min=new J(e.boundingBox.min[0],e.boundingBox.min[1],e.boundingBox.min[2]),e.max=new J(e.boundingBox.max[0],e.boundingBox.max[1],e.boundingBox.max[2]);const s={};e.attributes.forEach((t=>{s[t.name]=t}));const i=s.scale.min,a=s.scale.max,r=s.opacity.min,n=s.opacity.max,h=s.shcoef.min,o=s.shcoef.max,l=s.normal.min,c=s.normal.max,u=s.position.min,d=s.position.max,m={compressedScaleMin:new J(i[0],i[1],i[2]),compressedScaleMax:new J(a[0],a[1],a[2]),compressedSHMin:new J(h[0],h[1],h[2]),compressedSHMax:new J(o[0],o[1],o[2]),compressedOpacityMin:r[0],compressedOpacityMax:n[0],compressedNormalMin:new J(l[0],l[1],l[2]),compressedNormalMax:new J(c[0],c[1],c[2]),positionMin:new J(u[0],u[1],u[2]),positionMax:new J(d[0],d[1],d[2])};this.#Ce(s,m),Object.assign(e,{compressInfo:m}),this.#Te(e),this.#_t=e,this.#P.meta.data=this.#_t,this.#N=new Mt(e.min,e.max),this.#H=new J,this.#N.getCenter(this.#H),this.#Ct=new Mt(u,d)}#Ce(t,e){const s=t?.envscale;if(s){const{min:t,max:i}=s;e.compressedEnvScaleMin=new J(t[0],t[1],t[2]),e.compressedEnvScaleMax=new J(i[0],i[1],i[2])}const i=t?.envshcoef;if(s){const{min:t,max:s}=i;e.compressedEnvSHMin=new J(t[0],t[1],t[2]),e.compressedEnvSHMax=new J(s[0],s[1],s[2])}const a=t?.envnormal;if(a){const{min:t,max:s}=a;e.compressedEnvNormalMin=new J(t[0],t[1],t[2]),e.compressedEnvNormalMax=new J(s[0],s[1],s[2])}}#Te(t){t.hasSH=!0;const e=t.fileType;e&&"Portable"===e&&(t.hasSH=!1)}#De(){const t=this.#P.lccParam.renderLib,e=this.#P.lccParam.scene,s=new t.PlaneGeometry(this.#se,this.#ie),i=new t.MeshBasicMaterial({color:65280,transparent:!0,opacity:.3,depthWrite:!1,depthTest:!1,side:t.DoubleSide}),a=new t.Mesh(s,i),r=[16711680,65280,255];for(let t=0;t<this.#j.length;++t){const e=this.#j[t].center,s=r[(this.#j[t].x%r.length+this.#j[t].y%r.length)%r.length],n=a.clone();n.position.set(e.x,e.y,.5),n.material=i.clone(),n.material.color.set(s),this.#St.push(n)}this.#vt=new t.Group,this.#vt.renderOrder=1,e.add(this.#vt)}#Pe(t){this.#vt.clear(),t.forEach((t=>{t&&this.#vt.add(this.#St[t.parent.sequence])}))}}const fe={modelMatrix:"czm_model",projectionMatrix:"czm_projection",modelViewMatrix:"czm_modelView",modelViewProjectionMatrix:"czm_modelViewProjection",position:"position",gl_FragColor:"out_FragColor"},ge={modelMatrix:"modelMatrix",projectionMatrix:"projectionMatrix",modelViewMatrix:"modelViewMatrix",viewMatrix:"viewMatrix",modelViewProjectionMatrix:"modelViewProjectionMatrix",position:"position",gl_FragColor:"gl_FragColor"};function Me(t){const{vertexShaderCommon:e}={vertexShaderCommon:"\n    precision highp int;\n    precision highp float;\n\n    uniform vec2 dimensions;\n    uniform vec2 dataDimensions;\n    uniform vec2 shDimensions;\n    uniform vec2 viewport;\n    uniform vec2 heightRange;\n    uniform float focal;\n    uniform float splatCount;\n\n    uniform mat4 clipBoxMatrixInv;\n    uniform float clipBoxSide;\n    \n    uniform sampler2D customColors;\n\n    uniform vec3 compressedScaleMax;\n    uniform vec3 compressedScaleMin;\n\n    uniform float useIndexHost;\n    uniform float pointsOnly;\n    uniform float useSH;\n    uniform float useCustomColor;\n    uniform vec3 cmrPos;\n    uniform vec3 compressedSHMin;\n    uniform vec3 compressedSHMax;\n    \n    out vec4 vColor;\n    out vec2 vPosition;\n    out vec2 vResolution;\n\n    #ifdef HAS_NOT_ATTRIBUTE_POSITION\n    in vec3 position;\n    uniform sampler2D splatIndexes;\n    uniform sampler2D splatIndexesHost;\n    uniform sampler2D splatData;\n    uniform sampler2D shRawTexture;\n        #ifdef IS_RTK\n            uniform mat3 prj2ECEF;\n        #endif\n    #else\n    uniform isampler2D splatIndexes;\n    uniform isampler2D splatIndexesHost;\n    uniform usampler2D splatData;\n    uniform sampler2D shRawTexture;\n    #endif\n    \n    #ifndef saturate\n    #define saturate( a ) clamp( a, 0.0, 1.0 )\n    #endif\n    \n    vec2 getStrideDataUV(in int stride, in int offset, in uint Index, vec2 dimension) {\n        vec2 samplerUV = vec2(0.0, 0.0);\n        float d = float(Index * uint(stride) + uint(offset)) / dimension.x;\n        samplerUV.y = float(floor(d)) / dimension.y;\n        samplerUV.x = fract(d);\n        return samplerUV;\n    }\n    \n    vec2 getUV(in float idx) {\n        return getStrideDataUV(1, 0, uint(idx), dataDimensions);\n        //return getStrideDataUV(1, 0, uint(gl_InstanceID), dataDimensions);\n    }\n\n    ivec2 getUVivec2(int idx) {\n        ivec2 samplerUV = ivec2(0, 0);\n\n        int x = idx % int(dimensions.x);\n        int y = idx / int(dimensions.x);\n\n        samplerUV.x = int(x);\n        samplerUV.y = int(y);\n        return samplerUV;\n    }\n\n    vec4 decodeColor(uint colorv) {\n        return vec4(float(colorv & 255u) / 255.0, float((colorv >> 8) & 255u) / 255.0, float((colorv >> 16) & 255u) / 255.0, float((colorv >> 24) & 255u) / 255.0);\n    }\n\n    float lerpScales (float min, float max, float s) {\n      return (1.0 - s) * min + s * max;\n    }\n\n    vec3 decodeScale(uint scale, uint rotation) {\n        float sx = float(scale & 65535u) / 65535.0;\n        float sy = float((scale >> 16) & 65535u) / 65535.0;\n        float sz = float(((rotation) & 65535u)) / 65535.0;\n        return vec3(lerpScales(compressedScaleMin.x, compressedScaleMax.x, sx), lerpScales(compressedScaleMin.y, compressedScaleMax.y, sy), lerpScales(compressedScaleMin.z, compressedScaleMax.z, sz));\n    }\n\n    uint comRotation (uint g, uint b) {\n        return ((b & 65535u) << 16 ) | ((g >> 16) & 65535u);\n    }\n    \n    vec4 decodeRotation(uint enc)\n    {\n    \n        vec4 rotation = vec4(\n            float(enc & 1023u) / 1023.0,\n            float((enc >> 10u) & 1023u) / 1023.0,\n            float((enc >> 20u) & 1023u) / 1023.0,\n            float((enc >> 30u) & 3u) / 3.0);\n    \n        uint idx = uint(rotation.w * 3.0);\n        vec4 q;\n        q.xyz = vec3(rotation.xyz) * sqrt(2.0) - (1.0 / sqrt(2.0));\n        q.w = sqrt(1.0 - saturate(dot(q.xyz, q.xyz)));\n        if (idx == 0u) q = q.wxyz;\n        if (idx == 1u) q = q.xwyz;\n        if (idx == 2u) q = q.xywz;\n    \n        return q;\n    }\n    \n    mat3 matrixFromRotationScale(vec4 rot, vec3 scale)\n    {\n        mat3 ms = mat3(\n            scale.x, 0, 0,\n            0, scale.y, 0,\n            0, 0, scale.z\n        );\n    \n        float x = rot.x;\n        float y = rot.y;\n        float z = rot.z;\n        float w = rot.w;\n    \n        mat3 mr = mat3(\n            1.0 - 2.0 * (y*y + z*z),   2.0*(x*y - w*z),   2.0*(x*z + w*y),\n                2.0*(x*y + w*z), 1.0-2.0*(x*x + z*z),   2.0*(y*z - w*x),\n                2.0*(x*z - w*y),   2.0*(y*z + w*x), 1.0-2.0*(x*x + y*y)\n        );\n        mat3 ret = ms * mr;\n        #ifdef IS_RTK         \n            ret = ret * transpose(mat3(prj2ECEF));\n        #endif\n        ret = transpose(ret) * ret;\n    \n\n\n        return ret;\n    }\n\n    float splatVsBox(vec3 pos) {\n        vec3 localPos = (clipBoxMatrixInv * vec4(pos, 1.0)).xyz;\n        vec3 distance = abs(localPos) - vec3(0.5);\n        float outsideDist = length(max(distance, vec3(0.0)));\n        float insideDist = min(max(distance.x, max(distance.y, distance.z)), 0.0);\n        \n        return (outsideDist + insideDist) * clipBoxSide;\n    }\n    "},{vertexShaderMain:s,vertexShaderPoints:i}=function(t){const{modelViewMatrix:e,projectionMatrix:s,viewMatrix:i,modelMatrix:a}=t;return{vertexShaderMain:`\n    ivec2 splatUV = getUVivec2(int(gl_InstanceID % int(splatCount)));\n\n    int idx;\n    if (useIndexHost > 0.5) {\n        #ifdef HAS_NOT_ATTRIBUTE_POSITION\n        idx = floatBitsToInt(texelFetch(splatIndexesHost, splatUV, 0).r);\n        #else\n        idx = texelFetch(splatIndexesHost, splatUV, 0).r;\n        #endif\n    } else {\n        idx = int(texelFetch(splatIndexes, splatUV, 0).y);\n    }\n    \n    int idxNew = idx * 2;\n    int x1 = idxNew % int(dataDimensions.x);\n    int y1 = idxNew / int(dataDimensions.x);\n    int x2 = x1 + 1;\n    int y2 = y1;\n\n    #ifdef HAS_NOT_ATTRIBUTE_POSITION\n        vec4 pixel0 = texelFetch(splatData, ivec2(x1, y1), 0);\n        vec3 sampledTransform = pixel0.xyz;\n        uint color = floatBitsToUint(pixel0.w);\n    #else\n        uvec4 pixel0 = texelFetch(splatData, ivec2(x1, y1), 0);\n        vec3 sampledTransform = uintBitsToFloat(pixel0.xyz);\n        uint color = pixel0.w;\n    #endif\n\n    vec3 splatCenter = sampledTransform.xyz;\n\n    if (splatVsBox(splatCenter) > 0.0) {\n         gl_Position = vec4(0.0, 0.0, 0.0, 0.0);\n         return;\n    }\n\n    vec4 viewCenter =  ${e} * vec4(splatCenter, 1.0);\n    vec4 clipCenter = ${s} * viewCenter;\n    vec3 ndcCenter = clipCenter.xyz / clipCenter.w;\n\n\n    float bounds = 1.2 * clipCenter.w;\n    if (clipCenter.z < -bounds || clipCenter.z > bounds || clipCenter.x < -bounds || clipCenter.x > bounds\n        || clipCenter.y < -bounds || clipCenter.y > bounds) {\n        gl_Position = vec4(0.0, 0.0, ndcCenter.z, 1.0);\n        return;\n    }\n\n    #ifdef HAS_NOT_ATTRIBUTE_POSITION\n        uvec4 pixel1 = floatBitsToUint(texelFetch(splatData, ivec2(x2, y2), 0));\n    #else\n        uvec4 pixel1 = texelFetch(splatData, ivec2(x2, y2), 0);\n    #endif\n\n    uint sampledRotation = comRotation(pixel1.g, pixel1.b);\n    vec3 sampledScale = decodeScale(pixel1.r, pixel1.g);\n    vec4 rotation = decodeRotation(sampledRotation);\n    mat3 cov = matrixFromRotationScale(rotation, sampledScale);\n\n    vec3 cov3D_M11_M12_M13 = vec3(cov[0][0], cov[0][1], cov[0][2]);\n    vec3 cov3D_M22_M23_M33 = vec3(cov[1][1], cov[1][2], cov[2][2]);\n\n    vColor = decodeColor(color);\n    \n    mat3 Vrk = mat3(\n        cov3D_M11_M12_M13.x, cov3D_M11_M12_M13.y, cov3D_M11_M12_M13.z,\n        cov3D_M11_M12_M13.y, cov3D_M22_M23_M33.x, cov3D_M22_M23_M33.y,\n        cov3D_M11_M12_M13.z, cov3D_M22_M23_M33.y, cov3D_M22_M23_M33.z\n    );\n    float s = 1.0 / (viewCenter.z * viewCenter.z);\n    mat3 J = mat3(\n        focal / viewCenter.z, 0., -(focal * viewCenter.x) * s,\n        0., focal / viewCenter.z, -(focal * viewCenter.y) * s,\n        0., 0., 0.\n    );\n    mat3 W = transpose(mat3( ${e}));\n    mat3 T = W * J;\n    mat3 cov2Dm = transpose(T) * Vrk * T;\n    cov2Dm[0][0] += 0.3;\n    cov2Dm[1][1] += 0.3;\n\n    vec3 cov2d = vec3(cov2Dm[0][0], cov2Dm[0][1], cov2Dm[1][1]);\n  \n    float a = cov2d.x;\n    float d = cov2d.z;\n    float b = cov2d.y;\n    float D = a * d - b * b;\n    float trace = a + d;\n    float traceOver2 = 0.5 * trace;\n    float term2 = sqrt(trace * trace / 4.0 - D);\n    float eigenValue1 = traceOver2 + term2;\n    float eigenValue2 = max(traceOver2 - term2, 0.00); // prevent negative eigen value\n\n    float transparentAdjust = step(1.0 / 255.0, vColor.a);\n    eigenValue2 = eigenValue2 * transparentAdjust;\n\n    const float maxSplatSize = 1024.0;\n    vec2 eigenVector1 = normalize(vec2(b, eigenValue1 - a));\n    vec2 eigenVector2 = vec2(eigenVector1.y, -eigenVector1.x);\n\n    vec2 basisVector1 = eigenVector1  * min(sqrt(2.0 * eigenValue1), maxSplatSize);\n    vec2 basisVector2 = eigenVector2  * min(sqrt(2.0 * eigenValue2), maxSplatSize);\n    vPosition = position.xy* 2.0;\n\n    vec2 ndcOffset = vec2(vPosition.x * basisVector1 + vPosition.y * basisVector2) / viewport * 2.0;\n    gl_Position = vec4(ndcCenter.xy + ndcOffset, ndcCenter.z, 1.0) * clipCenter.w;\n`,vertexShaderPoints:`\n    ivec2 splatUV = getUVivec2(int(gl_InstanceID % int(splatCount)));\n\n    int idx;\n    if (useIndexHost > 0.5) {\n        #ifdef HAS_NOT_ATTRIBUTE_POSITION\n        idx = floatBitsToInt(texelFetch(splatIndexesHost, splatUV, 0).r);\n        #else\n        idx = texelFetch(splatIndexesHost, splatUV, 0).r;\n        #endif\n    } else {\n        idx = int(texelFetch(splatIndexes, splatUV, 0).y);\n    }\n    \n    int idxNew = idx * 2;\n    int x1 = idxNew % int(dataDimensions.x);\n    int y1 = idxNew / int(dataDimensions.x);\n\n#ifdef HAS_NOT_ATTRIBUTE_POSITION\n    vec4 pixel0 = texelFetch(splatData, ivec2(x1, y1), 0);\n    vec3 sampledTransform = pixel0.xyz;\n    uint color = floatBitsToUint(pixel0.w);\n#else\n    uvec4 pixel0 = texelFetch(splatData, ivec2(x1, y1), 0);\n    vec3 sampledTransform = uintBitsToFloat(pixel0.xyz);\n    uint color = pixel0.w;\n#endif\n\n    if (splatVsBox(sampledTransform.xyz) > 0.0) {\n        gl_Position = vec4(0.0, 0.0, 0.0, 0.0);\n        return;\n    }\n\n    vec4 viewCenter = ${e} * vec4(sampledTransform.xyz, 1.0);\n\n    vec4 clipCenter = ${s} * viewCenter;\n    vec3 ndcCenter = clipCenter.xyz / clipCenter.w;\n\n    if (useCustomColor > 0.0) {\n        sampledTransformLocal = sampledTransform.xyz;\n        #ifdef IS_RTK\n            sampledTransformLocal = inverse(prj2ECEF) * sampledTransformLocal;\n        #endif\n        float lerp = (sampledTransformLocal.z - heightRange.x) / (heightRange.y - heightRange.x) * 0.99;\n        vColor = vec4(texture(customColors, vec2(lerp, 0.5)));\n    } else {\n        vColor = decodeColor(color);\n    }\n\n    gl_Position = vec4(ndcCenter.xy + position.xy * 0.001 , ndcCenter.z, 1.0) * clipCenter.w;\n\n   \n`}}(t),{modelMatrix:a}=t;return{vertexShaderSH:`\n    ${e}\n    \n    const float SH_C0 = 0.28209479177387814;\n    const float SH_C1 = 0.4886025119029199;\n    const float SH_C2[5] = float[5]( 1.0925484305920792, -1.0925484305920792, 0.31539156525252005, -1.0925484305920792, 0.5462742152960396 );\n    const float SH_C3[7] = float[7](-0.5900435899266435, 2.890611442640554, -0.4570457994644658, 0.3731763325901154, -0.4570457994644658, 1.445305721320277, -0.5900435899266435 );\n    \n    struct  SH {\n        vec3 sh1;\n        vec3 sh2;\n        vec3 sh3;\n        vec3 sh4;\n        vec3 sh5;\n        vec3 sh6;\n        vec3 sh7;\n        vec3 sh8;\n        vec3 sh9;\n        vec3 sh10;\n        vec3 sh11;\n        vec3 sh12;\n        vec3 sh13;\n        vec3 sh14;\n        vec3 sh15;\n    };\n    \n    SH sh;\n    \n\n    \n    vec3 DecodePacked_11_10_11(uint enc)\n    {\n        return vec3(\n        float(enc & 2047u) / 2047.0,\n        float((enc >> 11u) & 1023u) / 1023.0,\n        float((enc >> 21u) & 2047u) / 2047.0);\n    }\n    \n    \n    vec3 mixSH(vec3 min, vec3 max, vec3 xyz)\n    {\n        return vec3(\n            mix(min.x, max.x, xyz.x),\n            mix(min.y, max.y, xyz.y),\n            mix(min.z, max.z, xyz.z)\n        );\n    }\n    \n    void handleSHRawData(uvec4 raw0, uvec4 raw1, uvec4 raw2, uvec4 raw3)\n    {\n        uint sh1 = raw0.r;\n        uint sh2 = raw0.g;\n        uint sh3 = raw0.b;\n        uint sh4 = raw0.a;\n    \n    \n        uint sh5 = raw1.r;\n        uint sh6 = raw1.g;\n        uint sh7 = raw1.b;\n        uint sh8 = raw1.a;\n    \n        uint sh9 = raw2.r;\n        uint sh10 = raw2.g;\n        uint sh11 = raw2.b;\n        uint sh12 = raw2.a;\n    \n        uint sh13 = raw3.r;\n        uint sh14 = raw3.g;\n        uint sh15 = raw3.b;\n    \n        sh.sh1 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh1));\n        sh.sh2 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh2));\n        sh.sh3 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh3));\n        sh.sh4 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh4));\n        sh.sh5 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh5));\n        sh.sh6 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh6));\n        sh.sh7 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh7));\n        sh.sh8 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh8));\n        sh.sh9 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh9));\n        sh.sh10 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh10));\n        sh.sh11 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh11));\n        sh.sh12 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh12));\n        sh.sh13 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh13));\n        sh.sh14 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh14));\n        sh.sh15 = mixSH(compressedSHMin, compressedSHMax, DecodePacked_11_10_11(sh15));\n    }\n    \n    vec3 ShadeSH(vec3 dir)\n    {\n        float x = dir.x, y = dir.y, z = dir.z;\n    \n        vec3 result = vec3(0., 0., 0.);\n    \n        result += SH_C1 * (-sh.sh1 * y + sh.sh2 * z - sh.sh3 * x);\n    \n        float xx = x * x, yy = y * y, zz = z * z;\n        float xy = x * y, yz = y * z, xz = x * z;\n    \n        result +=\n            (SH_C2[0] * xy) * sh.sh4 +\n            (SH_C2[1] * yz) * sh.sh5 +\n            (SH_C2[2] * (2. * zz - xx - yy)) * sh.sh6 +\n            (SH_C2[3] * xz) * sh.sh7 +\n            (SH_C2[4] * (xx - yy)) * sh.sh8;\n    \n        result +=\n            (SH_C3[0] * y * (3. * xx - yy)) * sh.sh9 +\n            (SH_C3[1] * xy * z) * sh.sh10 +\n            (SH_C3[2] * y * (4. * zz - xx - yy)) * sh.sh11 +\n            (SH_C3[3] * z * (2. * zz - 3. * xx - 3. * yy)) * sh.sh12 +\n            (SH_C3[4] * x * (4. * zz - xx - yy)) * sh.sh13 +\n            (SH_C3[5] * z * (xx - yy)) * sh.sh14 +\n            (SH_C3[6] * x * (xx - 3. * yy)) * sh.sh15;\n    \n        return result;\n    }\n\n    uint composeShRaw(in vec4 shRaw) {\n        int r = int(shRaw.r * 255.0);\n        int g = int(shRaw.g * 255.0);\n        int b = int(shRaw.b * 255.0);\n        int a = int(shRaw.a * 255.0);\n        int uint32Value = (a << 24) | (b << 16) | (g << 8) | r;\n        return uint(uint32Value);\n    }\n\n    //使用Uint8Array存储Uint32Array数据, Cesium不支持Uint32Array\n    uvec4 getRawTexture( in sampler2D shRawTexture, in int u8Index, in uint shIndex, in vec2 shDimensions){\n\n          vec4 shRaw0 = texture(shRawTexture, getStrideDataUV(4 * 4, 0 + u8Index * 4, shIndex, shDimensions));\n          vec4 shRaw1 = texture(shRawTexture, getStrideDataUV(4 * 4, 1 + u8Index * 4, shIndex, shDimensions));\n          vec4 shRaw2 = texture(shRawTexture, getStrideDataUV(4 * 4, 2 + u8Index * 4, shIndex, shDimensions));\n          vec4 shRaw3 = texture(shRawTexture, getStrideDataUV(4 * 4, 3 + u8Index * 4, shIndex, shDimensions));\n\n    \n          return uvec4(composeShRaw(shRaw0), composeShRaw(shRaw1), composeShRaw(shRaw2), composeShRaw(shRaw3));\n\n    }\n\n    // Check point visible at range [startIdx, endIdx]\n    // float computePointVisible(float startIdx, float endIdx, float idx) {\n    //     float visible = 1.0;\n    //     if (startIdx > 0.0 || endIdx > 0.0) {\n    //         if (idx > startIdx && idx < endIdx) {\n    //             visible = 0.0;\n    //         } \n    //     }\n        \n    //     return visible;\n    // }\n\n\n    void main () {\n        vec3 sampledTransformLocal;\n        if(pointsOnly > 0.0)\n        {   \n            ${i}\n        }\n        else\n        {\n    \n            ${s}\n    \n            if(useSH > 0.0)\n            {\n                // vec3 viewDir = sampledTransform.xyz - (inverse(mat4(${a})) * vec4(cmrPos, 1.0)).xyz;\n                \n                sampledTransformLocal = sampledTransform.xyz;\n                #ifdef IS_RTK\n                    sampledTransformLocal = inverse(prj2ECEF) * sampledTransformLocal;\n                #endif\n                vec3 viewDir = sampledTransformLocal.xyz -  cmrPos;\n\n                viewDir = normalize( viewDir).xyz;\n\n                int shIdxNew = idx * 4;\n                int sh_x = shIdxNew % int(shDimensions.x);\n                int sh_y = shIdxNew / int(shDimensions.x);\n\n                uvec4 shRaw0 = floatBitsToUint(texelFetch(shRawTexture, ivec2(sh_x, sh_y), 0));\n                uvec4 shRaw1 = floatBitsToUint(texelFetch(shRawTexture, ivec2(sh_x + 1, sh_y), 0));\n                uvec4 shRaw2 = floatBitsToUint(texelFetch(shRawTexture, ivec2(sh_x + 2, sh_y), 0));\n                uvec4 shRaw3 = floatBitsToUint(texelFetch(shRawTexture, ivec2(sh_x + 3, sh_y), 0));\n    \n                handleSHRawData(uvec4(shRaw0), uvec4(shRaw1), uvec4(shRaw2), uvec4(shRaw3));\n    \n                vec3 shColor = ShadeSH(viewDir);\n                //vec3 gray = vec3(dot(shColor, vec3(0.299, 0.587, 0.114))) + 1.;\n                \n                vColor.rgb += shColor;\n                // vColor.rgb = clamp(vColor.rgb, 0., 1.);\n            }\n        }\n        vResolution = viewport;\n    }\n    `}}function ye(t){const{gl_FragColor:e}=t;return{fragmentShader:`\n        precision highp float;\n        uniform float alpha;\n        uniform vec4 clipPlane;\n        in vec4 vColor;\n        in vec2 vPosition;\n        in vec2 vResolution;\n        void main () {\n            // compute clip plane\n            vec2 ndc_xy = (gl_FragCoord.xy / vResolution) * 2.0 - 1.0;\n            vec3 ndc = vec3(ndc_xy.x, -ndc_xy.y, gl_FragCoord.z * 2.0 - 1.0);\n            if (dot(ndc, clipPlane.xyz) < clipPlane.w) {\n                discard;\n            }\n\n            // compute the negative squared distance from the center of the splat to the\n            // current fragment in the splat's local space.\n            \n            float A = -dot(vPosition, vPosition);\n            if (A < -4.0) discard;\n            vec3 color = vColor.rgb;\n            A = exp(A) * vColor.a;\n\n            // A = 1.0;\n\n            ${e} = vec4(color.rgb, A * alpha);\n        }\n    `}}let be=class{#ze;#Ee;#Ae;#Ie;#Fe;#Re;#ke;#Ne;get tempTexFloatRed(){return this.#Ie}get tempTexFloatRGBA(){return this.#Fe}get tempTexIntRGBA(){return this.#Re}get rainbowTex(){return this.#Ae}get baseGeometry(){return this.#ke}get baseMaterial(){return this.#Ne}constructor(t){this.#ze=t,this.#Ee=this.#ze.renderLib,this.#Le("rainbow",h[1]),this.#Be(),this.#He(),this.#qe()}dispose(){this.#Ae?.dispose(),this.#ke.dispose(),this.#Ne.dispose(),this.#Ie.dispose(),this.#Ie.image.data=null,this.#Ie=null,this.#Fe.dispose(),this.#Fe.image.data=null,this.#Fe=null,this.#Re.dispose(),this.#Re.image.data=null,this.#Re=null}#Be(){const t=4,e=4,s=new Float32Array(t*e);for(let t=0;t<s.length;++t)s[t]=0;this.#Ie=new this.#Ee.DataTexture(s,t,e,this.#Ee.RedFormat,this.#Ee.FloatType),this.#Ie.needsUpdate=!0,this.#Ie.unpackAlignment=4;const i=4,a=4,r=new Float32Array(i*a*4);for(let t=0;t<r.length;++t)r[t]=0;this.#Fe=new this.#Ee.DataTexture(r,i,a,this.#Ee.RGBAFormat,this.#Ee.FloatType),this.#Fe.needsUpdate=!0,this.#Fe.unpackAlignment=4;const n=4,h=4,o=new Int32Array(n*h*4);for(let t=0;t<o.length;++t)o[t]=0;this.#Re=new this.#Ee.DataTexture(o,n,h,this.#Ee.RGBAIntegerFormat,this.#Ee.IntType),this.#Re.internalFormat="RGBA32I",this.#Re.needsUpdate=!0,this.#Re.unpackAlignment=4}#Le(t,e){(new this.#Ee.TextureLoader).load(e,(e=>{this.#Ae=e,this.#Ae.name=t}),void 0,(t=>{console.log("create texture failed: ",t)}))}#He(){this.#ke=new this.#Ee.BufferGeometry;let t=new Float32Array(18),e=new this.#Ee.BufferAttribute(t,3);this.#ke.setAttribute("position",e),e.setXYZ(2,-1,1,0),e.setXYZ(1,-1,-1,0),e.setXYZ(0,1,1,0),e.setXYZ(5,-1,-1,0),e.setXYZ(4,1,-1,0),e.setXYZ(3,1,1,0),e.needsUpdate=!0}#qe(){this.#Ne=new this.#Ee.ShaderMaterial({uniforms:{splatData:{value:null},splatIndexes:{value:null},splatIndexesHost:{value:null},shRawTexture:{value:null},customColors:{value:null},dimensions:{value:new this.#Ee.Vector2(0,0)},dataDimensions:{value:new this.#Ee.Vector2(0,0)},shDimensions:{value:new this.#Ee.Vector2(0,0)},viewport:{value:new this.#Ee.Vector2(0,0)},focal:{value:0},splatCount:{value:0},pointsOnly:{value:!1},useSH:{value:!1},useIndexHost:{value:!1},alpha:{value:1},useCustomColor:{value:!0},compressedScaleMin:{value:new this.#Ee.Vector3(0,0,0)},compressedScaleMax:{value:new this.#Ee.Vector3(0,0,0)},compressedSHMin:{value:new this.#Ee.Vector3(0,0,0)},compressedSHMax:{value:new this.#Ee.Vector3(0,0,0)},cmrPos:{value:new this.#Ee.Vector3(0,0,0)},heightRange:{value:new this.#Ee.Vector2(0,0)},clipPlane:{value:new this.#Ee.Vector4(0,0,0,0)},clipBoxMatrixInv:{value:new this.#Ee.Matrix4},clipBoxSide:{value:1}},vertexShader:Me(ge).vertexShaderSH,fragmentShader:ye(ge).fragmentShader,transparent:!0,alphaTest:1,blending:this.#Ee.NormalBlending,depthTest:!0,depthWrite:!1,side:this.#Ee.DoubleSide})}};class we{constructor(t=new J,e=new J(0,0,-1),s=1/0){this.origin=t,this.direction=e,this.length=s}set(t,e,s=1/0){return this.origin.copy(t),this.direction.copy(e),this.length=s,this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this.length=t.length,this}intersectBox(t){let e,s,i,a,r,n;const h=1/this.direction.x,o=1/this.direction.y,l=1/this.direction.z,c=this.origin;if(h>=0?(e=(t.min.x-c.x)*h,s=(t.max.x-c.x)*h):(e=(t.max.x-c.x)*h,s=(t.min.x-c.x)*h),o>=0?(i=(t.min.y-c.y)*o,a=(t.max.y-c.y)*o):(i=(t.max.y-c.y)*o,a=(t.min.y-c.y)*o),e>a||i>s)return null;if((i>e||isNaN(e))&&(e=i),(a<s||isNaN(s))&&(s=a),l>=0?(r=(t.min.z-c.z)*l,n=(t.max.z-c.z)*l):(r=(t.max.z-c.z)*l,n=(t.min.z-c.z)*l),e>n||r>s)return null;if((r>e||e!=e)&&(e=r),(n<s||s!=s)&&(s=n),s<0)return null;let u=Math.max(0,e);return{point:this.origin.clone().addScaledVector(this.direction,u),distance:u}}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection((new jt).extractRotation(t)),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class ve{static GlobalID=0;#m=!1;#P;#Oe;#Ee;#M;#Ue;#Ve;#je;#Ge;#We;#Qe;#Xe;#Ze;#Ye;#Ke;#Je;#H;#$e;#ts;#es;#ss=new J;#is=new J;#as=0;#rs=new J;#ns=new J;#hs=0;#os;#ls=!1;#cs=!1;#us=!1;#ds=!1;dimensions;dataDimensions;shDimensions;sortInfos;indexRT;isEnvMesh=!1;#N=new Mt;#ms=0;#ps=0;#xs=0;#fs=0;#gs=0;get isDispose(){return this.#m}get id(){return this.#M}get object(){return this.#Ke}get node(){return this.#Je}get size(){return this.#ms}set isFirstSorted(t){this.#cs=t}get isFirstSorted(){return this.#cs}set isSorting(t){this.#us=t}get isSorting(){return this.#us}get splatCount(){return this.#os}set pos(t){this.#$e=t}get pos(){return this.#$e}set distances(t){this.#ts=t}get distances(){return this.#ts}set indexes(t){this.#es=t}get indexes(){return this.#es}get sortCmrPosLast(){return this.#ss.clone()}get sortTickLast(){return this.#as}get sortCmrPosPending(){return this.#rs}get transformsTexture(){return this.#Ze?.uniforms?.splatData?.value}get hasUploadSH(){return this.#ls}constructor(t,e,s,i,a,r){this.#M=ve.GlobalID++,this.#P=t,this.#Oe=this.#P.resources,this.#Ee=this.#P.lccParam.renderLib,this.#Je=e,this.#H=e?.parent?.center||new J(0,0,0),this.#os=s;let n=t.meta.data;if(this.isEnvMesh=!e,this.isEnvMesh?(n.compressInfo.positionMin&&n.compressInfo.positionMax&&this.#N.set(n.compressInfo.positionMin,n.compressInfo.positionMax),this.#je=n.compressInfo.positionMax,this.#Ge=n.compressInfo.positionMin,this.#Ue=n.compressInfo.compressedEnvScaleMax||n.compressInfo.compressedScaleMax,this.#Ve=n.compressInfo.compressedEnvScaleMin||n.compressInfo.compressedScaleMin,this.#We=n.compressInfo.compressedEnvSHMax||n.compressInfo.compressedSHMax,this.#Qe=n.compressInfo.compressedEnvSHMin||n.compressInfo.compressedSHMin):(this.#N.copy(this.#Je.parent.getBBox()),this.#je=n.max,this.#Ge=n.min,this.#Ue=n.compressInfo.compressedScaleMax,this.#Ve=n.compressInfo.compressedScaleMin,this.#We=n.compressInfo.compressedSHMax,this.#Qe=n.compressInfo.compressedSHMin),a){this.#$e=new Float32Array(a.length);for(let t=0;t<a.length;++t)this.#$e[t]=a[t];this.#ts=new Int32Array(this.#os),this.#es=new Int32Array(this.#os)}this.dimensions=it(this.#os),this.dataDimensions=it(2*this.#os),this.shDimensions=it(4*this.#os);let h=this.#Ms(this.#os);this.sortInfos={totalDrawCount:at(this.dimensions.x*this.dimensions.y),lastDrawCount:0,maxCountOneTime:h},this.#ys(),this.#bs(),this.#Ke=new this.#Ee.Mesh(this.#Xe,this.#Ze),this.#Ke.frustumCulled=!1,this.#Ke.name="lccMesh",this.#ws(),i&&this.updateSplatDataTexture(i),r&&this.updateSHTexture(r),0===this.#ms&&console.warn("has not update gpu size !!!")}dispose(){this.#m=!0,this.#$e=null,this.#Ke&&(this.#Ke.removeFromParent(),this.#Ke=null),this.#Ze&&(this.#Ze.uniforms.splatData.value&&(this.#Ze.uniforms.splatData.value.dispose(),this.#Ze.uniforms.splatData.value.image.data=null,this.#Ze.uniforms.splatData.value=null),this.#Ze.uniforms.splatIndexesHost.value&&(this.#Ze.uniforms.splatIndexesHost.value.dispose(),this.#Ze.uniforms.splatIndexesHost.value.image.data=null,this.#Ze.uniforms.splatIndexesHost.value=null),this.#Ze.uniforms.shRawTexture.value&&this.#Ze.uniforms.shRawTexture.value!==this.#Oe.tempTexFloatRGBA&&(this.#Ze.uniforms.shRawTexture.value.dispose(),this.#Ze.uniforms.shRawTexture.value.image.data=null,this.#Ze.uniforms.shRawTexture.value=null),this.#Ze.dispose(),this.#Ze=null),this.#Xe&&(this.#Xe.dispose(),this.#Xe=null),this.indexRT&&(this.indexRT.texture.dispose(),this.indexRT.dispose(),this.indexRT=null)}#ys(){const t=this.#Oe.baseGeometry;this.#Xe=(new this.#Ee.InstancedBufferGeometry).copy(t),this.#Xe.instanceCount=this.#os}#bs(){this.#Ze=this.#Oe.baseMaterial.clone()}#ws(){const t=this.dimensions,e=this.dataDimensions,s=this.shDimensions;if(this.#P.config.WebglSortingEnable){const e=this.#Ee.RGBAIntegerFormat,s=this.#Ee.IntType,i="RGBA32I";this.indexRT=new this.#Ee.WebGLRenderTarget(t.x,t.y,{count:1,minFilter:this.#Ee.NearestFilter,magFilter:this.#Ee.NearestFilter,format:e,type:s,internalFormat:i,depthBuffer:!1,stencilBuffer:!1}),this.indexRT.texture.name="SortIndex"}this.#Ze.uniforms.splatCount.value=this.#os,this.#Ze.uniforms.dimensions.value=new this.#Ee.Vector2(t.x,t.y),this.#Ze.uniforms.dataDimensions.value=new this.#Ee.Vector2(e.x,e.y),this.#Ze.uniforms.shDimensions.value=new this.#Ee.Vector2(s.x,s.y),this.#Ze.uniforms.heightRange.value=new this.#Ee.Vector2(this.#Ge.z,this.#je.z),this.#Ve&&(this.#Ze.uniforms.compressedScaleMin.value=new this.#Ee.Vector3(this.#Ve.x,this.#Ve.y,this.#Ve.z)),this.#Ue&&(this.#Ze.uniforms.compressedScaleMax.value=new this.#Ee.Vector3(this.#Ue.x,this.#Ue.y,this.#Ue.z)),this.#Qe&&(this.#Ze.uniforms.compressedSHMin.value=new this.#Ee.Vector3(this.#Qe.x,this.#Qe.y,this.#Qe.z)),this.#We&&(this.#Ze.uniforms.compressedSHMax.value=new this.#Ee.Vector3(this.#We.x,this.#We.y,this.#We.z)),this.#Ze.uniforms.customColors.value=this.#Oe.rainbowTex;const i=new Uint32Array(e.x*e.y*4);this.#Ye=i,this.#Ze.uniforms.splatData.value=new this.#Ee.DataTexture(i,e.x,e.y,this.#Ee.RGBAIntegerFormat,this.#Ee.UnsignedIntType),this.#Ze.uniforms.splatData.value.needsUpdate=!0,this.#Ze.uniforms.splatData.value.internalFormat="RGBA32UI",this.#Ze.uniforms.splatData.value.unpackAlignment=4;const a=new Int32Array(t.x*t.y);this.#Ze.uniforms.splatIndexesHost.value=new this.#Ee.DataTexture(a,t.x,t.y,this.#Ee.RedIntegerFormat,this.#Ee.IntType),this.#Ze.uniforms.splatIndexesHost.value.needsUpdate=!0,this.#Ze.uniforms.splatIndexesHost.value.internalFormat="R32I",this.#Ze.uniforms.splatIndexesHost.value.unpackAlignment=4,this.#Ze.uniforms.splatIndexes.value=this.#Oe.tempTexIntRGBA,this.#Ze.uniforms.shRawTexture.value=this.#Oe.tempTexFloatRGBA,this.#Ze.uniformsNeedUpdate=!0,this.#xs=a.byteLength,this.#fs=i.byteLength,this.#vs()}#vs(){this.#ms=this.#ps+this.#xs+this.#fs+this.#gs}updateSplatDataTexture(t){if(this.#m)return;const e=this.#Ze.uniforms.splatData.value,s=e.image.data,i=new Uint32Array(s.buffer);for(let e=0;e<t.length;++e)i[e]=t[e];e.needsUpdate=!0}updateIndexTextureRT(){this.#m||(this.indexRT?this.#Ze.uniforms.splatIndexes.value=this.indexRT.texture:console.error("Please create RT firstly !!!"))}updateIndexTexture(t){if(this.#m)return;const e=this.#Ze.uniforms.splatIndexesHost.value,s=e.image.data;t.length!==this.#os&&console.error("udpate error ....................fd");const i=new Int32Array(s.buffer),a=Math.min(t.length,this.#os);for(let e=0;e<a;++e)i[e]=t[e];e.needsUpdate=!0}updateIndexTextureWithInit(){if(this.#m)return;const t=this.#Ze.uniforms.splatIndexesHost.value,e=t.image.data,s=new Int32Array(e.buffer);for(let t=0;t<this.#os;++t)s[t]=t;for(let t=this.#os;t<s.length;++t)s[t]=0;t.needsUpdate=!0,this.#cs=!0,this.#ds=!0;const i=this.#P.dynamicState.cmrPosLocal.clone(),a=this.#P.dynamicState.cmrForward.clone();this.#ss.copy(i),this.#is.copy(a),this.#as=this.#P.dynamicState.tick}updateSHTexture(t){if(this.#m||this.#ls)return;this.#ls=!0;const e=new Float32Array(this.shDimensions.x*this.shDimensions.y*4);this.#Ze.uniforms.shRawTexture.value=new this.#Ee.DataTexture(e,this.shDimensions.x,this.shDimensions.y,this.#Ee.RGBAFormat,this.#Ee.FloatType),this.#Ze.uniforms.shRawTexture.value.needsUpdate=!0,this.#Ze.uniforms.shRawTexture.value.unpackAlignment=4;const s=this.#Ze.uniforms.shRawTexture.value,i=s.image.data,a=new Uint32Array(i.buffer);for(let e=0;e<t.length;++e)a[e]=t[e];s.needsUpdate=!0,this.#Ke.onAfterRender=()=>{this.#Ze.uniforms.shRawTexture.value.image.data=null,this.#Ke.onAfterRender=()=>{}},this.#gs=e.byteLength,this.#vs()}updateUniformsDynamic(){if(this.#m)return;const t=this.#P.dynamicState;this.#Ze.uniforms.viewport.value=new this.#Ee.Vector2(t.viewport.x,t.viewport.y),this.#Ze.uniforms.focal.value=t.focal,this.#Ze.uniforms.pointsOnly.value=t.pointsOnly,this.#Ze.uniforms.alpha.value=t.alpha,this.#Ze.uniforms.useSH.value=!(!t.useSH||!this.#ls),this.#Ze.uniforms.useCustomColor.value=t.useCustomColor,this.#Ze.uniforms.cmrPos.value=t.cmrPosLocal.clone(),this.#Ze.uniforms.clipPlane.value.copy(t.clipPlane),this.#Ze.uniforms.clipBoxMatrixInv.value.copy(t.clipBoxMatrixInv),this.#Ze.uniforms.clipBoxSide.value=t.clipBoxSide,this.#Ze.uniforms.useIndexHost.value=this.#ds}getBBox(){return this.#N}intersectWithRay(t,e){const s=new J,i=new J,a=new J,r=e*e;let n=-1;const h=new Float32Array(this.#Ye.buffer);for(let e=0;e<this.#os;++e){const o=h[8*e+0],l=h[8*e+1],c=h[8*e+2],u=s.set(o,l,c),d=i.copy(u).sub(t.origin),m=d.dot(t.direction);if(m<0||m>t.length)continue;const p=a.copy(t.origin).addScaledVector(t.direction,m).sub(t.origin).sub(d);p.dot(p)>r||(t.length=m,n=m)}if(n<0)return null;return{point:t.origin.clone().addScaledVector(t.direction,n),distance:n}}#Ms(t){const e=t/1e4;return e<1?100:e<10?90:e<20?70:e<30?50:e<40?40:e<50?30:e<60?20:e<70?10:e<80||e<90||e<100||e<110||e<120||e<130||e<140||e<150||e<160?5:e<180?3:1}checkNeedSort(){if(this.#us)return!1;if(!this.#cs)return!0;if(this.isEnvMesh&&this.#cs)return!1;const t=this.#P.config.CameraPosChangedSortThreshold;this.#P.config.CameraAngleChangedSortThreshold;const e=this.#P.dynamicState.cmrPosLocal.distanceToSquared(this.#ss),s=this.#P.dynamicState.tick-this.#as;if(e<t*t)return!1;const i=[0,160,320,480,640,800,960];return!(s<i[Math.min(i.length-1,this.#Je.level)])}startSorting(){const t=this.#P.dynamicState.cmrPosLocal.clone(),e=this.#P.dynamicState.cmrForward.clone();this.#rs.copy(t),this.#ns.copy(e),this.#hs=this.#P.dynamicState.tick,this.isSorting=!0}endSorting(t=!1){this.#ds=t,this.#cs=!0,this.#us=!1,this.sortInfos.lastDrawCount=0,t?this.updateIndexTexture(this.indexes):this.updateIndexTextureRT(),this.#ss.copy(this.#rs),this.#is.copy(this.#ns),this.#as=this.#hs}}function Se(t){const e=new Int32Array(1e5);self.onmessage=t=>{const s=t.data.workerIndex,i=t.data.splatCount,a=t.data.camPos,r=new Int32Array(t.data.indexesBuffer),n=new Int32Array(t.data.distancesBuffer),h=new Float32Array(t.data.transformsBuffer);!function(t,s,i,a,r){let n=Number.MAX_SAFE_INTEGER,h=-Number.MAX_SAFE_INTEGER,o=s.x-r[0],l=s.y-r[1],c=s.z-r[2],u=-1e3*Math.sqrt(o*o+l*l+c*c);for(let e=0;e<t;e++){let t=s.x-r[3*e],i=s.y-r[3*e+1],o=s.z-r[3*e+2],l=-1e3*Math.sqrt(t*t+i*i+o*o),c=Math.round(l-u);c>h&&(h=c),c<n&&(n=c),a[e]=c}const d=h-n+1;let m;if(d<e.length){m=e;for(let t=0;t<d;++t)e[t]=0}else m=new Int32Array(d);for(let e=0;e<t;e++)m[a[e]-n]++;for(let t=1;t<m.length;++t)m[t]+=m[t-1];for(let t=a.length-1;t>=0;--t){const e=a[t]-n;m[e]--,i[m[e]]=t}}(i,a,r,n,h),postMessage({workerIndex:s,indexesBuffer:r.buffer,distancesBuffer:n.buffer,transformsBuffer:h.buffer},[r.buffer,n.buffer,h.buffer])}}class _e{splatCount;camPos;indexes;distances;transforms;mesh;beginCallback;endCalllback}class Ce{#m=!1;#Ss=[];#_s=[];#Cs=[];#Ts=0;#Ds=0;#Ps=!0;constructor(t){for(let e=0;e<t;++e){const t=Lt(Se);t?(this.#Ts++,this.#Ss.push(t)):console.error("create worker failed !!!")}this.#Ss.forEach((t=>{t.onmessage=t=>{if(this.#m)return;const e=t.data.workerIndex,s=this.#Cs[e];s.indexes=new Int32Array(t.data.indexesBuffer),s.distances=new Int32Array(t.data.distancesBuffer),s.transforms=new Float32Array(t.data.transformsBuffer),s.endCalllback?.(s),this.#Ds--,this.#_s[e]=!1}}))}setEnable(t){this.#Ps=t}isReady(){return this.#Ps&&this.#Ds<this.#Ts}dispose(){this.#m=!0,this.#Ss.forEach((t=>{t.terminate()})),this.#Ss=[],this.#Ts=0}triggerSorting(t){if(!this.isReady())return void console.error("CPUSorter is not ready !!!");let e,s=-1;for(let t=0;t<this.#Ss.length;++t)if(!this.#_s[t]){s=t,e=this.#Ss[t];break}s<0?console.error("not find ready worker!!!"):(this.#Cs[s]=t,this.#_s[s]=!0,this.#Ds+=1,t.beginCallback?.(t),e.postMessage({workerIndex:s,splatCount:t.splatCount,camPos:{x:t.camPos.x,y:t.camPos.y,z:t.camPos.z},indexesBuffer:t.indexes.buffer,distancesBuffer:t.distances.buffer,transformsBuffer:t.transforms.buffer},[t.indexes.buffer,t.distances.buffer,t.transforms.buffer]))}update(){}}const Te="\nprecision highp float;\nin vec3 position;\nvoid main() {\n     gl_Position = vec4( position, 1.0 );\n}\n";let De=class{#P;#yt;#Ee;#zs;#Es;#As;#Is;#Fs;#Rs;#ks;#Ns={x:512,y:512};#Ls=null;#Ps=!0;constructor(t){this.#P=t,this.#Ee=this.#P.lccParam.renderLib,this.#zs=this.#P.lccParam.renderer,this.#yt=this.#P.config,this.#As=new this.#Ee.BufferGeometry,this.#As.setAttribute("position",new this.#Ee.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),this.#Es=new this.#Ee.OrthographicCamera(-1,1,1,-1,0,1),this.#Bs(this.#Ns),this.#Hs()}#Bs(t){const e=this.#Ee.RGBAIntegerFormat,s=this.#Ee.IntType,i="RGBA32I";this.#Rs=new this.#Ee.WebGLRenderTarget(t.x,t.y,{count:1,minFilter:this.#Ee.NearestFilter,magFilter:this.#Ee.NearestFilter,format:e,type:s,internalFormat:i,depthBuffer:!1,stencilBuffer:!1}),this.#Rs.texture.name="sortRT1",this.#ks=new this.#Ee.WebGLRenderTarget(t.x,t.y,{count:1,minFilter:this.#Ee.NearestFilter,magFilter:this.#Ee.NearestFilter,format:e,type:s,internalFormat:i,depthBuffer:!1,stencilBuffer:!1}),this.#ks.texture.name="sortRT2"}#Hs(){let t=new this.#Ee.RawShaderMaterial({name:"Bitonic Sort ",uniforms:{u_data:{value:null},dimension:{value:{x:2,y:2}},stage:{value:0},pass:{value:0}},vertexShader:Te,fragmentShader:"\nprecision highp float;\nprecision highp int;\nlayout(location = 0) out ivec4 pc_FragColor;\n\nuniform highp isampler2D u_data;\n\nuniform int stage;\nuniform int pass;\nuniform ivec2 dimension;\n\nivec4 fetch(int x, int y) {\n    return texelFetch(u_data, ivec2(x, y), 0);\n}\n\nbool minOrmax(int d1_high, int d1_low, int d2_high, int d2_low) {\n    if(d1_high > d2_high) {\n     return true;\n    }\n    if(d1_high < d2_high) {\n     return false;\n    }\n\n    if(d1_low > d2_low) {\n        return true;\n    }\n\n    if(d1_low < d2_low) {\n        return false;\n    }\n\n    return false;\n}\nvoid main() {\n\n    int fx = int(gl_FragCoord.x);\n    int fy = int(gl_FragCoord.y);\n    int index = fx + fy * dimension.x;\n\n    int pairIndex = index ^ pass;\n\n    int dFx = pairIndex % dimension.x;\n    int dFy = pairIndex / dimension.x;\n\n    bool mask = index > pairIndex;\n\n    ivec4 indexValue = fetch(fx, fy);\n    ivec4 pairValue = fetch(dFx, dFy);\n\n    bool up = ((index & stage) == 0);\n\n    // int b1 = (index - pairIndex) / abs(index - pairIndex);\n\n    // int vv = indexValue.x - pairValue.x;\n\n    // int b2 = (vv) / abs(vv);\n\n    // int b3 = min(index & stage, 2) - 1;\n    \n    // int rs1 = b1 * b2 * b3;\n\n    // pc_FragColor = max(rs1 * indexValue, -rs1 * pairValue);\n\n\n    if(!up) {\n        // if(indexValue.x > pairValue.x){\n\n        if(minOrmax(indexValue.x, indexValue.z, pairValue.x, pairValue.z)){\n            if(mask) {\n                pc_FragColor = indexValue;\n            } else {\n                pc_FragColor = pairValue;\n            }\n        } else {\n            if(mask) {\n                pc_FragColor = pairValue;\n            } else {\n                pc_FragColor = indexValue;\n            }\n        }\n    } else {\n        // if(indexValue.x < pairValue.x){\n\n        if(!minOrmax(indexValue.x, indexValue.z, pairValue.x, pairValue.z)){\n            if(mask) {\n                pc_FragColor = indexValue;\n            } else {\n                pc_FragColor = pairValue;\n            }\n        } else {\n            if(mask) {\n                pc_FragColor = pairValue;\n            } else {\n                pc_FragColor = indexValue;\n            }\n        }\n    }\n    \n}\n\n\n",glslVersion:this.#Ee.GLSL3,depthTest:!1,depthWrite:!1,side:this.#Ee.DoubleSide}),e=new this.#Ee.RawShaderMaterial({name:"Bitonic Sort Distance",uniforms:{transforms:{value:null},dimension:{value:{x:2,y:2}},dataDimensions:{value:{x:2,y:2}},splatCount:{value:0},cmrPos:{value:{x:0,y:0,z:0}}},vertexShader:Te,fragmentShader:"\nprecision highp float;\nprecision highp int;\nlayout(location = 0) out ivec4 pc_FragColor;\n\nuniform sampler2D transforms;\n\nuniform int splatCount;\nuniform ivec2 dimension;\nuniform ivec2 dataDimensions;\nuniform vec3 cmrPos;\n\nvoid main() {\n\n\n    int fx = int(gl_FragCoord.x);\n    int fy = int(gl_FragCoord.y);\n\n    int index = fx + fy * dimension.x;\n\n    int id1 = int(index * 2);\n    int x1 = id1 % int(dataDimensions.x);\n    int y1 = id1 / int(dataDimensions.x);\n\n    if(index >= splatCount) {\n      pc_FragColor = ivec4(10, index, 0, 0);\n    } else {\n      vec4 sampledTransform = texelFetch(transforms, ivec2(x1, y1), 0);\n      float distance = length(vec3(sampledTransform.xyz) - cmrPos) + 1000.0;\n      float dm = fract(distance) * 1000000000.;\n      pc_FragColor = ivec4(int(distance), index, int(dm), 0);\n    }\n}\n\n",glslVersion:this.#Ee.GLSL3,depthTest:!1,depthWrite:!1,side:this.#Ee.DoubleSide});this.#Fs=new this.#Ee.Mesh(this.#As,t),this.#Is=new this.#Ee.Mesh(this.#As,e)}#qs(t,e){const s=e.sortCmrPosPending,i=e.splatCount,a=e.dimensions,r=e.transformsTexture;this.#Is.material.uniforms.splatCount.value=i,this.#Is.material.uniforms.dimension.value=a,this.#Is.material.uniforms.dataDimensions.value=e.dataDimensions,this.#Is.material.uniforms.transforms.value=r,this.#Is.material.uniforms.cmrPos.value=s,this.#Ns.x*this.#Ns.y<a.x*a.y&&(this.#Ns.x=a.x,this.#Ns.y=a.y,this.#Rs.setSize(this.#Ns.x,this.#Ns.y),this.#ks.setSize(this.#Ns.x,this.#Ns.y)),t.setViewport(0,0,a.x,a.y),t.setRenderTarget(this.#Rs),t.render(this.#Is,this.#Es)}#Os(t,e){const s=e.sortInfos,i=e.dimensions,a=s.maxCountOneTime,r=i.x*i.y;let n=0;const h=Math.min(s.lastDrawCount+a,s.totalDrawCount);this.#Fs.material.uniforms.dimension.value=i;for(let a=2;a<=r;a<<=1)for(let r=a>>1;r>0;r>>=1){if(n<s.lastDrawCount){n++;continue}if(n===h)return void(s.lastDrawCount=h);n++,this.#Fs.material.uniforms.stage.value=a,this.#Fs.material.uniforms.pass.value=r,this.#Fs.material.uniforms.u_data.value=this.#Rs.texture,t.setViewport(0,0,i.x,i.y),n===s.totalDrawCount?t.setRenderTarget(e.indexRT):t.setRenderTarget(this.#ks),t.render(this.#Fs,this.#Es);let o=this.#Rs;this.#Rs=this.#ks,this.#ks=o}h===s.totalDrawCount&&(e.endSorting(),this.#Ls=null)}update(){if(this.#Ls){if(this.#Ls.isDispose)return console.log("sorting mesh had been disposed !!!"),void(this.#Ls=null);this.#Ls.sortInfos.lastDrawCount<1&&this.#qs(this.#zs,this.#Ls),this.#Os(this.#zs,this.#Ls),this.#zs.setRenderTarget(null)}}setEnable(t){this.#Ps=t}isReady(){return this.#Ps&&!this.#Ls}triggerSorting(t){this.#Ls||(this.#Ls=t,t.startSorting())}dispose(){this.#Ls=null,this.#Es=null,this.#Is&&(this.#Is.geometry=null,this.#Is.material&&(this.#Is.material.uniforms.transforms.value=null,this.#Is.material.dispose(),this.#Is.material=null),this.#Is=null),this.#Fs&&(this.#Fs.geometry=null,this.#Fs.material&&(this.#Fs.material.uniforms.u_data.value=null,this.#Fs.material.dispose(),this.#Fs.material=null),this.#Fs=null),this.#As&&(this.#As.dispose(),this.#As=null),this.#Rs&&(this.#Rs.texture.dispose(),this.#Rs.dispose(),this.#Rs=null),this.#ks&&(this.#ks.texture.dispose(),this.#ks.dispose(),this.#ks=null)}};class Pe{#m=!1;#Us;#W;#P;#Vs;#js;#Gs;#Ws=[];#Qs=[];#Xs=[];#Zs=[];#Ys=[];#Ks=0;constructor(t){this.#P=t,this.#Us=this.#P.gpuCache,this.#W=this.#P.cpuCache,this.#Vs=new Ce(this.#P.config.CpuSortThreadNum),this.#P.config.WebglSortingEnable&&(this.#js=new De(this.#P))}dispose(){this.#m=!0,this.#Vs.dispose(),this.#js?.dispose(),this.#Gs?.dispose()}#Js(){if(this.#Gs)return this.#Gs;const t=this.#P.meta,e=this.#W.queryEnv(this.#P.renderID);if(!e||!t)return null;const{splatCounts:s,data:i,sh:a,pos:r}=e;return this.#Gs=new ve(this.#P,null,s,i,r,a),this.#Gs.object.renderOrder=0,this.#Gs}getEnvmesh(t=!0){return this.#Gs||this.#Js(),this.#Gs?t&&!this.#Gs.isFirstSorted?null:this.#Gs:null}getMesh(t,e=!0){let s=this.#Us.queryMesh(t.renderID,t.id);return s?e&&!s.isFirstSorted?null:s:null}clearCacheQueue(){this.#Ws=[]}pushCacheQueue(t){this.#Ws.push(t)}clearCacheSHQueue(){this.#Qs=[]}pushCacheSHQueue(t){this.#Qs.push(t)}clearSortQueue(){this.#Xs=[],this.#Zs=[]}pushSortQueue(t){t.isSorting||(t.isFirstSorted,this.#Zs.push(t))}update(t){if(!this.#m){for(let t=0;t<this.#Ws.length;++t){const s=this.#Ws[t];if(!s||!s.isCache(e)||this.#Us.queryMesh(s.renderID,s.id))continue;const{data:i,sh:a,pos:r}=s.queryCache(),n=new ve(this.#P,s,s.points,i,r,a);this.#Us.pushMesh(s.renderID,s.id,n,n.size)||(console.log("push mesh failed..."),n.dispose())}for(let t=0;t<this.#Qs.length;++t){const e=this.#Qs[t],i=e.node;if(e.hasUploadSH||!i||!i.isCache(s))continue;const{data:a,sh:r,pos:n}=i.queryCache();e.updateSHTexture(r),this.#Us.flushMesh(i.renderID,i.id,e,e.size)}for(0==this.#Ys.length&&(this.#Ys=[...this.#Xs,...this.#Zs]);this.#Ys.length>0&&(this.#js?.isReady()||this.#Vs.isReady());){let t=this.#Ys.shift();if(t&&!t.isDispose&&t.checkNeedSort()){if(this.#Vs.isReady()){const e=this.#P.dynamicState.cmrPosLocal,s=new _e;s.splatCount=t.splatCount,s.camPos={x:e.x,y:e.y,z:e.z},s.distances=t.distances,s.indexes=t.indexes,s.transforms=t.pos,s.mesh=t,s.beginCallback=t=>{t.mesh&&!t.mesh.isDispose&&t.mesh.startSorting()},s.endCalllback=t=>{t.mesh&&!t.mesh.isDispose&&(t.mesh.pos=t.transforms,t.mesh.indexes=t.indexes,t.mesh.distances=t.distances,t.mesh.endSorting(!0))},this.#Vs.triggerSorting(s)}this.#js?.isReady()&&this.#js.triggerSorting(t)}}this.#js?.update()}}}class ze{#$s=new jt;#ti=1;#ei=new J;#si=new J;#ii=new J;constructor(){this.update()}get matrix(){return this.#$s}get matrixInverse(){return this.matrix.clone().invert()}get clipSide(){return this.#ti}get position(){return this.#ei}get rotation(){return this.#ii}get scale(){return this.#si}setSize(t,e,s){this.#si(t,e,s)}reset(){this.#ei=new J,this.#ii=new J,this.#si=new J,this.#ti=1,this.update()}copy(t){this.#ei.copy(t.position),this.#si.copy(t.scale),this.#ii.copy(t.rotation),this.#ti=t.clipSide,this.#$s.copy(t.matrix)}update(t,e,s,i=1){t?.isVector3&&this.#ei.copy(t),e?.isVector3&&this.#ii.copy(e),s?.isVector3&&this.#si.copy(s);const a=(new jt).makeRotationX(this.#ii.x).multiply((new jt).makeRotationY(this.#ii.y)).multiply((new jt).makeRotationZ(this.#ii.z)),r=(new Y).setFromRotationMatrix(a),n=(new jt).compose(this.#ei,r,this.#si);this.#$s=n,this.#ti=i}}let Ee=class t extends ot{static GlobalID=0;#m=!1;#M;#Ee;#bt;#ai;#ze;#W;#Us;#wt;#ri;#yt;#P;#ni;#hi=[];#oi=new ze;#It=!1;#li=!1;#ci=!0;#ui;constructor(e){super(),this.#M=t.GlobalID++,this.#P=e,this.#P.renderID=this.#M,this.#ze=this.#P.lccParam,this.#bt=this.#P.cameraMgr,this.#W=this.#P.cpuCache,this.#Us=this.#P.gpuCache,this.#wt=this.#P.dataLoader,this.#yt=this.#P.config,this.#Ee=this.#P.lccParam.renderLib,this.#ai=new xe(this.#P,this.#bt,this.#wt),this.#ri=new Pe(this.#P),this.#ni=new this.#Ee.Group}get id(){return this.#M}get distanceToCam(){if(!this.#It)return 1e6;return this.#ai.center.distanceToSquared(this.#P.dynamicState.cmrPosLocal)}get root(){return this.#ni}get maxLoadSplatCount(){return this.#yt.maxLoadSplatCount}set maxLoadSplatCount(t){console.log("set max splats: "+t),this.#yt.maxLoadSplatCount=t,this.#ai.setConfigDirty()}dispose(){this.#m=!0,this.#ni.clear(),this.#ri.dispose();const t=[];this.#ai.getAllNodeID(t),this.#ai.dispose(),this.#W.clear(this.id,t),this.#Us.clear(this.id,t)}getInstancedMesh(){return this.#ni}getEnvInstancedMesh(){return this.#ni}togglePointsDisplayMode(){this.#yt.pointsOnly=!this.#yt.pointsOnly}useEnvironment(t){this.#yt.useEnv=!!t,this.#ai.setConfigDirty()}useShcoef(t,e){this.#yt.useSH=!!t,this.#ai.setConfigDirty(),this.#It?t&&this.#ci&&(this.#ci=!1,this.#ai.loadSH((()=>{}),(t=>{e&&e(t)}),(()=>{console.error("load sh failed...")}))):console.error("meta is not ready")}hasShcoef(){return!!this.#It&&this.#ai.hasSH}getBounds(){if(!this.#It)return null;let t=this.#ai.bbox;if(!t)return null;let e=t.min,s=t.max;return{min:{x:e.x,y:e.y,z:e.z},max:{x:s.x,y:s.y,z:s.z}}}setVisible(t){this.#yt.visible=!!t}setAlpha(t){st(t)?console.error("set failed !!!"):(t=Z.clamp(t,0,1),this.#yt.alpha=t)}setClipBox(t){if(!(t&&t.scale&&t.rotation&&t.position))return void console.error("set failed !!!");const e=t.clipSide||1,s=rt("scale",t),i=rt("rotation",t),a=rt("position",t);s&&i&&a?this.#oi.update(a,i,s,e):console.error("set failed !!!")}setClipPlane(t,e){Array.isArray(t)&&"number"==typeof e?this.#P.dynamicState.clipPlane.set(t[0],t[1],t[2],e):console.error("setClipPlane failed: param error")}setStartLod(t){st(t)||t<0?console.error("set failed !!!"):(this.#yt.MinLodUsed=t,this.#ai.setConfigDirty())}setMaxDistance(t){st(t)||t<0?console.error("set failed !!!"):(this.#yt.MaxDistaneLimit=t,this.#ai.setConfigDirty())}setMaxSplats(t){st(t)||t<0?console.error("set failed !!!"):(console.log("set max splats: "+t),this.#yt.maxLoadSplatCount=t,this.#ai.setConfigDirty())}getCurrentConfig(){return this.#yt.getUserConfig()}updateCurrentConfig(t){this.#yt.setUserConfig(t),this.#ai.setConfigDirty()}_paramToRay(t){const e=this.#bt.projectionMatrix.clone().invert(),s=nt(this.#ze.canvas,t.evt);s.applyMatrix4(e).applyMatrix4(this.#bt.cam2WorldMatrix);const i=this.#bt.position.clone(),a=s.sub(i).normalize();return new we(i,a,t.maxDistance)}_paramToRayFromOrigin(t){const e=new J(t.origin.x,t.origin.y,t.origin.z),s=new J(t.direction.x,t.direction.y,t.direction.z).normalize();return new we(e,s,t.maxDistance)}#di(t){const e=this.#bt.projectionMatrix.clone().invert(),s=nt(this.#ze.canvas,t.evt);s.applyMatrix4(e).applyMatrix4(this.#bt.cam2WorldMatrix);const i=this.#bt.position.clone(),a=s.sub(i).normalize();return new we(i,a,t.maxDistance).applyMatrix4((new jt).copy(this.#ni.matrixWorld).invert()).intersectBox(this.#ai.bbox)}#mi(t){const e=new J(t.origin.x,t.origin.y,t.origin.z),s=new J(t.direction.x,t.direction.y,t.direction.z).normalize();return new we(e,s,t.maxDistance).applyMatrix4((new jt).copy(this.#ni.matrixWorld).invert()).intersectBox(this.#ai.bbox)}raycast(t){if(this.#m)return console.error("The renderer had been dispose !!!"),null;if(!t||!t.evt||st(t.evt.x)||st(t.evt.y)||st(t.maxDistance)||st(t.radius))return null;if(t.maxDistance<0||t.radius<0)return null;const e=this.#bt.projectionMatrix.clone().invert(),s=nt(this.#ze.canvas,t.evt);s.applyMatrix4(e).applyMatrix4(this.#bt.cam2WorldMatrix);const i=this.#bt.position.clone(),a=s.sub(i).normalize();return this.raycastFromOrigin({origin:{x:i.x,y:i.y,z:i.z},direction:{x:a.x,y:a.y,z:a.z},maxDistance:t.maxDistance,radius:t.radius})}raycastFromOrigin(t){if(this.#m)return console.error("The renderer had been dispose !!!"),null;if(!t||!t.origin||!t.direction||st(t.maxDistance)||st(t.radius))return null;if(st(t.origin.x)||st(t.origin.y)||st(t.origin.z))return null;if(st(t.direction.x)||st(t.direction.y)||st(t.direction.z))return null;if(t.maxDistance<0||t.radius<0)return null;const e=new J(t.origin.x,t.origin.y,t.origin.z),s=new J(t.direction.x,t.direction.y,t.direction.z).normalize(),i=new we(e,s,t.maxDistance).applyMatrix4((new jt).copy(this.#ni.matrixWorld).invert()),a=t.radius;let r=[];this.#hi.forEach((t=>{if(t.isEnvMesh)return;const e=t.getBBox(),s=i.intersectBox(e);s&&r.push({mesh:t,distance:s.distance})})),r.sort(((t,e)=>t.distance-e.distance));for(let t=0;t<r.length;++t){let e=r[t].mesh.intersectWithRay(i,a);if(e){const t=e.point;return t.applyMatrix4(this.#ni.matrixWorld),{x:t.x,y:t.y,z:t.z}}}return null}#pi(t){const e=this.#ze.canvas,s=this.#P.dynamicState,i=e.width,a=e.height,r=this.#bt.fov,n=this.#bt.projectionMatrix,h=this.#bt.cam2WorldMatrix,o=(new jt).copy(this.#ni.matrixWorld).invert(),c=(new jt).multiplyMatrices(o,h),u=this.#bt.position,d=new J(0,0,-1).applyMatrix4(h),m=this.#bt.position.clone().applyMatrix4(o);let p=new de;p.setFromProjectionMatrix(n),p.planes.forEach((t=>{t.applyMatrix4(c)})),s.frustum=p,s.focal=a/2/Math.tan(r/2/180*Math.PI),s.viewport.x=i,s.viewport.y=a,s.cmrPos.copy(u),s.cmrForward.copy(d),s.cmrPosLocal.copy(m),s.cmrProjMatrix.copy(n),s.cmr2LocalMatrix.copy(c),s.cmrPosModelLocal.copy(m),s.cmr2ModelLocalMatrix.copy(c),s.alpha=this.#yt.alpha,s.visible=this.#yt.visible,s.useEnv=this.#yt.useEnv,s.useSH=this.#yt.useSH,s.pointsOnly=this.#yt.pointsOnly,s.useCustomColor=!(this.#yt.pointsColor!==l),s.clipBoxSide=this.#oi.clipSide,s.clipBoxMatrixInv.copy(this.#oi.matrixInverse),s.tick=t}load(t,e,s,i){this.#ai.load(t,(t=>{this.#It=!0}),(()=>{console.log("loading ready ..."),this.#li=!0;const t=this.getInstancedMesh();e&&e(t)}),(t=>{s&&s(t)}),(()=>{i&&i()}),(t=>{if(!t)return!0;let e=this.#Us.queryMesh(t.renderID,t.id);return!(!e||!e.isFirstSorted)}))}update(t){if(this.#hi=[],this.#ni.clear(),this.#ni.updateMatrixWorld(!0),this.#pi(t),this.#ri.clearCacheQueue(),this.#ri.clearCacheSHQueue(),this.#ri.clearSortQueue(),this.#ai.update(t),!this.#It)return;const e=this.#ai.getRenderNodes();this.#xi(e),this.#fi(),this.#gi(),this.#hi.forEach(((t,e,s)=>{t.updateUniformsDynamic(),this.#yt.useSH&&!t.hasUploadSH&&this.#ri.pushCacheSHQueue(t),t.object.renderOrder=-e-1,this.#ni.add(t.object)})),this.#ni.visible=this.#P.dynamicState.visible,this.#ri.update(t),this.#Mi()}#xi(t){if(0!=t.length)for(let s=0;s<t.length;++s){const i=t[s];if(!i)continue;const a=i.parent,r=i.level,n=a.nodes.length;let h,o=this.#Us.queryMesh(i.renderID,i.id);if(o){if(!o.checkNeedSort()){this.#hi.push(o);continue}this.#ri.pushSortQueue(o)}else i.isCache(e)&&this.#ri.pushCacheQueue(i);let l,c,u=0;for(let t=r;t<n;++t){const e=a.nodes[t];if(!e||e.points<this.#yt.MinValidSplatsInNode)continue;let s=this.#Us.queryMesh(e.renderID,e.id);if(!s||!s.isFirstSorted)continue;const i=s.sortTickLast;i>u&&(u=i,h=s)}if(h)this.#hi.push(h);else{for(let t=r;t<n;++t){const e=a.nodes[t];if(!e||e.points<this.#yt.MinValidSplatsInNode)continue;let s=this.#Us.queryMesh(e.renderID,e.id);if(s){l=s;break}}if(l&&l!==o)this.#ri.pushSortQueue(l);else{for(let t=r;t<n;++t){const s=a.nodes[t];if(s&&!(s.points<this.#yt.MinValidSplatsInNode)&&s.isCache(e)){c=s;break}}c&&c!==i&&this.#ri.pushCacheQueue(c)}}}}#fi(){const t=this.#ri.getEnvmesh();if(this.#P.dynamicState.useEnv)if(t)this.#li&&this.#hi.push(t),t.checkNeedSort()&&this.#ri.pushSortQueue(t);else{const t=this.#ri.getEnvmesh(!1);t&&this.#ri.pushSortQueue(t)}}#gi(){if(this.#li)return;const t=this.#ai.getLoadingNodes();for(let s=0;s<t.length;++s){const i=t[s];if(!i)continue;let a=this.#Us.queryMesh(i.renderID,i.id);!a&&i.isCache(e)?this.#ri.pushCacheQueue(i):a&&!a.isFirstSorted&&this.#ri.pushSortQueue(a)}}#Mi(){let t=0,e=0,s=1e9;this.#hi.forEach((i=>{t+=i.splatCount,e=Math.max(e,i.splatCount),s=Math.min(s,i.splatCount)}));const i=this.#P.performance;i.totalPoints=t,i.maxPoints=e,i.minPoints=s,i.meshNum=this.#hi.length;const a=this.#P.dynamicState.tick;void 0===this.#ui&&(this.#ui=a),a-this.#ui>2e3&&(this.#ui=a)}};function Ae(t){const e=0,s=2,i=t.data.type,a=t.data.buffer;if(i==e){const{pos:t}=(t=>{const e=t.byteLength/32,s=new Uint32Array(t),i=new Uint32Array(3*e);for(let t=0;t<e;++t)i[3*t+0]=s[8*t+0],i[3*t+1]=s[8*t+1],i[3*t+2]=s[8*t+2];return{pos:i}})(a);postMessage({dataBuffer:a,posBuffer:t.buffer},[a,t.buffer])}else if(i==s){const{pos:t,sh:e,data:s}=(t=>{const e=24,s=t.byteLength/96,i=new Uint32Array(t),a=new Uint32Array(3*s),r=new Uint32Array(8*s),n=new Uint32Array(16*s);for(let t=0;t<s;++t){a[3*t+0]=i[t*e+0],a[3*t+1]=i[t*e+1],a[3*t+2]=i[t*e+2];for(let s=0;s<8;++s)r[8*t+s]=i[t*e+s];for(let s=0;s<16;++s)n[16*t+s]=i[t*e+8+s]}return{pos:a,sh:n,data:r}})(a);postMessage({dataBuffer:s.buffer,posBuffer:t.buffer,shBuffer:e.buffer},[s.buffer,t.buffer,e.buffer])}else console.error("unkonw type......")}let Ie=class extends Bt{#m=!1;constructor(){super()}dispose(){this.#m=!0}update(t){}decompress(t,s,a,r,n){if(t!==e&&t!==i)return void console.error("unkonw type .");const h=Nt(Ae);h.addEventListener("message",(s=>{if(!this.#m){if(t===e){const t=new Uint32Array(s.data.dataBuffer),e=new Float32Array(s.data.posBuffer);n(t,e,void 0)}else if(t===i){const t=new Uint32Array(s.data.dataBuffer),e=new Float32Array(s.data.posBuffer),i=new Uint32Array(s.data.shBuffer);n(t,e,i)}h.terminate()}})),h.postMessage({type:t,buffer:s},[s])}},Fe=class extends Ot{#m=!1;#yi;#ze;#bt;#W;#Us;#wt;#Q;#bi=[];#Oe;#ni;constructor(t,e){super(),this.#yi=t,this.#ze=e,this.#Oe=new be(e),this.#bt=new $t(e),this.#W=new ut(this.#yi.MaxCPUCacheSize,void 0),this.#Us=new Ft(this.#yi.MaxGPUCacheSize,((t,e)=>{e?.dispose()})),this.#Q=new Ie,this.#wt=new qt(this.#W,this.#Q,!0),this.#ni=new this.#ze.renderLib.Group,this.#ni.renderOrder=0,this.#ze.scene.add(this.#ni)}get isDispose(){return this.#m}dispose(){this.#m||(this.#m=!0,this.#ze.scene.remove(this.#ni),this.#bi.forEach((t=>{t.dispose()})),this.#bi=[],this.#wt.dispose(),this.#Q.dispose(),this.#Us.dispose(),this.#W.dispose(),this.#bt.dispose(),this.#Oe.dispose())}update(t){if(this.#bt.update(t),this.#W.update(t),this.#Us.update(t),this.#wt.update(t),this.#Q.update?.(t),this.#bi.forEach((e=>{e.update(t)})),this.#bi.length>1){const t=this.#bi.map(((t,e)=>e));t.sort(((t,e)=>this.#bi[e].distanceToCam-this.#bi[t].distanceToCam));let e=this.#bi[t[0]].root.children.length;for(let s=1;s<t.length;++s){const i=t[s];this.#bi[i].root.children.forEach(((t,s,i)=>{t.renderOrder-=e})),e+=this.#bi[i].root.children.length}}}createRenderer(){let t=new ht(this.#yi);t.useEnv=this.#ze.useEnv,t.gpuAcceleration=this.#ze.gpuAcceleration,t.pointsColor=this.#ze.pointsColor;let e=new me;e.config=t,e.lccParam=this.#ze,e.cpuCache=this.#W,e.gpuCache=this.#Us,e.dataLoader=this.#wt,e.resources=this.#Oe,e.cameraMgr=this.#bt,e.platform=this.#yi;let s=new Ee(e);return this.#bi.push(s),this.#ni.add(s.root),s}destroyRenderer(t){this.#bi.indexOf(t)<0||(this.#ni.remove(t?.root),this.#bi=this.#bi.filter((e=>e!==t)),t?.dispose())}getAllRenderers(){return this.#bi}raycast(t){if(0==this.#bi.length)return null;if(1==this.#bi.length)return this.#bi[0].raycast(t);const e=[];return this.#bi.forEach(((s,i,a)=>{let r=s._paramToRay(t),n=s.raycast(t);if(n){let t=r.origin.distanceToSquared(new J(n.x,n.y,n.z));e.push({intersect:n,distance:t,renderIndex:i})}})),e.sort(((t,e)=>t.distance-e.distance)),e.length>0?e[0].intersect:null}raycastFromOrigin(t){if(0==this.#bi.length)return null;if(1==this.#bi.length)return this.#bi[0].raycastFromOrigin(t);const e=[];return this.#bi.forEach(((s,i,a)=>{let r=s._paramToRayFromOrigin(t),n=s.raycastFromOrigin(t);if(n){let t=r.origin.distanceToSquared(new J(n.x,n.y,n.z));e.push({intersect:n,distance:t,renderIndex:i})}})),e.sort(((t,e)=>t.distance-e.distance)),e.length>0?e[0].intersect:null}};class Re extends Jt{#ot;#lt;#ct;#ut;#dt;#mt;#pt;#xt=!1;#ei=new J;#ii=new Y;#wi=new jt;#vi=new jt;constructor(t){super(),this.#ot=t.camera,this.#lt=t.canvas,this.#ct=this.fov,this.#ut=this.#lt.width,this.#dt=this.#lt.height,this.#mt=this.position.clone(),this.#pt=this.rotation.clone()}get isCameraChanged(){return this.#xt}get fov(){return 180*this.#ot.frustum.fov/Math.PI}get fovy(){return 180*this.#ot.frustum.fovy/Math.PI}get position(){return this.#ei.copy(this.#ot.positionWC)}get projectionMatrix(){return this.#wi.fromCesiumMatrix4(this.#ot.frustum.projectionMatrix)}get rotation(){return this.#ii.fromCesiumMatrix4(this.#ot.inverseViewMatrix)}get cam2WorldMatrix(){return this.#vi.fromCesiumMatrix4(this.#ot.inverseViewMatrix)}_update(t){let e=this.position,s=this.rotation,i=this.fov,a=this.#lt.width,r=this.#lt.height;this.#xt=!1,i!=this.#ct&&(this.#ct=i,this.#xt=!0),a==this.#ut&&r==this.#dt||(this.#ut=a,this.#dt=r,this.#xt=!0),e.equals(this.#mt)||(this.#mt.copy(e),this.#xt=!0),s.equals(this.#pt)||(this.#pt.copy(s),this.#xt=!0)}_dispose(){}}function ke(t){var e=1,s=2,i=3,a=5,r=6378137,n=6356752.314,h=.0066943799901413165,o=484813681109536e-20,l=Math.PI/2,c=.16666666666666666,u=.04722222222222222,d=.022156084656084655,m=1e-10,p=.017453292519943295,x=57.29577951308232,f=Math.PI/4,g=2*Math.PI,M=3.14159265359,y={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667},b={ft:{to_meter:.3048},"us-ft":{to_meter:1200/3937}},w=/[\s_\-\/\(\)]/g;function v(t,e){if(t[e])return t[e];for(var s,i=Object.keys(t),a=e.toLowerCase().replace(w,""),r=-1;++r<i.length;)if((s=i[r]).toLowerCase().replace(w,"")===a)return t[s]}function S(t){var e,s,i,a={},r=t.split("+").map((function(t){return t.trim()})).filter((function(t){return t})).reduce((function(t,e){var s=e.split("=");return s.push(!0),t[s[0].toLowerCase()]=s[1],t}),{}),n={proj:"projName",datum:"datumCode",rf:function(t){a.rf=parseFloat(t)},lat_0:function(t){a.lat0=t*p},lat_1:function(t){a.lat1=t*p},lat_2:function(t){a.lat2=t*p},lat_ts:function(t){a.lat_ts=t*p},lon_0:function(t){a.long0=t*p},lon_1:function(t){a.long1=t*p},lon_2:function(t){a.long2=t*p},alpha:function(t){a.alpha=parseFloat(t)*p},gamma:function(t){a.rectified_grid_angle=parseFloat(t)},lonc:function(t){a.longc=t*p},x_0:function(t){a.x0=parseFloat(t)},y_0:function(t){a.y0=parseFloat(t)},k_0:function(t){a.k0=parseFloat(t)},k:function(t){a.k0=parseFloat(t)},a:function(t){a.a=parseFloat(t)},b:function(t){a.b=parseFloat(t)},r:function(t){a.a=a.b=parseFloat(t)},r_a:function(){a.R_A=!0},zone:function(t){a.zone=parseInt(t,10)},south:function(){a.utmSouth=!0},towgs84:function(t){a.datum_params=t.split(",").map((function(t){return parseFloat(t)}))},to_meter:function(t){a.to_meter=parseFloat(t)},units:function(t){a.units=t;var e=v(b,t);e&&(a.to_meter=e.to_meter)},from_greenwich:function(t){a.from_greenwich=t*p},pm:function(t){var e=v(y,t);a.from_greenwich=(e||parseFloat(t))*p},nadgrids:function(t){"@null"===t?a.datumCode="none":a.nadgrids=t},axis:function(t){var e="ewnsud";3===t.length&&-1!==e.indexOf(t.substr(0,1))&&-1!==e.indexOf(t.substr(1,1))&&-1!==e.indexOf(t.substr(2,1))&&(a.axis=t)},approx:function(){a.approx=!0}};for(e in r)s=r[e],e in n?"function"==typeof(i=n[e])?i(s):a[i]=s:a[e]=s;return"string"==typeof a.datumCode&&"WGS84"!==a.datumCode&&(a.datumCode=a.datumCode.toLowerCase()),a}var _=function(t){return new A(t).output()},C=1,T=/\s/,D=/[A-Za-z]/,P=/[A-Za-z84_]/,z=/[,\]]/,E=/[\d\.E\-\+]/;function A(t){if("string"!=typeof t)throw new Error("not a string");this.text=t.trim(),this.level=0,this.place=0,this.root=null,this.stack=[],this.currentObject=null,this.state=C}function I(t,e,s){Array.isArray(e)&&(s.unshift(e),e=null);var i=e?{}:t,a=s.reduce((function(t,e){return F(e,t),t}),i);e&&(t[e]=a)}function F(t,e){if(Array.isArray(t)){var s=t.shift();if("PARAMETER"===s&&(s=t.shift()),1===t.length)return Array.isArray(t[0])?(e[s]={},void F(t[0],e[s])):void(e[s]=t[0]);if(t.length)if("TOWGS84"!==s){if("AXIS"===s)return s in e||(e[s]=[]),void e[s].push(t);var i;switch(Array.isArray(s)||(e[s]={}),s){case"UNIT":case"PRIMEM":case"VERT_DATUM":return e[s]={name:t[0].toLowerCase(),convert:t[1]},void(3===t.length&&F(t[2],e[s]));case"SPHEROID":case"ELLIPSOID":return e[s]={name:t[0],a:t[1],rf:t[2]},void(4===t.length&&F(t[3],e[s]));case"PROJECTEDCRS":case"PROJCRS":case"GEOGCS":case"GEOCCS":case"PROJCS":case"LOCAL_CS":case"GEODCRS":case"GEODETICCRS":case"GEODETICDATUM":case"EDATUM":case"ENGINEERINGDATUM":case"VERT_CS":case"VERTCRS":case"VERTICALCRS":case"COMPD_CS":case"COMPOUNDCRS":case"ENGINEERINGCRS":case"ENGCRS":case"FITTED_CS":case"LOCAL_DATUM":case"DATUM":return t[0]=["name",t[0]],void I(e,s,t);default:for(i=-1;++i<t.length;)if(!Array.isArray(t[i]))return F(t,e[s]);return I(e,s,t)}}else e[s]=t;else e[s]=!0}else e[t]=!0}A.prototype.readCharicter=function(){var t=this.text[this.place++];if(4!==this.state)for(;T.test(t);){if(this.place>=this.text.length)return;t=this.text[this.place++]}switch(this.state){case C:return this.neutral(t);case 2:return this.keyword(t);case 4:return this.quoted(t);case 5:return this.afterquote(t);case 3:return this.number(t);case-1:return}},A.prototype.afterquote=function(t){if('"'===t)return this.word+='"',void(this.state=4);if(z.test(t))return this.word=this.word.trim(),void this.afterItem(t);throw new Error("havn't handled \""+t+'" in afterquote yet, index '+this.place)},A.prototype.afterItem=function(t){return","===t?(null!==this.word&&this.currentObject.push(this.word),this.word=null,void(this.state=C)):"]"===t?(this.level--,null!==this.word&&(this.currentObject.push(this.word),this.word=null),this.state=C,this.currentObject=this.stack.pop(),void(this.currentObject||(this.state=-1))):void 0},A.prototype.number=function(t){if(!E.test(t)){if(z.test(t))return this.word=parseFloat(this.word),void this.afterItem(t);throw new Error("havn't handled \""+t+'" in number yet, index '+this.place)}this.word+=t},A.prototype.quoted=function(t){'"'!==t?this.word+=t:this.state=5},A.prototype.keyword=function(t){if(P.test(t))this.word+=t;else{if("["===t){var e=[];return e.push(this.word),this.level++,null===this.root?this.root=e:this.currentObject.push(e),this.stack.push(this.currentObject),this.currentObject=e,void(this.state=C)}if(!z.test(t))throw new Error("havn't handled \""+t+'" in keyword yet, index '+this.place);this.afterItem(t)}},A.prototype.neutral=function(t){if(D.test(t))return this.word=t,void(this.state=2);if('"'===t)return this.word="",void(this.state=4);if(E.test(t))return this.word=t,void(this.state=3);if(!z.test(t))throw new Error("havn't handled \""+t+'" in neutral yet, index '+this.place);this.afterItem(t)},A.prototype.output=function(){for(;this.place<this.text.length;)this.readCharicter();if(-1===this.state)return this.root;throw new Error('unable to parse string "'+this.text+'". State is '+this.state)};var R,k=.017453292519943295;function N(t){return t*k}function L(t){var e=_(t),s=e.shift(),i=e.shift();e.unshift(["name",i]),e.unshift(["type",s]);var a={};return F(e,a),function(t){if("GEOGCS"===t.type?t.projName="longlat":"LOCAL_CS"===t.type?(t.projName="identity",t.local=!0):"object"==typeof t.PROJECTION?t.projName=Object.keys(t.PROJECTION)[0]:t.projName=t.PROJECTION,t.AXIS){for(var e="",s=0,i=t.AXIS.length;s<i;++s){var a=[t.AXIS[s][0].toLowerCase(),t.AXIS[s][1].toLowerCase()];-1!==a[0].indexOf("north")||("y"===a[0]||"lat"===a[0])&&"north"===a[1]?e+="n":-1!==a[0].indexOf("south")||("y"===a[0]||"lat"===a[0])&&"south"===a[1]?e+="s":-1!==a[0].indexOf("east")||("x"===a[0]||"lon"===a[0])&&"east"===a[1]?e+="e":-1===a[0].indexOf("west")&&("x"!==a[0]&&"lon"!==a[0]||"west"!==a[1])||(e+="w")}2===e.length&&(e+="u"),3===e.length&&(t.axis=e)}t.UNIT&&(t.units=t.UNIT.name.toLowerCase(),"metre"===t.units&&(t.units="meter"),t.UNIT.convert&&("GEOGCS"===t.type?t.DATUM&&t.DATUM.SPHEROID&&(t.to_meter=t.UNIT.convert*t.DATUM.SPHEROID.a):t.to_meter=t.UNIT.convert));var r=t.GEOGCS;function n(e){return e*(t.to_meter||1)}"GEOGCS"===t.type&&(r=t),r&&(r.DATUM?t.datumCode=r.DATUM.name.toLowerCase():t.datumCode=r.name.toLowerCase(),"d_"===t.datumCode.slice(0,2)&&(t.datumCode=t.datumCode.slice(2)),"new_zealand_geodetic_datum_1949"!==t.datumCode&&"new_zealand_1949"!==t.datumCode||(t.datumCode="nzgd49"),"wgs_1984"!==t.datumCode&&"world_geodetic_system_1984"!==t.datumCode||("Mercator_Auxiliary_Sphere"===t.PROJECTION&&(t.sphere=!0),t.datumCode="wgs84"),"_ferro"===t.datumCode.slice(-6)&&(t.datumCode=t.datumCode.slice(0,-6)),"_jakarta"===t.datumCode.slice(-8)&&(t.datumCode=t.datumCode.slice(0,-8)),~t.datumCode.indexOf("belge")&&(t.datumCode="rnb72"),r.DATUM&&r.DATUM.SPHEROID&&(t.ellps=r.DATUM.SPHEROID.name.replace("_19","").replace(/[Cc]larke\_18/,"clrk"),"international"===t.ellps.toLowerCase().slice(0,13)&&(t.ellps="intl"),t.a=r.DATUM.SPHEROID.a,t.rf=parseFloat(r.DATUM.SPHEROID.rf,10)),r.DATUM&&r.DATUM.TOWGS84&&(t.datum_params=r.DATUM.TOWGS84),~t.datumCode.indexOf("osgb_1936")&&(t.datumCode="osgb36"),~t.datumCode.indexOf("osni_1952")&&(t.datumCode="osni52"),(~t.datumCode.indexOf("tm65")||~t.datumCode.indexOf("geodetic_datum_of_1965"))&&(t.datumCode="ire65"),"ch1903+"===t.datumCode&&(t.datumCode="ch1903"),~t.datumCode.indexOf("israel")&&(t.datumCode="isr93")),t.b&&!isFinite(t.b)&&(t.b=t.a),[["standard_parallel_1","Standard_Parallel_1"],["standard_parallel_1","Latitude of 1st standard parallel"],["standard_parallel_2","Standard_Parallel_2"],["standard_parallel_2","Latitude of 2nd standard parallel"],["false_easting","False_Easting"],["false_easting","False easting"],["false-easting","Easting at false origin"],["false_northing","False_Northing"],["false_northing","False northing"],["false_northing","Northing at false origin"],["central_meridian","Central_Meridian"],["central_meridian","Longitude of natural origin"],["central_meridian","Longitude of false origin"],["latitude_of_origin","Latitude_Of_Origin"],["latitude_of_origin","Central_Parallel"],["latitude_of_origin","Latitude of natural origin"],["latitude_of_origin","Latitude of false origin"],["scale_factor","Scale_Factor"],["k0","scale_factor"],["latitude_of_center","Latitude_Of_Center"],["latitude_of_center","Latitude_of_center"],["lat0","latitude_of_center",N],["longitude_of_center","Longitude_Of_Center"],["longitude_of_center","Longitude_of_center"],["longc","longitude_of_center",N],["x0","false_easting",n],["y0","false_northing",n],["long0","central_meridian",N],["lat0","latitude_of_origin",N],["lat0","standard_parallel_1",N],["lat1","standard_parallel_1",N],["lat2","standard_parallel_2",N],["azimuth","Azimuth"],["alpha","azimuth",N],["srsCode","name"]].forEach((function(e){return s=t,a=(i=e)[0],r=i[1],void(!(a in s)&&r in s&&(s[a]=s[r],3===i.length&&(s[a]=i[2](s[a]))));var s,i,a,r})),t.long0||!t.longc||"Albers_Conic_Equal_Area"!==t.projName&&"Lambert_Azimuthal_Equal_Area"!==t.projName||(t.long0=t.longc),t.lat_ts||!t.lat1||"Stereographic_South_Pole"!==t.projName&&"Polar Stereographic (variant B)"!==t.projName?!t.lat_ts&&t.lat0&&"Polar_Stereographic"===t.projName&&(t.lat_ts=t.lat0,t.lat0=N(t.lat0>0?90:-90)):(t.lat0=N(t.lat1>0?90:-90),t.lat_ts=t.lat1)}(a),a}function B(t){var e=this;if(2===arguments.length){var s=arguments[1];"string"==typeof s?"+"===s.charAt(0)?B[t]=S(arguments[1]):B[t]=L(arguments[1]):B[t]=s}else if(1===arguments.length){if(Array.isArray(t))return t.map((function(t){Array.isArray(t)?B.apply(e,t):B(t)}));if("string"==typeof t){if(t in B)return B[t]}else"EPSG"in t?B["EPSG:"+t.EPSG]=t:"ESRI"in t?B["ESRI:"+t.ESRI]=t:"IAU2000"in t?B["IAU2000:"+t.IAU2000]=t:console.log(t);return}}(R=B)("EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"),R("EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees"),R("EPSG:3857","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs"),R.WGS84=R["EPSG:4326"],R["EPSG:3785"]=R["EPSG:3857"],R.GOOGLE=R["EPSG:3857"],R["EPSG:900913"]=R["EPSG:3857"],R["EPSG:102113"]=R["EPSG:3857"];var H=B;var q=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRS","GEODETICCRS","GEODETICDATUM","ENGCRS","ENGINEERINGCRS"];var O=["3857","900913","3785","102113"];var U=function(t){if(!function(t){return"string"==typeof t}(t))return t;if(function(t){return t in H}(t))return H[t];if(function(t){return q.some((function(e){return t.indexOf(e)>-1}))}(t)){var e=L(t);if(function(t){var e=v(t,"authority");if(e){var s=v(e,"epsg");return s&&O.indexOf(s)>-1}}(e))return H["EPSG:3857"];var s=function(t){var e=v(t,"extension");if(e)return v(e,"proj4")}(e);return s?S(s):e}return function(t){return"+"===t[0]}(t)?S(t):void 0};function V(t,e){var s,i;if(t=t||{},!e)return t;for(i in e)void 0!==(s=e[i])&&(t[i]=s);return t}function j(t,e,s){var i=t*e;return s/Math.sqrt(1-i*i)}function G(t){return t<0?-1:1}function W(t){return Math.abs(t)<=M?t:t-G(t)*g}function Q(t,e,s){var i=t*s,a=.5*t;return i=Math.pow((1-i)/(1+i),a),Math.tan(.5*(l-e))/i}function X(t,e){for(var s,i,a=.5*t,r=l-2*Math.atan(e),n=0;n<=15;n++)if(s=t*Math.sin(r),r+=i=l-2*Math.atan(e*Math.pow((1-s)/(1+s),a))-r,Math.abs(i)<=1e-10)return r;return-9999}function Z(t){return t}var Y=[{init:function(){var t=this.b/this.a;this.es=1-t*t,"x0"in this||(this.x0=0),"y0"in this||(this.y0=0),this.e=Math.sqrt(this.es),this.lat_ts?this.sphere?this.k0=Math.cos(this.lat_ts):this.k0=j(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)):this.k0||(this.k?this.k0=this.k:this.k0=1)},forward:function(t){var e,s,i=t.x,a=t.y;if(a*x>90&&a*x<-90&&i*x>180&&i*x<-180)return null;if(Math.abs(Math.abs(a)-l)<=m)return null;if(this.sphere)e=this.x0+this.a*this.k0*W(i-this.long0),s=this.y0+this.a*this.k0*Math.log(Math.tan(f+.5*a));else{var r=Math.sin(a),n=Q(this.e,a,r);e=this.x0+this.a*this.k0*W(i-this.long0),s=this.y0-this.a*this.k0*Math.log(n)}return t.x=e,t.y=s,t},inverse:function(t){var e,s,i=t.x-this.x0,a=t.y-this.y0;if(this.sphere)s=l-2*Math.atan(Math.exp(-a/(this.a*this.k0)));else{var r=Math.exp(-a/(this.a*this.k0));if(-9999===(s=X(this.e,r)))return null}return e=W(this.long0+i/(this.a*this.k0)),t.x=e,t.y=s,t},names:["Mercator","Popular Visualisation Pseudo Mercator","Mercator_1SP","Mercator_Auxiliary_Sphere","merc"]},{init:function(){},forward:Z,inverse:Z,names:["longlat","identity"]}],K={},J=[];function $(t,e){var s=J.length;return t.names?(J[s]=t,t.names.forEach((function(t){K[t.toLowerCase()]=s})),this):(console.log(e),!0)}var tt={start:function(){Y.forEach($)},add:$,get:function(t){if(!t)return!1;var e=t.toLowerCase();return void 0!==K[e]&&J[K[e]]?J[K[e]]:void 0}},et={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},APL4:{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},clrk80ign:{a:6378249.2,b:6356515,rf:293.4660213,ellipseName:"Clarke 1880 (IGN)"},clrk58:{a:6378293.645208759,rf:294.2606763692654,ellipseName:"Clarke 1858"},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS7:{a:6378135,rf:298.26,ellipseName:"WGS 72"}},st=et.WGS84={a:6378137,rf:298.257223563,ellipseName:"WGS 84"};et.sphere={a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"};var it={};it.wgs84={towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},it.ch1903={towgs84:"674.374,15.056,405.346",ellipse:"bessel",datumName:"swiss"},it.ggrs87={towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},it.nad83={towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},it.nad27={nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},it.potsdam={towgs84:"598.1,73.7,418.2,0.202,0.045,-2.455,6.7",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},it.carthage={towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},it.hermannskogel={towgs84:"577.326,90.129,463.919,5.137,1.474,5.297,2.4232",ellipse:"bessel",datumName:"Hermannskogel"},it.militargeographische_institut={towgs84:"577.326,90.129,463.919,5.137,1.474,5.297,2.4232",ellipse:"bessel",datumName:"Militar-Geographische Institut"},it.osni52={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"airy",datumName:"Irish National"},it.ire65={towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},it.rassadiran={towgs84:"-133.63,-157.5,-158.62",ellipse:"intl",datumName:"Rassadiran"},it.nzgd49={towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},it.osgb36={towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Airy 1830"},it.s_jtsk={towgs84:"589,76,480",ellipse:"bessel",datumName:"S-JTSK (Ferro)"},it.beduaram={towgs84:"-106,-87,188",ellipse:"clrk80",datumName:"Beduaram"},it.gunung_segara={towgs84:"-403,684,41",ellipse:"bessel",datumName:"Gunung Segara Jakarta"},it.rnb72={towgs84:"106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1",ellipse:"intl",datumName:"Reseau National Belge 1972"};var at=function(t,r,n,h,l,c,u){var d={};return d.datum_type=void 0===t||"none"===t?a:4,r&&(d.datum_params=r.map(parseFloat),0===d.datum_params[0]&&0===d.datum_params[1]&&0===d.datum_params[2]||(d.datum_type=e),d.datum_params.length>3&&(0===d.datum_params[3]&&0===d.datum_params[4]&&0===d.datum_params[5]&&0===d.datum_params[6]||(d.datum_type=s,d.datum_params[3]*=o,d.datum_params[4]*=o,d.datum_params[5]*=o,d.datum_params[6]=d.datum_params[6]/1e6+1))),u&&(d.datum_type=i,d.grids=u),d.a=n,d.b=h,d.es=l,d.ep2=c,d},rt={};function nt(t){if(0===t.length)return null;var e="@"===t[0];return e&&(t=t.slice(1)),"null"===t?{name:"null",mandatory:!e,grid:null,isNull:!0}:{name:t,mandatory:!e,grid:rt[t]||null,isNull:!1}}function ht(t){return t/3600*Math.PI/180}function ot(t,e,s){return String.fromCharCode.apply(null,new Uint8Array(t.buffer.slice(e,s)))}function lt(t){return t.map((function(t){return[ht(t.longitudeShift),ht(t.latitudeShift)]}))}function ct(t,e,s){return{name:ot(t,e+8,e+16).trim(),parent:ot(t,e+24,e+24+8).trim(),lowerLatitude:t.getFloat64(e+72,s),upperLatitude:t.getFloat64(e+88,s),lowerLongitude:t.getFloat64(e+104,s),upperLongitude:t.getFloat64(e+120,s),latitudeInterval:t.getFloat64(e+136,s),longitudeInterval:t.getFloat64(e+152,s),gridNodeCount:t.getInt32(e+168,s)}}function ut(t,e,s,i){for(var a=e+176,r=[],n=0;n<s.gridNodeCount;n++){var h={latitudeShift:t.getFloat32(a+16*n,i),longitudeShift:t.getFloat32(a+16*n+4,i),latitudeAccuracy:t.getFloat32(a+16*n+8,i),longitudeAccuracy:t.getFloat32(a+16*n+12,i)};r.push(h)}return r}function dt(t,e){if(!(this instanceof dt))return new dt(t);e=e||function(t){if(t)throw t};var s=U(t);if("object"==typeof s){var i=dt.projections.get(s.projName);if(i){if(s.datumCode&&"none"!==s.datumCode){var a=v(it,s.datumCode);a&&(s.datum_params=s.datum_params||(a.towgs84?a.towgs84.split(","):null),s.ellps=a.ellipse,s.datumName=a.datumName?a.datumName:s.datumCode)}s.k0=s.k0||1,s.axis=s.axis||"enu",s.ellps=s.ellps||"wgs84",s.lat1=s.lat1||s.lat0;var r,n,h,o,l,p,x,f=function(t,e,s,i,a){if(!t){var r=v(et,i);r||(r=st),t=r.a,e=r.b,s=r.rf}return s&&!e&&(e=(1-1/s)*t),(0===s||Math.abs(t-e)<m)&&(a=!0,e=t),{a:t,b:e,rf:s,sphere:a}}(s.a,s.b,s.rf,s.ellps,s.sphere),g=(r=f.a,n=f.b,f.rf,h=s.R_A,p=((o=r*r)-(l=n*n))/o,x=0,h?(o=(r*=1-p*(c+p*(u+p*d)))*r,p=0):x=Math.sqrt(p),{es:p,e:x,ep2:(o-l)/l}),M=function(t){return void 0===t?null:t.split(",").map(nt)}(s.nadgrids),y=s.datum||at(s.datumCode,s.datum_params,f.a,f.b,g.es,g.ep2,M);V(this,s),V(this,i),this.a=f.a,this.b=f.b,this.rf=f.rf,this.sphere=f.sphere,this.es=g.es,this.e=g.e,this.ep2=g.ep2,this.datum=y,this.init(),e(null,this)}else e(t)}else e(t)}dt.projections=tt,dt.projections.start();var mt=dt;function pt(t,e,s){var i,a,r,n,h=t.x,o=t.y,c=t.z?t.z:0;if(o<-l&&o>-1.001*l)o=-l;else if(o>l&&o<1.001*l)o=l;else{if(o<-l)return{x:-1/0,y:-1/0,z:t.z};if(o>l)return{x:1/0,y:1/0,z:t.z}}return h>Math.PI&&(h-=2*Math.PI),a=Math.sin(o),n=Math.cos(o),r=a*a,{x:((i=s/Math.sqrt(1-e*r))+c)*n*Math.cos(h),y:(i+c)*n*Math.sin(h),z:(i*(1-e)+c)*a}}function xt(t,e,s,i){var a,r,n,h,o,l,c,u,d,m,p,x,f,g,M,y=1e-12,b=t.x,w=t.y,v=t.z?t.z:0;if(a=Math.sqrt(b*b+w*w),r=Math.sqrt(b*b+w*w+v*v),a/s<y){if(g=0,r/s<y)return M=-i,{x:t.x,y:t.y,z:t.z}}else g=Math.atan2(w,b);n=v/r,u=(h=a/r)*(1-e)*(o=1/Math.sqrt(1-e*(2-e)*h*h)),d=n*o,f=0;do{f++,l=e*(c=s/Math.sqrt(1-e*d*d))/(c+(M=a*u+v*d-c*(1-e*d*d))),x=(p=n*(o=1/Math.sqrt(1-l*(2-l)*h*h)))*u-(m=h*(1-l)*o)*d,u=m,d=p}while(x*x>1e-24&&f<30);return{x:g,y:Math.atan(p/Math.abs(m)),z:M}}function ft(t){return t===e||t===s}function gt(t,o,l){if(function(t,i){return t.datum_type===i.datum_type&&!(t.a!==i.a||Math.abs(t.es-i.es)>5e-11)&&(t.datum_type===e?t.datum_params[0]===i.datum_params[0]&&t.datum_params[1]===i.datum_params[1]&&t.datum_params[2]===i.datum_params[2]:t.datum_type!==s||t.datum_params[0]===i.datum_params[0]&&t.datum_params[1]===i.datum_params[1]&&t.datum_params[2]===i.datum_params[2]&&t.datum_params[3]===i.datum_params[3]&&t.datum_params[4]===i.datum_params[4]&&t.datum_params[5]===i.datum_params[5]&&t.datum_params[6]===i.datum_params[6])}(t,o))return l;if(t.datum_type===a||o.datum_type===a)return l;var c=t.a,u=t.es;if(t.datum_type===i){if(0!==Mt(t,!1,l))return;c=r,u=h}var d=o.a,m=o.b,p=o.es;if(o.datum_type===i&&(d=r,m=n,p=h),u===p&&c===d&&!ft(t.datum_type)&&!ft(o.datum_type))return l;if((l=pt(l,u,c),ft(t.datum_type)&&(l=function(t,i,a){if(i===e)return{x:t.x+a[0],y:t.y+a[1],z:t.z+a[2]};if(i===s){var r=a[0],n=a[1],h=a[2],o=a[3],l=a[4],c=a[5],u=a[6];return{x:u*(t.x-c*t.y+l*t.z)+r,y:u*(c*t.x+t.y-o*t.z)+n,z:u*(-l*t.x+o*t.y+t.z)+h}}}(l,t.datum_type,t.datum_params)),ft(o.datum_type)&&(l=function(t,i,a){if(i===e)return{x:t.x-a[0],y:t.y-a[1],z:t.z-a[2]};if(i===s){var r=a[0],n=a[1],h=a[2],o=a[3],l=a[4],c=a[5],u=a[6],d=(t.x-r)/u,m=(t.y-n)/u,p=(t.z-h)/u;return{x:d+c*m-l*p,y:-c*d+m+o*p,z:l*d-o*m+p}}}(l,o.datum_type,o.datum_params)),l=xt(l,p,d,m),o.datum_type===i)&&0!==Mt(o,!0,l))return;return l}function Mt(t,e,s){if(null===t.grids||0===t.grids.length)return console.log("Grid shift grids not found"),-1;var i={x:-s.x,y:s.y},a={x:Number.NaN,y:Number.NaN},r=[];t:for(var n=0;n<t.grids.length;n++){var h=t.grids[n];if(r.push(h.name),h.isNull){a=i;break}if(h.mandatory,null!==h.grid)for(var o=h.grid.subgrids,l=0,c=o.length;l<c;l++){var u=o[l],d=(Math.abs(u.del[1])+Math.abs(u.del[0]))/1e4,m=u.ll[0]-d,p=u.ll[1]-d,f=u.ll[0]+(u.lim[0]-1)*u.del[0]+d,g=u.ll[1]+(u.lim[1]-1)*u.del[1]+d;if(!(p>i.y||m>i.x||g<i.y||f<i.x)&&(a=yt(i,e,u),!isNaN(a.x)))break t}else if(h.mandatory)return console.log("Unable to find mandatory grid '"+h.name+"'"),-1}return isNaN(a.x)?(console.log("Failed to find a grid shift table for location '"+-i.x*x+" "+i.y*x+" tried: '"+r+"'"),-1):(s.x=-a.x,s.y=a.y,0)}function yt(t,e,s){var i={x:Number.NaN,y:Number.NaN};if(isNaN(t.x))return i;var a={x:t.x,y:t.y};a.x-=s.ll[0],a.y-=s.ll[1],a.x=W(a.x-Math.PI)+Math.PI;var r=bt(a,s);if(e){if(isNaN(r.x))return i;r.x=a.x-r.x,r.y=a.y-r.y;var n,h,o=9;do{if(h=bt(r,s),isNaN(h.x)){console.log("Inverse grid shift iteration failed, presumably at grid edge.  Using first approximation.");break}n={x:a.x-(h.x+r.x),y:a.y-(h.y+r.y)},r.x+=n.x,r.y+=n.y}while(o--&&Math.abs(n.x)>1e-12&&Math.abs(n.y)>1e-12);if(o<0)return console.log("Inverse grid shift iterator failed to converge."),i;i.x=W(r.x+s.ll[0]),i.y=r.y+s.ll[1]}else isNaN(r.x)||(i.x=t.x+r.x,i.y=t.y+r.y);return i}function bt(t,e){var s,i={x:t.x/e.del[0],y:t.y/e.del[1]},a=Math.floor(i.x),r=Math.floor(i.y),n=i.x-1*a,h=i.y-1*r,o={x:Number.NaN,y:Number.NaN};if(a<0||a>=e.lim[0])return o;if(r<0||r>=e.lim[1])return o;s=r*e.lim[0]+a;var l=e.cvs[s][0],c=e.cvs[s][1];s++;var u=e.cvs[s][0],d=e.cvs[s][1];s+=e.lim[0];var m=e.cvs[s][0],p=e.cvs[s][1];s--;var x=e.cvs[s][0],f=e.cvs[s][1],g=n*h,M=n*(1-h),y=(1-n)*(1-h),b=(1-n)*h;return o.x=y*l+M*u+b*x+g*m,o.y=y*c+M*d+b*f+g*p,o}function wt(t,e,s){var i,a,r,n=s.x,h=s.y,o=s.z||0,l={};for(r=0;r<3;r++)if(!e||2!==r||void 0!==s.z)switch(0===r?(i=n,a=-1!=="ew".indexOf(t.axis[r])?"x":"y"):1===r?(i=h,a=-1!=="ns".indexOf(t.axis[r])?"y":"x"):(i=o,a="z"),t.axis[r]){case"e":case"n":l[a]=i;break;case"w":case"s":l[a]=-i;break;case"u":void 0!==s[a]&&(l.z=i);break;case"d":void 0!==s[a]&&(l.z=-i);break;default:return null}return l}function vt(t){var e={x:t[0],y:t[1]};return t.length>2&&(e.z=t[2]),t.length>3&&(e.m=t[3]),e}function St(t){if("function"==typeof Number.isFinite){if(Number.isFinite(t))return;throw new TypeError("coordinates must be finite numbers")}if("number"!=typeof t||t!=t||!isFinite(t))throw new TypeError("coordinates must be finite numbers")}function _t(t,a,r,n){var h,o=void 0!==(r=Array.isArray(r)?vt(r):{x:r.x,y:r.y,z:r.z,m:r.m}).z;if(function(t){St(t.x),St(t.y)}(r),t.datum&&a.datum&&function(t,a){return(t.datum.datum_type===e||t.datum.datum_type===s||t.datum.datum_type===i)&&"WGS84"!==a.datumCode||(a.datum.datum_type===e||a.datum.datum_type===s||a.datum.datum_type===i)&&"WGS84"!==t.datumCode}(t,a)&&(r=_t(t,h=new mt("WGS84"),r,n),t=h),n&&"enu"!==t.axis&&(r=wt(t,!1,r)),"longlat"===t.projName)r={x:r.x*p,y:r.y*p,z:r.z||0};else if(t.to_meter&&(r={x:r.x*t.to_meter,y:r.y*t.to_meter,z:r.z||0}),!(r=t.inverse(r)))return;if(t.from_greenwich&&(r.x+=t.from_greenwich),r=gt(t.datum,a.datum,r))return a.from_greenwich&&(r={x:r.x-a.from_greenwich,y:r.y,z:r.z||0}),"longlat"===a.projName?r={x:r.x*x,y:r.y*x,z:r.z||0}:(r=a.forward(r),a.to_meter&&(r={x:r.x/a.to_meter,y:r.y/a.to_meter,z:r.z||0})),n&&"enu"!==a.axis?wt(a,!0,r):(r&&!o&&delete r.z,r)}var Ct=mt("WGS84");function Tt(t,e,s,i){var a,r,n;return Array.isArray(s)?(a=_t(t,e,s,i)||{x:NaN,y:NaN},s.length>2?void 0!==t.name&&"geocent"===t.name||void 0!==e.name&&"geocent"===e.name?"number"==typeof a.z?[a.x,a.y,a.z].concat(s.splice(3)):[a.x,a.y,s[2]].concat(s.splice(3)):[a.x,a.y].concat(s.splice(2)):[a.x,a.y]):(r=_t(t,e,s,i),2===(n=Object.keys(s)).length||n.forEach((function(i){if(void 0!==t.name&&"geocent"===t.name||void 0!==e.name&&"geocent"===e.name){if("x"===i||"y"===i||"z"===i)return}else if("x"===i||"y"===i)return;r[i]=s[i]})),r)}function Dt(t){return t instanceof mt?t:t.oProj?t.oProj:mt(t)}function Pt(t,e,s){t=Dt(t);var i,a=!1;return void 0===e?(e=t,t=Ct,a=!0):(void 0!==e.x||Array.isArray(e))&&(s=e,e=t,t=Ct,a=!0),e=Dt(e),s?Tt(t,e,s):(i={forward:function(s,i){return Tt(t,e,s,i)},inverse:function(s,i){return Tt(e,t,s,i)}},a&&(i.oProj=e),i)}var zt=Pt,Et=6,At="AJSAJS",It="AFAFAF",Ft=65,Rt=73,kt=79,Nt=86,Lt=90,Bt={forward:Ht,inverse:function(t){var e=Vt(Wt(t.toUpperCase()));if(e.lat&&e.lon)return[e.lon,e.lat,e.lon,e.lat];return[e.left,e.bottom,e.right,e.top]},toPoint:qt};function Ht(t,e){return e=e||5,function(t,e){var s="00000"+t.easting,i="00000"+t.northing;return t.zoneNumber+t.zoneLetter+(m=t.easting,p=t.northing,x=t.zoneNumber,f=Gt(x),g=Math.floor(m/1e5),M=Math.floor(p/1e5)%20,a=g,r=M,n=f,h=n-1,o=At.charCodeAt(h),l=It.charCodeAt(h),c=o+a-1,u=l+r,d=!1,c>Lt&&(c=c-Lt+Ft-1,d=!0),(c===Rt||o<Rt&&c>Rt||(c>Rt||o<Rt)&&d)&&c++,(c===kt||o<kt&&c>kt||(c>kt||o<kt)&&d)&&++c===Rt&&c++,c>Lt&&(c=c-Lt+Ft-1),u>Nt?(u=u-Nt+Ft-1,d=!0):d=!1,(u===Rt||l<Rt&&u>Rt||(u>Rt||l<Rt)&&d)&&u++,(u===kt||l<kt&&u>kt||(u>kt||l<kt)&&d)&&++u===Rt&&u++,u>Nt&&(u=u-Nt+Ft-1),String.fromCharCode(c)+String.fromCharCode(u))+s.substr(s.length-5,e)+i.substr(i.length-5,e);var a,r,n,h,o,l,c,u,d;var m,p,x,f,g,M}(function(t){var e,s,i,a,r,n,h,o,l=t.lat,c=t.lon,u=6378137,d=.00669438,m=.9996,p=Ot(l),x=Ot(c);o=Math.floor((c+180)/6)+1,180===c&&(o=60);l>=56&&l<64&&c>=3&&c<12&&(o=32);l>=72&&l<84&&(c>=0&&c<9?o=31:c>=9&&c<21?o=33:c>=21&&c<33?o=35:c>=33&&c<42&&(o=37));h=Ot(6*(o-1)-180+3),e=d/(1-d),s=u/Math.sqrt(1-d*Math.sin(p)*Math.sin(p)),i=Math.tan(p)*Math.tan(p),a=e*Math.cos(p)*Math.cos(p),r=Math.cos(p)*(x-h),n=u*((1-d/4-3*d*d/64-5*d*d*d/256)*p-(3*d/8+3*d*d/32+45*d*d*d/1024)*Math.sin(2*p)+(15*d*d/256+45*d*d*d/1024)*Math.sin(4*p)-35*d*d*d/3072*Math.sin(6*p));var f=m*s*(r+(1-i+a)*r*r*r/6+(5-18*i+i*i+72*a-58*e)*r*r*r*r*r/120)+5e5,g=m*(n+s*Math.tan(p)*(r*r/2+(5-i+9*a+4*a*a)*r*r*r*r/24+(61-58*i+i*i+600*a-330*e)*r*r*r*r*r*r/720));l<0&&(g+=1e7);return{northing:Math.round(g),easting:Math.round(f),zoneNumber:o,zoneLetter:jt(l)}}({lat:t[1],lon:t[0]}),e)}function qt(t){var e=Vt(Wt(t.toUpperCase()));return e.lat&&e.lon?[e.lon,e.lat]:[(e.left+e.right)/2,(e.top+e.bottom)/2]}function Ot(t){return t*(Math.PI/180)}function Ut(t){return t/Math.PI*180}function Vt(t){var e=t.northing,s=t.easting,i=t.zoneLetter,a=t.zoneNumber;if(a<0||a>60)return null;var r,n,h,o,l,c,u,d,m,p=.9996,x=6378137,f=.00669438,g=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),M=s-5e5,y=e;i<"N"&&(y-=1e7),u=6*(a-1)-180+3,r=.006739496752268451,m=(d=y/p/6367449.145945056)+(3*g/2-27*g*g*g/32)*Math.sin(2*d)+(21*g*g/16-55*g*g*g*g/32)*Math.sin(4*d)+151*g*g*g/96*Math.sin(6*d),n=x/Math.sqrt(1-f*Math.sin(m)*Math.sin(m)),h=Math.tan(m)*Math.tan(m),o=r*Math.cos(m)*Math.cos(m),l=.99330562*x/Math.pow(1-f*Math.sin(m)*Math.sin(m),1.5),c=M/(n*p);var b=m-n*Math.tan(m)/l*(c*c/2-(5+3*h+10*o-4*o*o-9*r)*c*c*c*c/24+(61+90*h+298*o+45*h*h-1.6983531815716497-3*o*o)*c*c*c*c*c*c/720);b=Ut(b);var w,v=(c-(1+2*h+o)*c*c*c/6+(5-2*o+28*h-3*o*o+8*r+24*h*h)*c*c*c*c*c/120)/Math.cos(m);if(v=u+Ut(v),t.accuracy){var S=Vt({northing:t.northing+t.accuracy,easting:t.easting+t.accuracy,zoneLetter:t.zoneLetter,zoneNumber:t.zoneNumber});w={top:S.lat,right:S.lon,bottom:b,left:v}}else w={lat:b,lon:v};return w}function jt(t){var e="Z";return 84>=t&&t>=72?e="X":72>t&&t>=64?e="W":64>t&&t>=56?e="V":56>t&&t>=48?e="U":48>t&&t>=40?e="T":40>t&&t>=32?e="S":32>t&&t>=24?e="R":24>t&&t>=16?e="Q":16>t&&t>=8?e="P":8>t&&t>=0?e="N":0>t&&t>=-8?e="M":-8>t&&t>=-16?e="L":-16>t&&t>=-24?e="K":-24>t&&t>=-32?e="J":-32>t&&t>=-40?e="H":-40>t&&t>=-48?e="G":-48>t&&t>=-56?e="F":-56>t&&t>=-64?e="E":-64>t&&t>=-72?e="D":-72>t&&t>=-80&&(e="C"),e}function Gt(t){var e=t%Et;return 0===e&&(e=Et),e}function Wt(t){if(t&&0===t.length)throw"MGRSPoint coverting from nothing";for(var e,s=t.length,i=null,a="",r=0;!/[A-Z]/.test(e=t.charAt(r));){if(r>=2)throw"MGRSPoint bad conversion from: "+t;a+=e,r++}var n=parseInt(a,10);if(0===r||r+3>s)throw"MGRSPoint bad conversion from: "+t;var h=t.charAt(r++);if(h<="A"||"B"===h||"Y"===h||h>="Z"||"I"===h||"O"===h)throw"MGRSPoint zone letter "+h+" not handled: "+t;i=t.substring(r,r+=2);for(var o=Gt(n),l=function(t,e){var s=At.charCodeAt(e-1),i=1e5,a=!1;for(;s!==t.charCodeAt(0);){if(++s===Rt&&s++,s===kt&&s++,s>Lt){if(a)throw"Bad character: "+t;s=Ft,a=!0}i+=1e5}return i}(i.charAt(0),o),c=function(t,e){if(t>"V")throw"MGRSPoint given invalid Northing "+t;var s=It.charCodeAt(e-1),i=0,a=!1;for(;s!==t.charCodeAt(0);){if(++s===Rt&&s++,s===kt&&s++,s>Nt){if(a)throw"Bad character: "+t;s=Ft,a=!0}i+=1e5}return i}(i.charAt(1),o);c<Qt(h);)c+=2e6;var u=s-r;if(u%2!=0)throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+t;var d,m,p,x=u/2,f=0,g=0;return x>0&&(d=1e5/Math.pow(10,x),m=t.substring(r,r+x),f=parseFloat(m)*d,p=t.substring(r+x),g=parseFloat(p)*d),{easting:f+l,northing:g+c,zoneLetter:h,zoneNumber:n,accuracy:d}}function Qt(t){var e;switch(t){case"C":e=11e5;break;case"D":e=2e6;break;case"E":e=28e5;break;case"F":e=37e5;break;case"G":e=46e5;break;case"H":e=55e5;break;case"J":e=64e5;break;case"K":e=73e5;break;case"L":e=82e5;break;case"M":e=91e5;break;case"N":e=0;break;case"P":e=8e5;break;case"Q":e=17e5;break;case"R":e=26e5;break;case"S":e=35e5;break;case"T":e=44e5;break;case"U":e=53e5;break;case"V":e=62e5;break;case"W":e=7e6;break;case"X":e=79e5;break;default:e=-1}if(e>=0)return e;throw"Invalid zone letter: "+t}function Xt(t,e,s){if(!(this instanceof Xt))return new Xt(t,e,s);if(Array.isArray(t))this.x=t[0],this.y=t[1],this.z=t[2]||0;else if("object"==typeof t)this.x=t.x,this.y=t.y,this.z=t.z||0;else if("string"==typeof t&&void 0===e){var i=t.split(",");this.x=parseFloat(i[0],10),this.y=parseFloat(i[1],10),this.z=parseFloat(i[2],10)||0}else this.x=t,this.y=e,this.z=s||0;console.warn("proj4.Point will be removed in version 3, use proj4.toPoint")}Xt.fromMGRS=function(t){return new Xt(qt(t))},Xt.prototype.toMGRS=function(t){return Ht([this.x,this.y],t)};var Zt=Xt,Yt=1,Kt=.25,Jt=.046875,$t=.01953125,te=.01068115234375,ee=.75,se=.46875,ie=.013020833333333334,ae=.007120768229166667,re=.3645833333333333,ne=.005696614583333333,he=.3076171875;function oe(t){var e=[];e[0]=Yt-t*(Kt+t*(Jt+t*($t+t*te))),e[1]=t*(ee-t*(Jt+t*($t+t*te)));var s=t*t;return e[2]=s*(se-t*(ie+t*ae)),s*=t,e[3]=s*(re-t*ne),e[4]=s*t*he,e}function le(t,e,s,i){return s*=e,e*=e,i[0]*t-s*(i[1]+e*(i[2]+e*(i[3]+e*i[4])))}var ce=20;function ue(t,e,s){for(var i=1/(1-e),a=t,r=ce;r;--r){var n=Math.sin(a),h=1-e*n*n;if(a-=h=(le(a,n,Math.cos(a),s)-t)*(h*Math.sqrt(h))*i,Math.abs(h)<m)return a}return a}var de={init:function(){this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.es&&(this.en=oe(this.es),this.ml0=le(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},forward:function(t){var e,s,i,a=t.x,r=t.y,n=W(a-this.long0),h=Math.sin(r),o=Math.cos(r);if(this.es){var l=o*n,c=Math.pow(l,2),u=this.ep2*Math.pow(o,2),d=Math.pow(u,2),p=Math.abs(o)>m?Math.tan(r):0,x=Math.pow(p,2),f=Math.pow(x,2);e=1-this.es*Math.pow(h,2),l/=Math.sqrt(e);var g=le(r,h,o,this.en);s=this.a*(this.k0*l*(1+c/6*(1-x+u+c/20*(5-18*x+f+14*u-58*x*u+c/42*(61+179*f-f*x-479*x)))))+this.x0,i=this.a*(this.k0*(g-this.ml0+h*n*l/2*(1+c/12*(5-x+9*u+4*d+c/30*(61+f-58*x+270*u-330*x*u+c/56*(1385+543*f-f*x-3111*x))))))+this.y0}else{var M=o*Math.sin(n);if(Math.abs(Math.abs(M)-1)<m)return 93;if(s=.5*this.a*this.k0*Math.log((1+M)/(1-M))+this.x0,i=o*Math.cos(n)/Math.sqrt(1-Math.pow(M,2)),(M=Math.abs(i))>=1){if(M-1>m)return 93;i=0}else i=Math.acos(i);r<0&&(i=-i),i=this.a*this.k0*(i-this.lat0)+this.y0}return t.x=s,t.y=i,t},inverse:function(t){var e,s,i,a,r=(t.x-this.x0)*(1/this.a),n=(t.y-this.y0)*(1/this.a);if(this.es)if(s=ue(e=this.ml0+n/this.k0,this.es,this.en),Math.abs(s)<l){var h=Math.sin(s),o=Math.cos(s),c=Math.abs(o)>m?Math.tan(s):0,u=this.ep2*Math.pow(o,2),d=Math.pow(u,2),p=Math.pow(c,2),x=Math.pow(p,2);e=1-this.es*Math.pow(h,2);var f=r*Math.sqrt(e)/this.k0,g=Math.pow(f,2);i=s-(e*=c)*g/(1-this.es)*.5*(1-g/12*(5+3*p-9*u*p+u-4*d-g/30*(61+90*p-252*u*p+45*x+46*u-g/56*(1385+3633*p+4095*x+1574*x*p)))),a=W(this.long0+f*(1-g/6*(1+2*p+u-g/20*(5+28*p+24*x+8*u*p+6*u-g/42*(61+662*p+1320*x+720*x*p))))/o)}else i=l*G(n),a=0;else{var M=Math.exp(r/this.k0),y=.5*(M-1/M),b=this.lat0+n/this.k0,w=Math.cos(b);e=Math.sqrt((1-Math.pow(w,2))/(1+Math.pow(y,2))),i=Math.asin(e),n<0&&(i=-i),a=0===y&&0===w?0:W(Math.atan2(y,w)+this.long0)}return t.x=a,t.y=i,t},names:["Fast_Transverse_Mercator","Fast Transverse Mercator"]};function me(t){var e=Math.exp(t);return e=(e-1/e)/2}function pe(t,e){t=Math.abs(t),e=Math.abs(e);var s=Math.max(t,e),i=Math.min(t,e)/(s||1);return s*Math.sqrt(1+Math.pow(i,2))}function xe(t){var e=Math.abs(t);return e=function(t){var e=1+t,s=e-1;return 0===s?t:t*Math.log(e)/s}(e*(1+e/(pe(1,e)+1))),t<0?-e:e}function fe(t,e){for(var s,i=2*Math.cos(2*e),a=t.length-1,r=t[a],n=0;--a>=0;)s=i*r-n+t[a],n=r,r=s;return e+s*Math.sin(2*e)}function ge(t,e,s){for(var i,a,r=Math.sin(e),n=Math.cos(e),h=me(s),o=function(t){var e=Math.exp(t);return(e+1/e)/2}(s),l=2*n*o,c=-2*r*h,u=t.length-1,d=t[u],m=0,p=0,x=0;--u>=0;)i=p,a=m,d=l*(p=d)-i-c*(m=x)+t[u],x=c*p-a+l*m;return[(l=r*o)*d-(c=n*h)*x,l*x+c*d]}var Me={init:function(){if(!this.approx&&(isNaN(this.es)||this.es<=0))throw new Error('Incorrect elliptical usage. Try using the +approx option in the proj string, or PROJECTION["Fast_Transverse_Mercator"] in the WKT.');this.approx&&(de.init.apply(this),this.forward=de.forward,this.inverse=de.inverse),this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.cgb=[],this.cbg=[],this.utg=[],this.gtu=[];var t=this.es/(1+Math.sqrt(1-this.es)),e=t/(2-t),s=e;this.cgb[0]=e*(2+e*(-2/3+e*(e*(116/45+e*(26/45+e*(-2854/675)))-2))),this.cbg[0]=e*(e*(2/3+e*(4/3+e*(-82/45+e*(32/45+e*(4642/4725)))))-2),s*=e,this.cgb[1]=s*(7/3+e*(e*(-227/45+e*(2704/315+e*(2323/945)))-1.6)),this.cbg[1]=s*(5/3+e*(-16/15+e*(-13/9+e*(904/315+e*(-1522/945))))),s*=e,this.cgb[2]=s*(56/15+e*(-136/35+e*(-1262/105+e*(73814/2835)))),this.cbg[2]=s*(-26/15+e*(34/21+e*(1.6+e*(-12686/2835)))),s*=e,this.cgb[3]=s*(4279/630+e*(-332/35+e*(-399572/14175))),this.cbg[3]=s*(1237/630+e*(e*(-24832/14175)-2.4)),s*=e,this.cgb[4]=s*(4174/315+e*(-144838/6237)),this.cbg[4]=s*(-734/315+e*(109598/31185)),s*=e,this.cgb[5]=s*(601676/22275),this.cbg[5]=s*(444337/155925),s=Math.pow(e,2),this.Qn=this.k0/(1+e)*(1+s*(1/4+s*(1/64+s/256))),this.utg[0]=e*(e*(2/3+e*(-37/96+e*(1/360+e*(81/512+e*(-96199/604800)))))-.5),this.gtu[0]=e*(.5+e*(-2/3+e*(5/16+e*(41/180+e*(-127/288+e*(7891/37800)))))),this.utg[1]=s*(-1/48+e*(-1/15+e*(437/1440+e*(-46/105+e*(1118711/3870720))))),this.gtu[1]=s*(13/48+e*(e*(557/1440+e*(281/630+e*(-1983433/1935360)))-.6)),s*=e,this.utg[2]=s*(-17/480+e*(37/840+e*(209/4480+e*(-5569/90720)))),this.gtu[2]=s*(61/240+e*(-103/140+e*(15061/26880+e*(167603/181440)))),s*=e,this.utg[3]=s*(-4397/161280+e*(11/504+e*(830251/7257600))),this.gtu[3]=s*(49561/161280+e*(-179/168+e*(6601661/7257600))),s*=e,this.utg[4]=s*(-4583/161280+e*(108847/3991680)),this.gtu[4]=s*(34729/80640+e*(-3418889/1995840)),s*=e,this.utg[5]=s*(-20648693/638668800),this.gtu[5]=.6650675310896665*s;var i=fe(this.cbg,this.lat0);this.Zb=-this.Qn*(i+function(t,e){for(var s,i=2*Math.cos(e),a=t.length-1,r=t[a],n=0;--a>=0;)s=i*r-n+t[a],n=r,r=s;return Math.sin(e)*s}(this.gtu,2*i))},forward:function(t){var e=W(t.x-this.long0),s=t.y;s=fe(this.cbg,s);var i=Math.sin(s),a=Math.cos(s),r=Math.sin(e),n=Math.cos(e);s=Math.atan2(i,n*a),e=Math.atan2(r*a,pe(i,a*n)),e=xe(Math.tan(e));var h,o,l=ge(this.gtu,2*s,2*e);return s+=l[0],e+=l[1],Math.abs(e)<=2.623395162778?(h=this.a*(this.Qn*e)+this.x0,o=this.a*(this.Qn*s+this.Zb)+this.y0):(h=1/0,o=1/0),t.x=h,t.y=o,t},inverse:function(t){var e,s,i=(t.x-this.x0)*(1/this.a),a=(t.y-this.y0)*(1/this.a);if(a=(a-this.Zb)/this.Qn,i/=this.Qn,Math.abs(i)<=2.623395162778){var r=ge(this.utg,2*a,2*i);a+=r[0],i+=r[1],i=Math.atan(me(i));var n=Math.sin(a),h=Math.cos(a),o=Math.sin(i),l=Math.cos(i);a=Math.atan2(n*l,pe(o,l*h)),e=W((i=Math.atan2(o,l*h))+this.long0),s=fe(this.cgb,a)}else e=1/0,s=1/0;return t.x=e,t.y=s,t},names:["Extended_Transverse_Mercator","Extended Transverse Mercator","etmerc","Transverse_Mercator","Transverse Mercator","Gauss Kruger","Gauss_Kruger","tmerc"]};var ye={init:function(){var t=function(t,e){if(void 0===t){if((t=Math.floor(30*(W(e)+Math.PI)/Math.PI)+1)<0)return 0;if(t>60)return 60}return t}(this.zone,this.long0);if(void 0===t)throw new Error("unknown utm zone");this.lat0=0,this.long0=(6*Math.abs(t)-183)*p,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,Me.init.apply(this),this.forward=Me.forward,this.inverse=Me.inverse},names:["Universal Transverse Mercator System","utm"],dependsOn:"etmerc"};function be(t,e){return Math.pow((1-t)/(1+t),e)}var we={init:function(){var t=Math.sin(this.lat0),e=Math.cos(this.lat0);e*=e,this.rc=Math.sqrt(1-this.es)/(1-this.es*t*t),this.C=Math.sqrt(1+this.es*e*e/(1-this.es)),this.phic0=Math.asin(t/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+f)/(Math.pow(Math.tan(.5*this.lat0+f),this.C)*be(this.e*t,this.ratexp))},forward:function(t){var e=t.x,s=t.y;return t.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*s+f),this.C)*be(this.e*Math.sin(s),this.ratexp))-l,t.x=this.C*e,t},inverse:function(t){for(var e=t.x/this.C,s=t.y,i=Math.pow(Math.tan(.5*s+f)/this.K,1/this.C),a=20;a>0&&(s=2*Math.atan(i*be(this.e*Math.sin(t.y),-.5*this.e))-l,!(Math.abs(s-t.y)<1e-14));--a)t.y=s;return a?(t.x=e,t.y=s,t):null},names:["gauss"]};var ve={init:function(){we.init.apply(this),this.rc&&(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"))},forward:function(t){var e,s,i,a;return t.x=W(t.x-this.long0),we.forward.apply(this,[t]),e=Math.sin(t.y),s=Math.cos(t.y),i=Math.cos(t.x),a=this.k0*this.R2/(1+this.sinc0*e+this.cosc0*s*i),t.x=a*s*Math.sin(t.x),t.y=a*(this.cosc0*e-this.sinc0*s*i),t.x=this.a*t.x+this.x0,t.y=this.a*t.y+this.y0,t},inverse:function(t){var e,s,i,a,r;if(t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,t.x/=this.k0,t.y/=this.k0,r=pe(t.x,t.y)){var n=2*Math.atan2(r,this.R2);e=Math.sin(n),s=Math.cos(n),a=Math.asin(s*this.sinc0+t.y*e*this.cosc0/r),i=Math.atan2(t.x*e,r*this.cosc0*s-t.y*this.sinc0*e)}else a=this.phic0,i=0;return t.x=i,t.y=a,we.inverse.apply(this,[t]),t.x=W(t.x+this.long0),t},names:["Stereographic_North_Pole","Oblique_Stereographic","sterea","Oblique Stereographic Alternative","Double_Stereographic"]};var Se={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.coslat0=Math.cos(this.lat0),this.sinlat0=Math.sin(this.lat0),this.sphere?1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=m&&(this.k0=.5*(1+G(this.lat0)*Math.sin(this.lat_ts))):(Math.abs(this.coslat0)<=m&&(this.lat0>0?this.con=1:this.con=-1),this.cons=Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)),1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=m&&Math.abs(Math.cos(this.lat_ts))>m&&(this.k0=.5*this.cons*j(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts))/Q(this.e,this.con*this.lat_ts,this.con*Math.sin(this.lat_ts))),this.ms1=j(this.e,this.sinlat0,this.coslat0),this.X0=2*Math.atan(this.ssfn_(this.lat0,this.sinlat0,this.e))-l,this.cosX0=Math.cos(this.X0),this.sinX0=Math.sin(this.X0))},forward:function(t){var e,s,i,a,r,n,h=t.x,o=t.y,c=Math.sin(o),u=Math.cos(o),d=W(h-this.long0);return Math.abs(Math.abs(h-this.long0)-Math.PI)<=m&&Math.abs(o+this.lat0)<=m?(t.x=NaN,t.y=NaN,t):this.sphere?(e=2*this.k0/(1+this.sinlat0*c+this.coslat0*u*Math.cos(d)),t.x=this.a*e*u*Math.sin(d)+this.x0,t.y=this.a*e*(this.coslat0*c-this.sinlat0*u*Math.cos(d))+this.y0,t):(s=2*Math.atan(this.ssfn_(o,c,this.e))-l,a=Math.cos(s),i=Math.sin(s),Math.abs(this.coslat0)<=m?(r=Q(this.e,o*this.con,this.con*c),n=2*this.a*this.k0*r/this.cons,t.x=this.x0+n*Math.sin(h-this.long0),t.y=this.y0-this.con*n*Math.cos(h-this.long0),t):(Math.abs(this.sinlat0)<m?(e=2*this.a*this.k0/(1+a*Math.cos(d)),t.y=e*i):(e=2*this.a*this.k0*this.ms1/(this.cosX0*(1+this.sinX0*i+this.cosX0*a*Math.cos(d))),t.y=e*(this.cosX0*i-this.sinX0*a*Math.cos(d))+this.y0),t.x=e*a*Math.sin(d)+this.x0,t))},inverse:function(t){var e,s,i,a,r;t.x-=this.x0,t.y-=this.y0;var n=Math.sqrt(t.x*t.x+t.y*t.y);if(this.sphere){var h=2*Math.atan(n/(2*this.a*this.k0));return e=this.long0,s=this.lat0,n<=m?(t.x=e,t.y=s,t):(s=Math.asin(Math.cos(h)*this.sinlat0+t.y*Math.sin(h)*this.coslat0/n),e=Math.abs(this.coslat0)<m?this.lat0>0?W(this.long0+Math.atan2(t.x,-1*t.y)):W(this.long0+Math.atan2(t.x,t.y)):W(this.long0+Math.atan2(t.x*Math.sin(h),n*this.coslat0*Math.cos(h)-t.y*this.sinlat0*Math.sin(h))),t.x=e,t.y=s,t)}if(Math.abs(this.coslat0)<=m){if(n<=m)return s=this.lat0,e=this.long0,t.x=e,t.y=s,t;t.x*=this.con,t.y*=this.con,i=n*this.cons/(2*this.a*this.k0),s=this.con*X(this.e,i),e=this.con*W(this.con*this.long0+Math.atan2(t.x,-1*t.y))}else a=2*Math.atan(n*this.cosX0/(2*this.a*this.k0*this.ms1)),e=this.long0,n<=m?r=this.X0:(r=Math.asin(Math.cos(a)*this.sinX0+t.y*Math.sin(a)*this.cosX0/n),e=W(this.long0+Math.atan2(t.x*Math.sin(a),n*this.cosX0*Math.cos(a)-t.y*this.sinX0*Math.sin(a)))),s=-1*X(this.e,Math.tan(.5*(l+r)));return t.x=e,t.y=s,t},names:["stere","Stereographic_South_Pole","Polar Stereographic (variant B)","Polar_Stereographic"],ssfn_:function(t,e,s){return e*=s,Math.tan(.5*(l+t))*Math.pow((1-e)/(1+e),.5*s)}};var _e={init:function(){var t=this.lat0;this.lambda0=this.long0;var e=Math.sin(t),s=this.a,i=1/this.rf,a=2*i-Math.pow(i,2),r=this.e=Math.sqrt(a);this.R=this.k0*s*Math.sqrt(1-a)/(1-a*Math.pow(e,2)),this.alpha=Math.sqrt(1+a/(1-a)*Math.pow(Math.cos(t),4)),this.b0=Math.asin(e/this.alpha);var n=Math.log(Math.tan(Math.PI/4+this.b0/2)),h=Math.log(Math.tan(Math.PI/4+t/2)),o=Math.log((1+r*e)/(1-r*e));this.K=n-this.alpha*h+this.alpha*r/2*o},forward:function(t){var e=Math.log(Math.tan(Math.PI/4-t.y/2)),s=this.e/2*Math.log((1+this.e*Math.sin(t.y))/(1-this.e*Math.sin(t.y))),i=-this.alpha*(e+s)+this.K,a=2*(Math.atan(Math.exp(i))-Math.PI/4),r=this.alpha*(t.x-this.lambda0),n=Math.atan(Math.sin(r)/(Math.sin(this.b0)*Math.tan(a)+Math.cos(this.b0)*Math.cos(r))),h=Math.asin(Math.cos(this.b0)*Math.sin(a)-Math.sin(this.b0)*Math.cos(a)*Math.cos(r));return t.y=this.R/2*Math.log((1+Math.sin(h))/(1-Math.sin(h)))+this.y0,t.x=this.R*n+this.x0,t},inverse:function(t){for(var e=t.x-this.x0,s=t.y-this.y0,i=e/this.R,a=2*(Math.atan(Math.exp(s/this.R))-Math.PI/4),r=Math.asin(Math.cos(this.b0)*Math.sin(a)+Math.sin(this.b0)*Math.cos(a)*Math.cos(i)),n=Math.atan(Math.sin(i)/(Math.cos(this.b0)*Math.cos(i)-Math.sin(this.b0)*Math.tan(a))),h=this.lambda0+n/this.alpha,o=0,l=r,c=-1e3,u=0;Math.abs(l-c)>1e-7;){if(++u>20)return;o=1/this.alpha*(Math.log(Math.tan(Math.PI/4+r/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(l))/2)),c=l,l=2*Math.atan(Math.exp(o))-Math.PI/2}return t.x=h,t.y=l,t},names:["somerc"]},Ce=1e-7;var Te={init:function(){var t,e,s,i,a,r,n,h,o,c,u,d,x,M=0,y=0,b=0,w=0,v=0,S=0,_=0;this.no_off=(x="object"==typeof(d=this).PROJECTION?Object.keys(d.PROJECTION)[0]:d.PROJECTION,"no_uoff"in d||"no_off"in d||-1!==["Hotine_Oblique_Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin"].indexOf(x)),this.no_rot="no_rot"in this;var C=!1;"alpha"in this&&(C=!0);var T=!1;if("rectified_grid_angle"in this&&(T=!0),C&&(_=this.alpha),T&&(M=this.rectified_grid_angle*p),C||T)y=this.longc;else if(b=this.long1,v=this.lat1,w=this.long2,S=this.lat2,Math.abs(v-S)<=Ce||(t=Math.abs(v))<=Ce||Math.abs(t-l)<=Ce||Math.abs(Math.abs(this.lat0)-l)<=Ce||Math.abs(Math.abs(S)-l)<=Ce)throw new Error;var D=1-this.es;e=Math.sqrt(D),Math.abs(this.lat0)>m?(h=Math.sin(this.lat0),s=Math.cos(this.lat0),t=1-this.es*h*h,this.B=s*s,this.B=Math.sqrt(1+this.es*this.B*this.B/D),this.A=this.B*this.k0*e/t,(a=(i=this.B*e/(s*Math.sqrt(t)))*i-1)<=0?a=0:(a=Math.sqrt(a),this.lat0<0&&(a=-a)),this.E=a+=i,this.E*=Math.pow(Q(this.e,this.lat0,h),this.B)):(this.B=1/e,this.A=this.k0,this.E=i=a=1),C||T?(C?(u=Math.asin(Math.sin(_)/i),T||(M=_)):(u=M,_=Math.asin(i*Math.sin(u))),this.lam0=y-Math.asin(.5*(a-1/a)*Math.tan(u))/this.B):(r=Math.pow(Q(this.e,v,Math.sin(v)),this.B),n=Math.pow(Q(this.e,S,Math.sin(S)),this.B),a=this.E/r,o=(n-r)/(n+r),c=((c=this.E*this.E)-n*r)/(c+n*r),(t=b-w)<-Math.pi?w-=g:t>Math.pi&&(w+=g),this.lam0=W(.5*(b+w)-Math.atan(c*Math.tan(.5*this.B*(b-w))/o)/this.B),u=Math.atan(2*Math.sin(this.B*W(b-this.lam0))/(a-1/a)),M=_=Math.asin(i*Math.sin(u))),this.singam=Math.sin(u),this.cosgam=Math.cos(u),this.sinrot=Math.sin(M),this.cosrot=Math.cos(M),this.rB=1/this.B,this.ArB=this.A*this.rB,this.BrA=1/this.ArB,this.A,this.B,this.no_off?this.u_0=0:(this.u_0=Math.abs(this.ArB*Math.atan(Math.sqrt(i*i-1)/Math.cos(_))),this.lat0<0&&(this.u_0=-this.u_0)),a=.5*u,this.v_pole_n=this.ArB*Math.log(Math.tan(f-a)),this.v_pole_s=this.ArB*Math.log(Math.tan(f+a))},forward:function(t){var e,s,i,a,r,n,h,o,c={};if(t.x=t.x-this.lam0,Math.abs(Math.abs(t.y)-l)>m){if(e=.5*((r=this.E/Math.pow(Q(this.e,t.y,Math.sin(t.y)),this.B))-(n=1/r)),s=.5*(r+n),a=Math.sin(this.B*t.x),i=(e*this.singam-a*this.cosgam)/s,Math.abs(Math.abs(i)-1)<m)throw new Error;o=.5*this.ArB*Math.log((1-i)/(1+i)),n=Math.cos(this.B*t.x),h=Math.abs(n)<Ce?this.A*t.x:this.ArB*Math.atan2(e*this.cosgam+a*this.singam,n)}else o=t.y>0?this.v_pole_n:this.v_pole_s,h=this.ArB*t.y;return this.no_rot?(c.x=h,c.y=o):(h-=this.u_0,c.x=o*this.cosrot+h*this.sinrot,c.y=h*this.cosrot-o*this.sinrot),c.x=this.a*c.x+this.x0,c.y=this.a*c.y+this.y0,c},inverse:function(t){var e,s,i,a,r,n,h,o={};if(t.x=(t.x-this.x0)*(1/this.a),t.y=(t.y-this.y0)*(1/this.a),this.no_rot?(s=t.y,e=t.x):(s=t.x*this.cosrot-t.y*this.sinrot,e=t.y*this.cosrot+t.x*this.sinrot+this.u_0),a=.5*((i=Math.exp(-this.BrA*s))-1/i),r=.5*(i+1/i),h=((n=Math.sin(this.BrA*e))*this.cosgam+a*this.singam)/r,Math.abs(Math.abs(h)-1)<m)o.x=0,o.y=h<0?-l:l;else{if(o.y=this.E/Math.sqrt((1+h)/(1-h)),o.y=X(this.e,Math.pow(o.y,1/this.B)),o.y===1/0)throw new Error;o.x=-this.rB*Math.atan2(a*this.cosgam-n*this.singam,Math.cos(this.BrA*e))}return o.x+=this.lam0,o},names:["Hotine_Oblique_Mercator","Hotine Oblique Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin","Hotine_Oblique_Mercator_Two_Point_Natural_Origin","Hotine_Oblique_Mercator_Azimuth_Center","Oblique_Mercator","omerc"]};var De={init:function(){if(this.lat2||(this.lat2=this.lat1),this.k0||(this.k0=1),this.x0=this.x0||0,this.y0=this.y0||0,!(Math.abs(this.lat1+this.lat2)<m)){var t=this.b/this.a;this.e=Math.sqrt(1-t*t);var e=Math.sin(this.lat1),s=Math.cos(this.lat1),i=j(this.e,e,s),a=Q(this.e,this.lat1,e),r=Math.sin(this.lat2),n=Math.cos(this.lat2),h=j(this.e,r,n),o=Q(this.e,this.lat2,r),l=Q(this.e,this.lat0,Math.sin(this.lat0));Math.abs(this.lat1-this.lat2)>m?this.ns=Math.log(i/h)/Math.log(a/o):this.ns=e,isNaN(this.ns)&&(this.ns=e),this.f0=i/(this.ns*Math.pow(a,this.ns)),this.rh=this.a*this.f0*Math.pow(l,this.ns),this.title||(this.title="Lambert Conformal Conic")}},forward:function(t){var e=t.x,s=t.y;Math.abs(2*Math.abs(s)-Math.PI)<=m&&(s=G(s)*(l-2*m));var i,a,r=Math.abs(Math.abs(s)-l);if(r>m)i=Q(this.e,s,Math.sin(s)),a=this.a*this.f0*Math.pow(i,this.ns);else{if((r=s*this.ns)<=0)return null;a=0}var n=this.ns*W(e-this.long0);return t.x=this.k0*(a*Math.sin(n))+this.x0,t.y=this.k0*(this.rh-a*Math.cos(n))+this.y0,t},inverse:function(t){var e,s,i,a,r,n=(t.x-this.x0)/this.k0,h=this.rh-(t.y-this.y0)/this.k0;this.ns>0?(e=Math.sqrt(n*n+h*h),s=1):(e=-Math.sqrt(n*n+h*h),s=-1);var o=0;if(0!==e&&(o=Math.atan2(s*n,s*h)),0!==e||this.ns>0){if(s=1/this.ns,i=Math.pow(e/(this.a*this.f0),s),-9999===(a=X(this.e,i)))return null}else a=-l;return r=W(o/this.ns+this.long0),t.x=r,t.y=a,t},names:["Lambert Tangential Conformal Conic Projection","Lambert_Conformal_Conic","Lambert_Conformal_Conic_1SP","Lambert_Conformal_Conic_2SP","lcc","Lambert Conic Conformal (1SP)","Lambert Conic Conformal (2SP)"]};var Pe={init:function(){this.a=6377397.155,this.es=.006674372230614,this.e=Math.sqrt(this.es),this.lat0||(this.lat0=.863937979737193),this.long0||(this.long0=.4334234309119251),this.k0||(this.k0=.9999),this.s45=.785398163397448,this.s90=2*this.s45,this.fi0=this.lat0,this.e2=this.es,this.e=Math.sqrt(this.e2),this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2)),this.uq=1.04216856380474,this.u0=Math.asin(Math.sin(this.fi0)/this.alfa),this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2),this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g,this.k1=this.k0,this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2)),this.s0=1.37008346281555,this.n=Math.sin(this.s0),this.ro0=this.k1*this.n0/Math.tan(this.s0),this.ad=this.s90-this.uq},forward:function(t){var e,s,i,a,r,n,h,o=t.x,l=t.y,c=W(o-this.long0);return e=Math.pow((1+this.e*Math.sin(l))/(1-this.e*Math.sin(l)),this.alfa*this.e/2),s=2*(Math.atan(this.k*Math.pow(Math.tan(l/2+this.s45),this.alfa)/e)-this.s45),i=-c*this.alfa,a=Math.asin(Math.cos(this.ad)*Math.sin(s)+Math.sin(this.ad)*Math.cos(s)*Math.cos(i)),r=Math.asin(Math.cos(s)*Math.sin(i)/Math.cos(a)),n=this.n*r,h=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(a/2+this.s45),this.n),t.y=h*Math.cos(n)/1,t.x=h*Math.sin(n)/1,this.czech||(t.y*=-1,t.x*=-1),t},inverse:function(t){var e,s,i,a,r,n,h,o=t.x;t.x=t.y,t.y=o,this.czech||(t.y*=-1,t.x*=-1),r=Math.sqrt(t.x*t.x+t.y*t.y),a=Math.atan2(t.y,t.x)/Math.sin(this.s0),i=2*(Math.atan(Math.pow(this.ro0/r,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45),e=Math.asin(Math.cos(this.ad)*Math.sin(i)-Math.sin(this.ad)*Math.cos(i)*Math.cos(a)),s=Math.asin(Math.cos(i)*Math.sin(a)/Math.cos(e)),t.x=this.long0-s/this.alfa,n=e,h=0;var l=0;do{t.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(e/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(n))/(1-this.e*Math.sin(n)),this.e/2))-this.s45),Math.abs(n-t.y)<1e-10&&(h=1),n=t.y,l+=1}while(0===h&&l<15);return l>=15?null:t},names:["Krovak","krovak"]};function ze(t,e,s,i,a){return t*a-e*Math.sin(2*a)+s*Math.sin(4*a)-i*Math.sin(6*a)}function Ee(t){return 1-.25*t*(1+t/16*(3+1.25*t))}function Ae(t){return.375*t*(1+.25*t*(1+.46875*t))}function Ie(t){return.05859375*t*t*(1+.75*t)}function Fe(t){return t*t*t*(35/3072)}function Re(t,e,s){var i=e*s;return t/Math.sqrt(1-i*i)}function ke(t){return Math.abs(t)<l?t:t-G(t)*Math.PI}function Ne(t,e,s,i,a){var r,n;r=t/e;for(var h=0;h<15;h++)if(r+=n=(t-(e*r-s*Math.sin(2*r)+i*Math.sin(4*r)-a*Math.sin(6*r)))/(e-2*s*Math.cos(2*r)+4*i*Math.cos(4*r)-6*a*Math.cos(6*r)),Math.abs(n)<=1e-10)return r;return NaN}var Le={init:function(){this.sphere||(this.e0=Ee(this.es),this.e1=Ae(this.es),this.e2=Ie(this.es),this.e3=Fe(this.es),this.ml0=this.a*ze(this.e0,this.e1,this.e2,this.e3,this.lat0))},forward:function(t){var e,s,i=t.x,a=t.y;if(i=W(i-this.long0),this.sphere)e=this.a*Math.asin(Math.cos(a)*Math.sin(i)),s=this.a*(Math.atan2(Math.tan(a),Math.cos(i))-this.lat0);else{var r=Math.sin(a),n=Math.cos(a),h=Re(this.a,this.e,r),o=Math.tan(a)*Math.tan(a),l=i*Math.cos(a),c=l*l,u=this.es*n*n/(1-this.es);e=h*l*(1-c*o*(1/6-(8-o+8*u)*c/120)),s=this.a*ze(this.e0,this.e1,this.e2,this.e3,a)-this.ml0+h*r/n*c*(.5+(5-o+6*u)*c/24)}return t.x=e+this.x0,t.y=s+this.y0,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var e,s,i=t.x/this.a,a=t.y/this.a;if(this.sphere){var r=a+this.lat0;e=Math.asin(Math.sin(r)*Math.cos(i)),s=Math.atan2(Math.tan(i),Math.cos(r))}else{var n=Ne(this.ml0/this.a+a,this.e0,this.e1,this.e2,this.e3);if(Math.abs(Math.abs(n)-l)<=m)return t.x=this.long0,t.y=l,a<0&&(t.y*=-1),t;var h=Re(this.a,this.e,Math.sin(n)),o=h*h*h/this.a/this.a*(1-this.es),c=Math.pow(Math.tan(n),2),u=i*this.a/h,d=u*u;e=n-h*Math.tan(n)/o*u*u*(.5-(1+3*c)*u*u/24),s=u*(1-d*(c/3+(1+3*c)*c*d/15))/Math.cos(n)}return t.x=W(s+this.long0),t.y=ke(e),t},names:["Cassini","Cassini_Soldner","cass"]};function Be(t,e){var s;return t>1e-7?(1-t*t)*(e/(1-(s=t*e)*s)-.5/t*Math.log((1-s)/(1+s))):2*e}var He=.3333333333333333,qe=.17222222222222222,Oe=.10257936507936508,Ue=.06388888888888888,Ve=.0664021164021164,je=.016415012942191543;var Ge={init:function(){var t,e=Math.abs(this.lat0);if(Math.abs(e-l)<m?this.mode=this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(e)<m?this.mode=this.EQUIT:this.mode=this.OBLIQ,this.es>0)switch(this.qp=Be(this.e,1),this.mmf=.5/(1-this.es),this.apa=function(t){var e,s=[];return s[0]=t*He,e=t*t,s[0]+=e*qe,s[1]=e*Ue,e*=t,s[0]+=e*Oe,s[1]+=e*Ve,s[2]=e*je,s}(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),t=Math.sin(this.lat0),this.sinb1=Be(this.e,t)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*t*t)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}else this.mode===this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(t){var e,s,i,a,r,n,h,o,c,u,d=t.x,p=t.y;if(d=W(d-this.long0),this.sphere){if(r=Math.sin(p),u=Math.cos(p),i=Math.cos(d),this.mode===this.OBLIQ||this.mode===this.EQUIT){if((s=this.mode===this.EQUIT?1+u*i:1+this.sinph0*r+this.cosph0*u*i)<=m)return null;e=(s=Math.sqrt(2/s))*u*Math.sin(d),s*=this.mode===this.EQUIT?r:this.cosph0*r-this.sinph0*u*i}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(i=-i),Math.abs(p+this.lat0)<m)return null;s=f-.5*p,e=(s=2*(this.mode===this.S_POLE?Math.cos(s):Math.sin(s)))*Math.sin(d),s*=i}}else{switch(h=0,o=0,c=0,i=Math.cos(d),a=Math.sin(d),r=Math.sin(p),n=Be(this.e,r),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(h=n/this.qp,o=Math.sqrt(1-h*h)),this.mode){case this.OBLIQ:c=1+this.sinb1*h+this.cosb1*o*i;break;case this.EQUIT:c=1+o*i;break;case this.N_POLE:c=l+p,n=this.qp-n;break;case this.S_POLE:c=p-l,n=this.qp+n}if(Math.abs(c)<m)return null;switch(this.mode){case this.OBLIQ:case this.EQUIT:c=Math.sqrt(2/c),s=this.mode===this.OBLIQ?this.ymf*c*(this.cosb1*h-this.sinb1*o*i):(c=Math.sqrt(2/(1+o*i)))*h*this.ymf,e=this.xmf*c*o*a;break;case this.N_POLE:case this.S_POLE:n>=0?(e=(c=Math.sqrt(n))*a,s=i*(this.mode===this.S_POLE?c:-c)):e=s=0}}return t.x=this.a*e+this.x0,t.y=this.a*s+this.y0,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var e,s,i,a,r,n,h,o,c,u,d=t.x/this.a,p=t.y/this.a;if(this.sphere){var x,f=0,g=0;if((s=.5*(x=Math.sqrt(d*d+p*p)))>1)return null;switch(s=2*Math.asin(s),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(g=Math.sin(s),f=Math.cos(s)),this.mode){case this.EQUIT:s=Math.abs(x)<=m?0:Math.asin(p*g/x),d*=g,p=f*x;break;case this.OBLIQ:s=Math.abs(x)<=m?this.lat0:Math.asin(f*this.sinph0+p*g*this.cosph0/x),d*=g*this.cosph0,p=(f-Math.sin(s)*this.sinph0)*x;break;case this.N_POLE:p=-p,s=l-s;break;case this.S_POLE:s-=l}e=0!==p||this.mode!==this.EQUIT&&this.mode!==this.OBLIQ?Math.atan2(d,p):0}else{if(h=0,this.mode===this.OBLIQ||this.mode===this.EQUIT){if(d/=this.dd,p*=this.dd,(n=Math.sqrt(d*d+p*p))<m)return t.x=this.long0,t.y=this.lat0,t;a=2*Math.asin(.5*n/this.rq),i=Math.cos(a),d*=a=Math.sin(a),this.mode===this.OBLIQ?(h=i*this.sinb1+p*a*this.cosb1/n,r=this.qp*h,p=n*this.cosb1*i-p*this.sinb1*a):(h=p*a/n,r=this.qp*h,p=n*i)}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(p=-p),!(r=d*d+p*p))return t.x=this.long0,t.y=this.lat0,t;h=1-r/this.qp,this.mode===this.S_POLE&&(h=-h)}e=Math.atan2(d,p),o=Math.asin(h),c=this.apa,u=o+o,s=o+c[0]*Math.sin(u)+c[1]*Math.sin(u+u)+c[2]*Math.sin(u+u+u)}return t.x=W(this.long0+e),t.y=s,t},names:["Lambert Azimuthal Equal Area","Lambert_Azimuthal_Equal_Area","laea"],S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4};function We(t){return Math.abs(t)>1&&(t=t>1?1:-1),Math.asin(t)}var Qe={init:function(){Math.abs(this.lat1+this.lat2)<m||(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=j(this.e3,this.sin_po,this.cos_po),this.qs1=Be(this.e3,this.sin_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=j(this.e3,this.sin_po,this.cos_po),this.qs2=Be(this.e3,this.sin_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=Be(this.e3,this.sin_po),Math.abs(this.lat1-this.lat2)>m?this.ns0=(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.ns0=this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0)},forward:function(t){var e=t.x,s=t.y;this.sin_phi=Math.sin(s),this.cos_phi=Math.cos(s);var i=Be(this.e3,this.sin_phi),a=this.a*Math.sqrt(this.c-this.ns0*i)/this.ns0,r=this.ns0*W(e-this.long0),n=a*Math.sin(r)+this.x0,h=this.rh-a*Math.cos(r)+this.y0;return t.x=n,t.y=h,t},inverse:function(t){var e,s,i,a,r,n;return t.x-=this.x0,t.y=this.rh-t.y+this.y0,this.ns0>=0?(e=Math.sqrt(t.x*t.x+t.y*t.y),i=1):(e=-Math.sqrt(t.x*t.x+t.y*t.y),i=-1),a=0,0!==e&&(a=Math.atan2(i*t.x,i*t.y)),i=e*this.ns0/this.a,this.sphere?n=Math.asin((this.c-i*i)/(2*this.ns0)):(s=(this.c-i*i)/this.ns0,n=this.phi1z(this.e3,s)),r=W(a/this.ns0+this.long0),t.x=r,t.y=n,t},names:["Albers_Conic_Equal_Area","Albers","aea"],phi1z:function(t,e){var s,i,a,r,n=We(.5*e);if(t<m)return n;for(var h=t*t,o=1;o<=25;o++)if(n+=r=.5*(a=1-(i=t*(s=Math.sin(n)))*i)*a/Math.cos(n)*(e/(1-h)-s/a+.5/t*Math.log((1-i)/(1+i))),Math.abs(r)<=1e-7)return n;return null}};var Xe={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a,this.rc=1},forward:function(t){var e,s,i,a,r,n,h,o=t.x,l=t.y;return i=W(o-this.long0),e=Math.sin(l),s=Math.cos(l),a=Math.cos(i),(r=this.sin_p14*e+this.cos_p14*s*a)>0||Math.abs(r)<=m?(n=this.x0+1*this.a*s*Math.sin(i)/r,h=this.y0+1*this.a*(this.cos_p14*e-this.sin_p14*s*a)/r):(n=this.x0+this.infinity_dist*s*Math.sin(i),h=this.y0+this.infinity_dist*(this.cos_p14*e-this.sin_p14*s*a)),t.x=n,t.y=h,t},inverse:function(t){var e,s,i,a,r,n;return t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,t.x/=this.k0,t.y/=this.k0,(e=Math.sqrt(t.x*t.x+t.y*t.y))?(a=Math.atan2(e,this.rc),s=Math.sin(a),n=We((i=Math.cos(a))*this.sin_p14+t.y*s*this.cos_p14/e),r=Math.atan2(t.x*s,e*this.cos_p14*i-t.y*this.sin_p14*s),r=W(this.long0+r)):(n=this.phic0,r=0),t.x=r,t.y=n,t},names:["gnom"]};var Ze={init:function(){this.sphere||(this.k0=j(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(t){var e,s,i=t.x,a=t.y,r=W(i-this.long0);if(this.sphere)e=this.x0+this.a*r*Math.cos(this.lat_ts),s=this.y0+this.a*Math.sin(a)/Math.cos(this.lat_ts);else{var n=Be(this.e,Math.sin(a));e=this.x0+this.a*this.k0*r,s=this.y0+this.a*n*.5/this.k0}return t.x=e,t.y=s,t},inverse:function(t){var e,s;return t.x-=this.x0,t.y-=this.y0,this.sphere?(e=W(this.long0+t.x/this.a/Math.cos(this.lat_ts)),s=Math.asin(t.y/this.a*Math.cos(this.lat_ts))):(s=function(t,e){var s=1-(1-t*t)/(2*t)*Math.log((1-t)/(1+t));if(Math.abs(Math.abs(e)-s)<1e-6)return e<0?-1*l:l;for(var i,a,r,n,h=Math.asin(.5*e),o=0;o<30;o++)if(a=Math.sin(h),r=Math.cos(h),n=t*a,h+=i=Math.pow(1-n*n,2)/(2*r)*(e/(1-t*t)-a/(1-n*n)+.5/t*Math.log((1-n)/(1+n))),Math.abs(i)<=1e-10)return h;return NaN}(this.e,2*t.y*this.k0/this.a),e=W(this.long0+t.x/(this.a*this.k0))),t.x=e,t.y=s,t},names:["cea"]};var Ye={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Equidistant Cylindrical (Plate Carre)",this.rc=Math.cos(this.lat_ts)},forward:function(t){var e=t.x,s=t.y,i=W(e-this.long0),a=ke(s-this.lat0);return t.x=this.x0+this.a*i*this.rc,t.y=this.y0+this.a*a,t},inverse:function(t){var e=t.x,s=t.y;return t.x=W(this.long0+(e-this.x0)/(this.a*this.rc)),t.y=ke(this.lat0+(s-this.y0)/this.a),t},names:["Equirectangular","Equidistant_Cylindrical","eqc"]};var Ke={init:function(){this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Ee(this.es),this.e1=Ae(this.es),this.e2=Ie(this.es),this.e3=Fe(this.es),this.ml0=this.a*ze(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(t){var e,s,i,a=t.x,r=t.y,n=W(a-this.long0);if(i=n*Math.sin(r),this.sphere)Math.abs(r)<=m?(e=this.a*n,s=-1*this.a*this.lat0):(e=this.a*Math.sin(i)/Math.tan(r),s=this.a*(ke(r-this.lat0)+(1-Math.cos(i))/Math.tan(r)));else if(Math.abs(r)<=m)e=this.a*n,s=-1*this.ml0;else{var h=Re(this.a,this.e,Math.sin(r))/Math.tan(r);e=h*Math.sin(i),s=this.a*ze(this.e0,this.e1,this.e2,this.e3,r)-this.ml0+h*(1-Math.cos(i))}return t.x=e+this.x0,t.y=s+this.y0,t},inverse:function(t){var e,s,i,a,r,n,h,o,l;if(i=t.x-this.x0,a=t.y-this.y0,this.sphere)if(Math.abs(a+this.a*this.lat0)<=m)e=W(i/this.a+this.long0),s=0;else{var c;for(n=this.lat0+a/this.a,h=i*i/this.a/this.a+n*n,o=n,r=20;r;--r)if(o+=l=-1*(n*(o*(c=Math.tan(o))+1)-o-.5*(o*o+h)*c)/((o-n)/c-1),Math.abs(l)<=m){s=o;break}e=W(this.long0+Math.asin(i*Math.tan(o)/this.a)/Math.sin(s))}else if(Math.abs(a+this.ml0)<=m)s=0,e=W(this.long0+i/this.a);else{var u,d,p,x,f;for(n=(this.ml0+a)/this.a,h=i*i/this.a/this.a+n*n,o=n,r=20;r;--r)if(f=this.e*Math.sin(o),u=Math.sqrt(1-f*f)*Math.tan(o),d=this.a*ze(this.e0,this.e1,this.e2,this.e3,o),p=this.e0-2*this.e1*Math.cos(2*o)+4*this.e2*Math.cos(4*o)-6*this.e3*Math.cos(6*o),o-=l=(n*(u*(x=d/this.a)+1)-x-.5*u*(x*x+h))/(this.es*Math.sin(2*o)*(x*x+h-2*n*x)/(4*u)+(n-x)*(u*p-2/Math.sin(2*o))-p),Math.abs(l)<=m){s=o;break}u=Math.sqrt(1-this.es*Math.pow(Math.sin(s),2))*Math.tan(s),e=W(this.long0+Math.asin(i*u/this.a)/Math.sin(s))}return t.x=e,t.y=s,t},names:["Polyconic","poly"]};var Je={init:function(){this.A=[],this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=[],this.B_im=[],this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=[],this.C_im=[],this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=[],this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(t){var e,s=t.x,i=t.y-this.lat0,a=s-this.long0,r=i/o*1e-5,n=a,h=1,l=0;for(e=1;e<=10;e++)h*=r,l+=this.A[e]*h;var c,u=l,d=n,m=1,p=0,x=0,f=0;for(e=1;e<=6;e++)c=p*u+m*d,m=m*u-p*d,p=c,x=x+this.B_re[e]*m-this.B_im[e]*p,f=f+this.B_im[e]*m+this.B_re[e]*p;return t.x=f*this.a+this.x0,t.y=x*this.a+this.y0,t},inverse:function(t){var e,s,i=t.x,a=t.y,r=i-this.x0,n=(a-this.y0)/this.a,h=r/this.a,l=1,c=0,u=0,d=0;for(e=1;e<=6;e++)s=c*n+l*h,l=l*n-c*h,c=s,u=u+this.C_re[e]*l-this.C_im[e]*c,d=d+this.C_im[e]*l+this.C_re[e]*c;for(var m=0;m<this.iterations;m++){var p,x=u,f=d,g=n,M=h;for(e=2;e<=6;e++)p=f*u+x*d,x=x*u-f*d,f=p,g+=(e-1)*(this.B_re[e]*x-this.B_im[e]*f),M+=(e-1)*(this.B_im[e]*x+this.B_re[e]*f);x=1,f=0;var y=this.B_re[1],b=this.B_im[1];for(e=2;e<=6;e++)p=f*u+x*d,x=x*u-f*d,f=p,y+=e*(this.B_re[e]*x-this.B_im[e]*f),b+=e*(this.B_im[e]*x+this.B_re[e]*f);var w=y*y+b*b;u=(g*y+M*b)/w,d=(M*y-g*b)/w}var v=u,S=d,_=1,C=0;for(e=1;e<=9;e++)_*=v,C+=this.D[e]*_;var T=this.lat0+C*o*1e5,D=this.long0+S;return t.x=D,t.y=T,t},names:["New_Zealand_Map_Grid","nzmg"]};var $e={init:function(){},forward:function(t){var e=t.x,s=t.y,i=W(e-this.long0),a=this.x0+this.a*i,r=this.y0+this.a*Math.log(Math.tan(Math.PI/4+s/2.5))*1.25;return t.x=a,t.y=r,t},inverse:function(t){t.x-=this.x0,t.y-=this.y0;var e=W(this.long0+t.x/this.a),s=2.5*(Math.atan(Math.exp(.8*t.y/this.a))-Math.PI/4);return t.x=e,t.y=s,t},names:["Miller_Cylindrical","mill"]};var ts={init:function(){this.sphere?(this.n=1,this.m=0,this.es=0,this.C_y=Math.sqrt((this.m+1)/this.n),this.C_x=this.C_y/(this.m+1)):this.en=oe(this.es)},forward:function(t){var e,s,i=t.x,a=t.y;if(i=W(i-this.long0),this.sphere){if(this.m)for(var r=this.n*Math.sin(a),n=20;n;--n){var h=(this.m*a+Math.sin(a)-r)/(this.m+Math.cos(a));if(a-=h,Math.abs(h)<m)break}else a=1!==this.n?Math.asin(this.n*Math.sin(a)):a;e=this.a*this.C_x*i*(this.m+Math.cos(a)),s=this.a*this.C_y*a}else{var o=Math.sin(a),l=Math.cos(a);s=this.a*le(a,o,l,this.en),e=this.a*i*l/Math.sqrt(1-this.es*o*o)}return t.x=e,t.y=s,t},inverse:function(t){var e,s,i;return t.x-=this.x0,s=t.x/this.a,t.y-=this.y0,e=t.y/this.a,this.sphere?(e/=this.C_y,s/=this.C_x*(this.m+Math.cos(e)),this.m?e=We((this.m*e+Math.sin(e))/this.n):1!==this.n&&(e=We(Math.sin(e)/this.n)),s=W(s+this.long0),e=ke(e)):(e=ue(t.y/this.a,this.es,this.en),(i=Math.abs(e))<l?(i=Math.sin(e),s=W(this.long0+t.x*Math.sqrt(1-this.es*i*i)/(this.a*Math.cos(e)))):i-m<l&&(s=this.long0)),t.x=s,t.y=e,t},names:["Sinusoidal","sinu"]};var es={init:function(){},forward:function(t){for(var e=t.x,s=t.y,i=W(e-this.long0),a=s,r=Math.PI*Math.sin(s);;){var n=-(a+Math.sin(a)-r)/(1+Math.cos(a));if(a+=n,Math.abs(n)<m)break}a/=2,Math.PI/2-Math.abs(s)<m&&(i=0);var h=.900316316158*this.a*i*Math.cos(a)+this.x0,o=1.4142135623731*this.a*Math.sin(a)+this.y0;return t.x=h,t.y=o,t},inverse:function(t){var e,s;t.x-=this.x0,t.y-=this.y0,s=t.y/(1.4142135623731*this.a),Math.abs(s)>.999999999999&&(s=.999999999999),e=Math.asin(s);var i=W(this.long0+t.x/(.900316316158*this.a*Math.cos(e)));i<-Math.PI&&(i=-Math.PI),i>Math.PI&&(i=Math.PI),s=(2*e+Math.sin(2*e))/Math.PI,Math.abs(s)>1&&(s=1);var a=Math.asin(s);return t.x=i,t.y=a,t},names:["Mollweide","moll"]};var ss={init:function(){Math.abs(this.lat1+this.lat2)<m||(this.lat2=this.lat2||this.lat1,this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Ee(this.es),this.e1=Ae(this.es),this.e2=Ie(this.es),this.e3=Fe(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=j(this.e,this.sinphi,this.cosphi),this.ml1=ze(this.e0,this.e1,this.e2,this.e3,this.lat1),Math.abs(this.lat1-this.lat2)<m?this.ns=this.sinphi:(this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=j(this.e,this.sinphi,this.cosphi),this.ml2=ze(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=(this.ms1-this.ms2)/(this.ml2-this.ml1)),this.g=this.ml1+this.ms1/this.ns,this.ml0=ze(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0))},forward:function(t){var e,s=t.x,i=t.y;if(this.sphere)e=this.a*(this.g-i);else{var a=ze(this.e0,this.e1,this.e2,this.e3,i);e=this.a*(this.g-a)}var r=this.ns*W(s-this.long0),n=this.x0+e*Math.sin(r),h=this.y0+this.rh-e*Math.cos(r);return t.x=n,t.y=h,t},inverse:function(t){var e,s,i,a;t.x-=this.x0,t.y=this.rh-t.y+this.y0,this.ns>=0?(s=Math.sqrt(t.x*t.x+t.y*t.y),e=1):(s=-Math.sqrt(t.x*t.x+t.y*t.y),e=-1);var r=0;return 0!==s&&(r=Math.atan2(e*t.x,e*t.y)),this.sphere?(a=W(this.long0+r/this.ns),i=ke(this.g-s/this.a),t.x=a,t.y=i,t):(i=Ne(this.g-s/this.a,this.e0,this.e1,this.e2,this.e3),a=W(this.long0+r/this.ns),t.x=a,t.y=i,t)},names:["Equidistant_Conic","eqdc"]};var is={init:function(){this.R=this.a},forward:function(t){var e,s,i=t.x,a=t.y,r=W(i-this.long0);Math.abs(a)<=m&&(e=this.x0+this.R*r,s=this.y0);var n=We(2*Math.abs(a/Math.PI));(Math.abs(r)<=m||Math.abs(Math.abs(a)-l)<=m)&&(e=this.x0,s=a>=0?this.y0+Math.PI*this.R*Math.tan(.5*n):this.y0+Math.PI*this.R*-Math.tan(.5*n));var h=.5*Math.abs(Math.PI/r-r/Math.PI),o=h*h,c=Math.sin(n),u=Math.cos(n),d=u/(c+u-1),p=d*d,x=d*(2/c-1),f=x*x,g=Math.PI*this.R*(h*(d-f)+Math.sqrt(o*(d-f)*(d-f)-(f+o)*(p-f)))/(f+o);r<0&&(g=-g),e=this.x0+g;var M=o+d;return g=Math.PI*this.R*(x*M-h*Math.sqrt((f+o)*(o+1)-M*M))/(f+o),s=a>=0?this.y0+g:this.y0-g,t.x=e,t.y=s,t},inverse:function(t){var e,s,i,a,r,n,h,o,l,c,u,d;return t.x-=this.x0,t.y-=this.y0,u=Math.PI*this.R,r=(i=t.x/u)*i+(a=t.y/u)*a,u=3*(a*a/(o=-2*(n=-Math.abs(a)*(1+r))+1+2*a*a+r*r)+(2*(h=n-2*a*a+i*i)*h*h/o/o/o-9*n*h/o/o)/27)/(l=(n-h*h/3/o)/o)/(c=2*Math.sqrt(-l/3)),Math.abs(u)>1&&(u=u>=0?1:-1),d=Math.acos(u)/3,s=t.y>=0?(-c*Math.cos(d+Math.PI/3)-h/3/o)*Math.PI:-(-c*Math.cos(d+Math.PI/3)-h/3/o)*Math.PI,e=Math.abs(i)<m?this.long0:W(this.long0+Math.PI*(r-1+Math.sqrt(1+2*(i*i-a*a)+r*r))/2/i),t.x=e,t.y=s,t},names:["Van_der_Grinten_I","VanDerGrinten","vandg"]};var as={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(t){var e,s,i,a,r,n,h,o,c,u,d,p,x,f,g,M,y,b,w,v,S,_,C=t.x,T=t.y,D=Math.sin(t.y),P=Math.cos(t.y),z=W(C-this.long0);return this.sphere?Math.abs(this.sin_p12-1)<=m?(t.x=this.x0+this.a*(l-T)*Math.sin(z),t.y=this.y0-this.a*(l-T)*Math.cos(z),t):Math.abs(this.sin_p12+1)<=m?(t.x=this.x0+this.a*(l+T)*Math.sin(z),t.y=this.y0+this.a*(l+T)*Math.cos(z),t):(b=this.sin_p12*D+this.cos_p12*P*Math.cos(z),y=(M=Math.acos(b))?M/Math.sin(M):1,t.x=this.x0+this.a*y*P*Math.sin(z),t.y=this.y0+this.a*y*(this.cos_p12*D-this.sin_p12*P*Math.cos(z)),t):(e=Ee(this.es),s=Ae(this.es),i=Ie(this.es),a=Fe(this.es),Math.abs(this.sin_p12-1)<=m?(r=this.a*ze(e,s,i,a,l),n=this.a*ze(e,s,i,a,T),t.x=this.x0+(r-n)*Math.sin(z),t.y=this.y0-(r-n)*Math.cos(z),t):Math.abs(this.sin_p12+1)<=m?(r=this.a*ze(e,s,i,a,l),n=this.a*ze(e,s,i,a,T),t.x=this.x0+(r+n)*Math.sin(z),t.y=this.y0+(r+n)*Math.cos(z),t):(h=D/P,o=Re(this.a,this.e,this.sin_p12),c=Re(this.a,this.e,D),u=Math.atan((1-this.es)*h+this.es*o*this.sin_p12/(c*P)),w=0===(d=Math.atan2(Math.sin(z),this.cos_p12*Math.tan(u)-this.sin_p12*Math.cos(z)))?Math.asin(this.cos_p12*Math.sin(u)-this.sin_p12*Math.cos(u)):Math.abs(Math.abs(d)-Math.PI)<=m?-Math.asin(this.cos_p12*Math.sin(u)-this.sin_p12*Math.cos(u)):Math.asin(Math.sin(z)*Math.cos(u)/Math.sin(d)),p=this.e*this.sin_p12/Math.sqrt(1-this.es),M=o*w*(1-(v=w*w)*(g=(x=this.e*this.cos_p12*Math.cos(d)/Math.sqrt(1-this.es))*x)*(1-g)/6+(S=v*w)/8*(f=p*x)*(1-2*g)+(_=S*w)/120*(g*(4-7*g)-3*p*p*(1-7*g))-_*w/48*f),t.x=this.x0+M*Math.sin(d),t.y=this.y0+M*Math.cos(d),t))},inverse:function(t){var e,s,i,a,r,n,h,o,c,u,d,p,x,f,g,M,y,b,w,v,S,_,C;if(t.x-=this.x0,t.y-=this.y0,this.sphere){if((e=Math.sqrt(t.x*t.x+t.y*t.y))>2*l*this.a)return;return s=e/this.a,i=Math.sin(s),a=Math.cos(s),r=this.long0,Math.abs(e)<=m?n=this.lat0:(n=We(a*this.sin_p12+t.y*i*this.cos_p12/e),h=Math.abs(this.lat0)-l,r=Math.abs(h)<=m?this.lat0>=0?W(this.long0+Math.atan2(t.x,-t.y)):W(this.long0-Math.atan2(-t.x,t.y)):W(this.long0+Math.atan2(t.x*i,e*this.cos_p12*a-t.y*this.sin_p12*i))),t.x=r,t.y=n,t}return o=Ee(this.es),c=Ae(this.es),u=Ie(this.es),d=Fe(this.es),Math.abs(this.sin_p12-1)<=m?(n=Ne(((p=this.a*ze(o,c,u,d,l))-(e=Math.sqrt(t.x*t.x+t.y*t.y)))/this.a,o,c,u,d),r=W(this.long0+Math.atan2(t.x,-1*t.y)),t.x=r,t.y=n,t):Math.abs(this.sin_p12+1)<=m?(p=this.a*ze(o,c,u,d,l),n=Ne(((e=Math.sqrt(t.x*t.x+t.y*t.y))-p)/this.a,o,c,u,d),r=W(this.long0+Math.atan2(t.x,t.y)),t.x=r,t.y=n,t):(e=Math.sqrt(t.x*t.x+t.y*t.y),g=Math.atan2(t.x,t.y),x=Re(this.a,this.e,this.sin_p12),M=Math.cos(g),b=-(y=this.e*this.cos_p12*M)*y/(1-this.es),w=3*this.es*(1-b)*this.sin_p12*this.cos_p12*M/(1-this.es),_=1-b*(S=(v=e/x)-b*(1+b)*Math.pow(v,3)/6-w*(1+3*b)*Math.pow(v,4)/24)*S/2-v*S*S*S/6,f=Math.asin(this.sin_p12*Math.cos(S)+this.cos_p12*Math.sin(S)*M),r=W(this.long0+Math.asin(Math.sin(g)*Math.sin(S)/Math.cos(f))),C=Math.sin(f),n=Math.atan2((C-this.es*_*this.sin_p12)*Math.tan(f),C*(1-this.es)),t.x=r,t.y=n,t)},names:["Azimuthal_Equidistant","aeqd"]};var rs={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(t){var e,s,i,a,r,n,h,o=t.x,l=t.y;return i=W(o-this.long0),e=Math.sin(l),s=Math.cos(l),a=Math.cos(i),((r=this.sin_p14*e+this.cos_p14*s*a)>0||Math.abs(r)<=m)&&(n=1*this.a*s*Math.sin(i),h=this.y0+1*this.a*(this.cos_p14*e-this.sin_p14*s*a)),t.x=n,t.y=h,t},inverse:function(t){var e,s,i,a,r,n,h;return t.x-=this.x0,t.y-=this.y0,s=We((e=Math.sqrt(t.x*t.x+t.y*t.y))/this.a),i=Math.sin(s),a=Math.cos(s),n=this.long0,Math.abs(e)<=m?(h=this.lat0,t.x=n,t.y=h,t):(h=We(a*this.sin_p14+t.y*i*this.cos_p14/e),r=Math.abs(this.lat0)-l,Math.abs(r)<=m?(n=this.lat0>=0?W(this.long0+Math.atan2(t.x,-t.y)):W(this.long0-Math.atan2(-t.x,t.y)),t.x=n,t.y=h,t):(n=W(this.long0+Math.atan2(t.x*i,e*this.cos_p14*a-t.y*this.sin_p14*i)),t.x=n,t.y=h,t))},names:["ortho"]},ns=1,hs=2,os=3,ls=4,cs=5,us=6,ds={AREA_0:1,AREA_1:2,AREA_2:3,AREA_3:4};function ms(t,e,s,i){var a;return t<m?(i.value=ds.AREA_0,a=0):(a=Math.atan2(e,s),Math.abs(a)<=f?i.value=ds.AREA_0:a>f&&a<=l+f?(i.value=ds.AREA_1,a-=l):a>l+f||a<=-(l+f)?(i.value=ds.AREA_2,a=a>=0?a-M:a+M):(i.value=ds.AREA_3,a+=l)),a}function ps(t,e){var s=t+e;return s<-M?s+=g:s>+M&&(s-=g),s}var xs={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Quadrilateralized Spherical Cube",this.lat0>=l-f/2?this.face=cs:this.lat0<=-(l-f/2)?this.face=us:Math.abs(this.long0)<=f?this.face=ns:Math.abs(this.long0)<=l+f?this.face=this.long0>0?hs:ls:this.face=os,0!==this.es&&(this.one_minus_f=1-(this.a-this.b)/this.a,this.one_minus_f_squared=this.one_minus_f*this.one_minus_f)},forward:function(t){var e,s,i,a,r,n,h={x:0,y:0},o={value:0};if(t.x-=this.long0,e=0!==this.es?Math.atan(this.one_minus_f_squared*Math.tan(t.y)):t.y,s=t.x,this.face===cs)a=l-e,s>=f&&s<=l+f?(o.value=ds.AREA_0,i=s-l):s>l+f||s<=-(l+f)?(o.value=ds.AREA_1,i=s>0?s-M:s+M):s>-(l+f)&&s<=-f?(o.value=ds.AREA_2,i=s+l):(o.value=ds.AREA_3,i=s);else if(this.face===us)a=l+e,s>=f&&s<=l+f?(o.value=ds.AREA_0,i=-s+l):s<f&&s>=-f?(o.value=ds.AREA_1,i=-s):s<-f&&s>=-(l+f)?(o.value=ds.AREA_2,i=-s-l):(o.value=ds.AREA_3,i=s>0?-s+M:-s-M);else{var c,u,d,m,p,x;this.face===hs?s=ps(s,+l):this.face===os?s=ps(s,+M):this.face===ls&&(s=ps(s,-l)),m=Math.sin(e),p=Math.cos(e),x=Math.sin(s),c=p*Math.cos(s),u=p*x,d=m,this.face===ns?i=ms(a=Math.acos(c),d,u,o):this.face===hs?i=ms(a=Math.acos(u),d,-c,o):this.face===os?i=ms(a=Math.acos(-c),d,-u,o):this.face===ls?i=ms(a=Math.acos(-u),d,c,o):(a=i=0,o.value=ds.AREA_0)}return n=Math.atan(12/M*(i+Math.acos(Math.sin(i)*Math.cos(f))-l)),r=Math.sqrt((1-Math.cos(a))/(Math.cos(n)*Math.cos(n))/(1-Math.cos(Math.atan(1/Math.cos(i))))),o.value===ds.AREA_1?n+=l:o.value===ds.AREA_2?n+=M:o.value===ds.AREA_3&&(n+=1.5*M),h.x=r*Math.cos(n),h.y=r*Math.sin(n),h.x=h.x*this.a+this.x0,h.y=h.y*this.a+this.y0,t.x=h.x,t.y=h.y,t},inverse:function(t){var e,s,i,a,r,n,h,o,c,u,d,m,p={lam:0,phi:0},x={value:0};if(t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a,s=Math.atan(Math.sqrt(t.x*t.x+t.y*t.y)),e=Math.atan2(t.y,t.x),t.x>=0&&t.x>=Math.abs(t.y)?x.value=ds.AREA_0:t.y>=0&&t.y>=Math.abs(t.x)?(x.value=ds.AREA_1,e-=l):t.x<0&&-t.x>=Math.abs(t.y)?(x.value=ds.AREA_2,e=e<0?e+M:e-M):(x.value=ds.AREA_3,e+=l),c=M/12*Math.tan(e),r=Math.sin(c)/(Math.cos(c)-1/Math.sqrt(2)),n=Math.atan(r),(h=1-(i=Math.cos(e))*i*(a=Math.tan(s))*a*(1-Math.cos(Math.atan(1/Math.cos(n)))))<-1?h=-1:h>1&&(h=1),this.face===cs)o=Math.acos(h),p.phi=l-o,x.value===ds.AREA_0?p.lam=n+l:x.value===ds.AREA_1?p.lam=n<0?n+M:n-M:x.value===ds.AREA_2?p.lam=n-l:p.lam=n;else if(this.face===us)o=Math.acos(h),p.phi=o-l,x.value===ds.AREA_0?p.lam=-n+l:x.value===ds.AREA_1?p.lam=-n:x.value===ds.AREA_2?p.lam=-n-l:p.lam=n<0?-n-M:-n+M;else{var f,g,y;c=(f=h)*f,g=(c+=(y=c>=1?0:Math.sqrt(1-c)*Math.sin(n))*y)>=1?0:Math.sqrt(1-c),x.value===ds.AREA_1?(c=g,g=-y,y=c):x.value===ds.AREA_2?(g=-g,y=-y):x.value===ds.AREA_3&&(c=g,g=y,y=-c),this.face===hs?(c=f,f=-g,g=c):this.face===os?(f=-f,g=-g):this.face===ls&&(c=f,f=g,g=-c),p.phi=Math.acos(-y)-l,p.lam=Math.atan2(g,f),this.face===hs?p.lam=ps(p.lam,-l):this.face===os?p.lam=ps(p.lam,-M):this.face===ls&&(p.lam=ps(p.lam,+l))}return 0!==this.es&&(u=p.phi<0?1:0,d=Math.tan(p.phi),m=this.b/Math.sqrt(d*d+this.one_minus_f_squared),p.phi=Math.atan(Math.sqrt(this.a*this.a-m*m)/(this.one_minus_f*m)),u&&(p.phi=-p.phi)),p.lam+=this.long0,t.x=p.lam,t.y=p.phi,t},names:["Quadrilateralized Spherical Cube","Quadrilateralized_Spherical_Cube","qsc"]},fs=[[1,22199e-21,-715515e-10,31103e-10],[.9986,-482243e-9,-24897e-9,-13309e-10],[.9954,-83103e-8,-448605e-10,-9.86701e-7],[.99,-.00135364,-59661e-9,36777e-10],[.9822,-.00167442,-449547e-11,-572411e-11],[.973,-.00214868,-903571e-10,1.8736e-8],[.96,-.00305085,-900761e-10,164917e-11],[.9427,-.00382792,-653386e-10,-26154e-10],[.9216,-.00467746,-10457e-8,481243e-11],[.8962,-.00536223,-323831e-10,-543432e-11],[.8679,-.00609363,-113898e-9,332484e-11],[.835,-.00698325,-640253e-10,9.34959e-7],[.7986,-.00755338,-500009e-10,9.35324e-7],[.7597,-.00798324,-35971e-9,-227626e-11],[.7186,-.00851367,-701149e-10,-86303e-10],[.6732,-.00986209,-199569e-9,191974e-10],[.6213,-.010418,883923e-10,624051e-11],[.5722,-.00906601,182e-6,624051e-11],[.5322,-.00677797,275608e-9,624051e-11]],gs=[[-520417e-23,.0124,121431e-23,-845284e-16],[.062,.0124,-1.26793e-9,4.22642e-10],[.124,.0124,5.07171e-9,-1.60604e-9],[.186,.0123999,-1.90189e-8,6.00152e-9],[.248,.0124002,7.10039e-8,-2.24e-8],[.31,.0123992,-2.64997e-7,8.35986e-8],[.372,.0124029,9.88983e-7,-3.11994e-7],[.434,.0123893,-369093e-11,-4.35621e-7],[.4958,.0123198,-102252e-10,-3.45523e-7],[.5571,.0121916,-154081e-10,-5.82288e-7],[.6176,.0119938,-241424e-10,-5.25327e-7],[.6769,.011713,-320223e-10,-5.16405e-7],[.7346,.0113541,-397684e-10,-6.09052e-7],[.7903,.0109107,-489042e-10,-104739e-11],[.8435,.0103431,-64615e-9,-1.40374e-9],[.8936,.00969686,-64636e-9,-8547e-9],[.9394,.00840947,-192841e-9,-42106e-10],[.9761,.00616527,-256e-6,-42106e-10],[1,.00328947,-319159e-9,-42106e-10]],Ms=.8487,ys=1.3523,bs=x/5,ws=1/bs,vs=18,Ss=function(t,e){return t[0]+e*(t[1]+e*(t[2]+e*t[3]))};var _s={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.long0=this.long0||0,this.es=0,this.title=this.title||"Robinson"},forward:function(t){var e=W(t.x-this.long0),s=Math.abs(t.y),i=Math.floor(s*bs);i<0?i=0:i>=vs&&(i=17);var a={x:Ss(fs[i],s=x*(s-ws*i))*e,y:Ss(gs[i],s)};return t.y<0&&(a.y=-a.y),a.x=a.x*this.a*Ms+this.x0,a.y=a.y*this.a*ys+this.y0,a},inverse:function(t){var e={x:(t.x-this.x0)/(this.a*Ms),y:Math.abs(t.y-this.y0)/(this.a*ys)};if(e.y>=1)e.x/=fs[18][0],e.y=t.y<0?-l:l;else{var s=Math.floor(e.y*vs);for(s<0?s=0:s>=vs&&(s=17);;)if(gs[s][0]>e.y)--s;else{if(!(gs[s+1][0]<=e.y))break;++s}var i=gs[s],a=5*(e.y-i[0])/(gs[s+1][0]-i[0]);a=function(t,e,s,i){for(var a=e;i;--i){var r=t(a);if(a-=r,Math.abs(r)<s)break}return a}((function(t){return(Ss(i,t)-e.y)/function(t,e){return t[1]+e*(2*t[2]+3*e*t[3])}(i,t)}),a,m,100),e.x/=Ss(fs[s],a),e.y=(5*s+a)*p,t.y<0&&(e.y=-e.y)}return e.x=W(e.x+this.long0),e},names:["Robinson","robin"]};var Cs={init:function(){this.name="geocent"},forward:function(t){return pt(t,this.es,this.a)},inverse:function(t){return xt(t,this.es,this.a,this.b)},names:["Geocentric","geocentric","geocent","Geocent"]},Ts=0,Ds=1,Ps=2,zs=3,Es={h:{def:1e5,num:!0},azi:{def:0,num:!0,degrees:!0},tilt:{def:0,num:!0,degrees:!0},long0:{def:0,num:!0},lat0:{def:0,num:!0}};var As={init:function(){if(Object.keys(Es).forEach(function(t){if(void 0===this[t])this[t]=Es[t].def;else{if(Es[t].num&&isNaN(this[t]))throw new Error("Invalid parameter value, must be numeric "+t+" = "+this[t]);Es[t].num&&(this[t]=parseFloat(this[t]))}Es[t].degrees&&(this[t]=this[t]*p)}.bind(this)),Math.abs(Math.abs(this.lat0)-l)<m?this.mode=this.lat0<0?Ds:Ts:Math.abs(this.lat0)<m?this.mode=Ps:(this.mode=zs,this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0)),this.pn1=this.h/this.a,this.pn1<=0||this.pn1>1e10)throw new Error("Invalid height");this.p=1+this.pn1,this.rp=1/this.p,this.h1=1/this.pn1,this.pfact=(this.p+1)*this.h1,this.es=0;var t=this.tilt,e=this.azi;this.cg=Math.cos(e),this.sg=Math.sin(e),this.cw=Math.cos(t),this.sw=Math.sin(t)},forward:function(t){t.x-=this.long0;var e,s,i,a,r=Math.sin(t.y),n=Math.cos(t.y),h=Math.cos(t.x);switch(this.mode){case zs:s=this.sinph0*r+this.cosph0*n*h;break;case Ps:s=n*h;break;case Ds:s=-r;break;case Ts:s=r}switch(e=(s=this.pn1/(this.p-s))*n*Math.sin(t.x),this.mode){case zs:s*=this.cosph0*r-this.sinph0*n*h;break;case Ps:s*=r;break;case Ts:s*=-n*h;break;case Ds:s*=n*h}return a=1/((i=s*this.cg+e*this.sg)*this.sw*this.h1+this.cw),e=(e*this.cg-s*this.sg)*this.cw*a,s=i*a,t.x=e*this.a,t.y=s*this.a,t},inverse:function(t){t.x/=this.a,t.y/=this.a;var e,s,i,a={x:t.x,y:t.y};i=1/(this.pn1-t.y*this.sw),e=this.pn1*t.x*i,s=this.pn1*t.y*this.cw*i,t.x=e*this.cg+s*this.sg,t.y=s*this.cg-e*this.sg;var r=pe(t.x,t.y);if(Math.abs(r)<m)a.x=0,a.y=t.y;else{var n,h;switch(h=1-r*r*this.pfact,h=(this.p-Math.sqrt(h))/(this.pn1/r+r/this.pn1),n=Math.sqrt(1-h*h),this.mode){case zs:a.y=Math.asin(n*this.sinph0+t.y*h*this.cosph0/r),t.y=(n-this.sinph0*Math.sin(a.y))*r,t.x*=h*this.cosph0;break;case Ps:a.y=Math.asin(t.y*h/r),t.y=n*r,t.x*=h;break;case Ts:a.y=Math.asin(n),t.y=-t.y;break;case Ds:a.y=-Math.asin(n)}a.x=Math.atan2(t.x,t.y)}return t.x=a.x+this.long0,t.y=a.y,t},names:["Tilted_Perspective","tpers"]};var Is={init:function(){if(this.flip_axis="x"===this.sweep?1:0,this.h=Number(this.h),this.radius_g_1=this.h/this.a,this.radius_g_1<=0||this.radius_g_1>1e10)throw new Error;if(this.radius_g=1+this.radius_g_1,this.C=this.radius_g*this.radius_g-1,0!==this.es){var t=1-this.es,e=1/t;this.radius_p=Math.sqrt(t),this.radius_p2=t,this.radius_p_inv2=e,this.shape="ellipse"}else this.radius_p=1,this.radius_p2=1,this.radius_p_inv2=1,this.shape="sphere";this.title||(this.title="Geostationary Satellite View")},forward:function(t){var e,s,i,a,r=t.x,n=t.y;if(r-=this.long0,"ellipse"===this.shape){n=Math.atan(this.radius_p2*Math.tan(n));var h=this.radius_p/pe(this.radius_p*Math.cos(n),Math.sin(n));if(s=h*Math.cos(r)*Math.cos(n),i=h*Math.sin(r)*Math.cos(n),a=h*Math.sin(n),(this.radius_g-s)*s-i*i-a*a*this.radius_p_inv2<0)return t.x=Number.NaN,t.y=Number.NaN,t;e=this.radius_g-s,this.flip_axis?(t.x=this.radius_g_1*Math.atan(i/pe(a,e)),t.y=this.radius_g_1*Math.atan(a/e)):(t.x=this.radius_g_1*Math.atan(i/e),t.y=this.radius_g_1*Math.atan(a/pe(i,e)))}else"sphere"===this.shape&&(e=Math.cos(n),s=Math.cos(r)*e,i=Math.sin(r)*e,a=Math.sin(n),e=this.radius_g-s,this.flip_axis?(t.x=this.radius_g_1*Math.atan(i/pe(a,e)),t.y=this.radius_g_1*Math.atan(a/e)):(t.x=this.radius_g_1*Math.atan(i/e),t.y=this.radius_g_1*Math.atan(a/pe(i,e))));return t.x=t.x*this.a,t.y=t.y*this.a,t},inverse:function(t){var e,s,i,a,r=-1,n=0,h=0;if(t.x=t.x/this.a,t.y=t.y/this.a,"ellipse"===this.shape){this.flip_axis?(h=Math.tan(t.y/this.radius_g_1),n=Math.tan(t.x/this.radius_g_1)*pe(1,h)):(n=Math.tan(t.x/this.radius_g_1),h=Math.tan(t.y/this.radius_g_1)*pe(1,n));var o=h/this.radius_p;if(e=n*n+o*o+r*r,(i=(s=2*this.radius_g*r)*s-4*e*this.C)<0)return t.x=Number.NaN,t.y=Number.NaN,t;a=(-s-Math.sqrt(i))/(2*e),r=this.radius_g+a*r,n*=a,h*=a,t.x=Math.atan2(n,r),t.y=Math.atan(h*Math.cos(t.x)/r),t.y=Math.atan(this.radius_p_inv2*Math.tan(t.y))}else if("sphere"===this.shape){if(this.flip_axis?(h=Math.tan(t.y/this.radius_g_1),n=Math.tan(t.x/this.radius_g_1)*Math.sqrt(1+h*h)):(n=Math.tan(t.x/this.radius_g_1),h=Math.tan(t.y/this.radius_g_1)*Math.sqrt(1+n*n)),e=n*n+h*h+r*r,(i=(s=2*this.radius_g*r)*s-4*e*this.C)<0)return t.x=Number.NaN,t.y=Number.NaN,t;a=(-s-Math.sqrt(i))/(2*e),r=this.radius_g+a*r,n*=a,h*=a,t.x=Math.atan2(n,r),t.y=Math.atan(h*Math.cos(t.x)/r)}return t.x=t.x+this.long0,t},names:["Geostationary Satellite View","Geostationary_Satellite","geos"]},Fs=1.340264,Rs=-.081106,ks=893e-6,Ns=.003796,Ls=Math.sqrt(3)/2;var Bs,Hs={init:function(){this.es=0,this.long0=void 0!==this.long0?this.long0:0},forward:function(t){var e=W(t.x-this.long0),s=t.y,i=Math.asin(Ls*Math.sin(s)),a=i*i,r=a*a*a;return t.x=e*Math.cos(i)/(Ls*(Fs+3*Rs*a+r*(7*ks+9*Ns*a))),t.y=i*(Fs+Rs*a+r*(ks+Ns*a)),t.x=this.a*t.x+this.x0,t.y=this.a*t.y+this.y0,t},inverse:function(t){t.x=(t.x-this.x0)/this.a,t.y=(t.y-this.y0)/this.a;var e,s,i,a,r=t.y;for(a=0;a<12&&(r-=i=(r*(Fs+Rs*(e=r*r)+(s=e*e*e)*(ks+Ns*e))-t.y)/(Fs+3*Rs*e+s*(7*ks+9*Ns*e)),!(Math.abs(i)<1e-9));++a);return s=(e=r*r)*e*e,t.x=Ls*t.x*(Fs+3*Rs*e+s*(7*ks+9*Ns*e))/Math.cos(r),t.y=Math.asin(Math.sin(r)/Ls),t.x=W(t.x+this.long0),t},names:["eqearth","Equal Earth","Equal_Earth"]};function qs(t){const e=6378137,s=6356752.314245,i=Math.sqrt((e*e-s*s)/(e*e)),a=Math.PI;let r=t[1]*a/180,n=t[0]*a/180,h=t[2],o=e/Math.sqrt(1-i*i*Math.sin(r)*Math.sin(r));return[(o+h)*Math.cos(r)*Math.cos(n),(o+h)*Math.cos(r)*Math.sin(n),(o*(1-i*i)+h)*Math.sin(r)]}if(zt.defaultDatum="WGS84",zt.Proj=mt,zt.WGS84=new zt.Proj("WGS84"),zt.Point=Zt,zt.toPoint=vt,zt.defs=H,zt.nadgrid=function(t,e){var s=new DataView(e),i=function(t){var e=t.getInt32(8,!1);if(11===e)return!1;e=t.getInt32(8,!0),11!==e&&console.warn("Failed to detect nadgrid endian-ness, defaulting to little-endian");return!0}(s),a=function(t,e){return{nFields:t.getInt32(8,e),nSubgridFields:t.getInt32(24,e),nSubgrids:t.getInt32(40,e),shiftType:ot(t,56,64).trim(),fromSemiMajorAxis:t.getFloat64(120,e),fromSemiMinorAxis:t.getFloat64(136,e),toSemiMajorAxis:t.getFloat64(152,e),toSemiMinorAxis:t.getFloat64(168,e)}}(s,i),r=function(t,e,s){for(var i=176,a=[],r=0;r<e.nSubgrids;r++){var n=ct(t,i,s),h=ut(t,i,n,s),o=Math.round(1+(n.upperLongitude-n.lowerLongitude)/n.longitudeInterval),l=Math.round(1+(n.upperLatitude-n.lowerLatitude)/n.latitudeInterval);a.push({ll:[ht(n.lowerLongitude),ht(n.lowerLatitude)],del:[ht(n.longitudeInterval),ht(n.latitudeInterval)],lim:[o,l],count:n.gridNodeCount,cvs:lt(h)}),i+=176+16*n.gridNodeCount}return a}(s,a,i),n={header:a,subgrids:r};return rt[t]=n,n},zt.transform=_t,zt.mgrs=Bt,zt.version="__VERSION__",(Bs=zt).Proj.projections.add(de),Bs.Proj.projections.add(Me),Bs.Proj.projections.add(ye),Bs.Proj.projections.add(ve),Bs.Proj.projections.add(Se),Bs.Proj.projections.add(_e),Bs.Proj.projections.add(Te),Bs.Proj.projections.add(De),Bs.Proj.projections.add(Pe),Bs.Proj.projections.add(Le),Bs.Proj.projections.add(Ge),Bs.Proj.projections.add(Qe),Bs.Proj.projections.add(Xe),Bs.Proj.projections.add(Ze),Bs.Proj.projections.add(Ye),Bs.Proj.projections.add(Ke),Bs.Proj.projections.add(Je),Bs.Proj.projections.add($e),Bs.Proj.projections.add(ts),Bs.Proj.projections.add(es),Bs.Proj.projections.add(ss),Bs.Proj.projections.add(is),Bs.Proj.projections.add(as),Bs.Proj.projections.add(rs),Bs.Proj.projections.add(xs),Bs.Proj.projections.add(_s),Bs.Proj.projections.add(Cs),Bs.Proj.projections.add(As),Bs.Proj.projections.add(Is),Bs.Proj.projections.add(Hs),function(t){let e=0,s=0;for(let i=1;i<=60;i++)e=i,s=32600+i,t.defs(`EPSG:${s}`,`+proj=utm +zone=${e} +datum=WGS84 +units=m +no_defs`),s=32700+i,t.defs(`EPSG:${s}`,`+proj=utm +zone=${e} +datum=WGS84 +units=m +south +no_defs`);e=25;for(let i=0;i<=20;i++)e=25+i,s=4534+i,t.defs(`EPSG:${s}`,`+proj=tmerc +lat_0=0 +lon_0=${75+3*i} +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs`),s=4513+i,t.defs(`EPSG:${s}`,`+proj=tmerc +lat_0=0 +lon_0=${75+3*i} +k=1 +x_0=${e}500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs`);e=13;for(let i=0;i<=10;i++)e=13+i,s=4502+i,t.defs(`EPSG:${s}`,`+proj=tmerc +lat_0=0 +lon_0=${75+6*i} +k=1 +x_0=500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs`),s=4491+i,t.defs(`EPSG:${s}`,`+proj=tmerc +lat_0=0 +lon_0=${75+6*i} +k=1 +x_0=${e}500000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs`)}(zt),!t)return function(t,e,s){return Pt(t,e,s)};!function(t){const e=t.data.srcCode,s=t.data.targetCode,i=t.data.metaOffset,a=t.data.wgs84Offset,r=t.data.isRTK,n=0,h=2,o=(t,n,h,o=!1)=>{const l=t.byteLength/h,c=new Float32Array(4*l),u=new Float32Array(n);let d,m,p,x,f;o&&(d=new Uint32Array(16*l),m=new Uint32Array(8*l),p=new Float32Array(m.buffer));let g=[0,0,0],M=h/4;for(let n=0;n<l;n++){const l=t.getFloat32(n*h,!0),y=t.getFloat32(n*h+4,!0),b=t.getFloat32(n*h+8,!0);if(r?(x=Pt(e,s,[l+i.x,y+i.y,b+i.z]),f=qs(x),g[0]=f[0]-a.x,g[1]=f[1]-a.y,g[2]=f[2]-a.z):(g[0]=l,g[1]=y,g[2]=b),c.set(g,3*n),o){const e=[],s=n*h+0;for(let i=0;i<8;i++)e[i]=t.getUint32(s+4*i,!0);m.set(e,8*n),r&&(p[8*n]=g[0],p[8*n+1]=g[1],p[8*n+2]=g[2]);const i=[],a=n*h+32;for(let e=0;e<15;e++)i[e]=t.getUint32(a+4*e,!0);d.set(i,16*n)}else r&&(u[n*M]=g[0],u[n*M+1]=g[1],u[n*M+2]=g[2])}return o?{pos:c,sh:d,data:m}:{pos:c}};if(t.data.type==n){const e=new DataView(t.data.buffer),s=32,{pos:i}=o(e,t.data.buffer,s);postMessage({index:t.data.index,dataBuffer:e.buffer,posBuffer:i.buffer},[e.buffer,i.buffer])}if(t.data.type==h){const e=new DataView(t.data.buffer),s=96,{pos:i,sh:a,data:r}=o(e,t.data.buffer,s,!0);postMessage({index:t.data.index,dataBuffer:r.buffer,posBuffer:i.buffer,shBuffer:a.buffer},[i.buffer,a.buffer,r.buffer])}}(t)}class Ne{type;buffer;size;meta;callback}class Le extends Bt{#m=!1;#Si=0;#Ss=[];#_i=[];#Ci=[];#Ti=0;#Di=!0;constructor(t=4){super();for(let e=0;e<t;++e){const t=Nt(ke);t?(this.#Ss.push(t),this.#Si++):console.error("create worker failed !!!")}this.#Ss.forEach((t=>{t.onmessage=t=>{if(this.#m)return;const s=t.data.index,a=this.#Ci[s];if(a.type===e){const e=new Uint32Array(t.data.dataBuffer),s=new Float32Array(t.data.posBuffer);a.callback(e,s,void 0)}else if(a.type===i){const e=new Uint32Array(t.data.dataBuffer),s=new Float32Array(t.data.posBuffer),i=new Uint32Array(t.data.shBuffer);a.callback(e,s,i)}this.#Ti++,this.#Ti>=this.#Ci.length&&(this.#Di=!0)}}))}dispose(){this.#m=!0,this.#Ss.forEach((t=>{t.terminate()})),this.#Ss=[],this.#Si=0,this.#Di=!1}#Pi(){if(!this.#Di||0==this.#_i.length||0==this.#Si)return;this.#Di=!1,this.#Ci=this.#_i,this.#_i=[],this.#Ti=0;const t=this.#Ci.length;for(let e=0;e<t;++e){const t=e%this.#Si,s=this.#Ss[t],i=this.#Ci[e],a=i.meta?.epsg>0;let r={};a&&(r.srcCode=i.meta.srcCode,r.targetCode=i.meta.targetCode,r.metaOffset=i.meta.metaOffset,r.wgs84Offset=i.meta.wgs84Offset),s.postMessage({index:e,type:i.type,buffer:i.buffer,isRTK:a,...r},[i.buffer])}}update(t){this.#m||this.#Pi()}decompress(t,s,a,r,n){if(t!==e&&t!==i)return console.error("unkonw type: "+t),!1;let h=new Ne;return h.type=t,h.buffer=s,h.size=a,h.meta=r,h.callback=n,this.#_i.push(h),this.#Di&&this.#Pi(),!0}}class Be{static GlobalID=0;#M;#Ee;#zi;#Ei;#Ai;#P;#Ii=!0;#Fi;#Oe;#Ri=!1;#ki=!1;#Ni=0;#Li=!1;#Bi=[];#Hi=void 0;_createVertexArray=!0;#qi=void 0;#Oi=!1;#Ui=!1;#Vi=!1;#us=!1;#as=0;#hs=0;#ji=void 0;#Gi=void 0;#Wi=void 0;#Qi=void 0;hasUploadSH=!1;node;splatCount=0;dimensions;dataDimensions;_sortInfos;size=0;#Xi;#Zi;pos;indexes;distances;#Yi;#Ki=!1;#mt=new J;#Ji=new J;#N=new Mt;#$i=!1;#ta=!1;#ea;#sa;#ia;useLogDepth=!1;#aa=null;#_t;constructor(t,e){let s,i,a,r,n,h;this.#M=Be.GlobalID++,this.#P=t,this.#Ee=this.#P.lccParam.renderLib,this.#zi=e.context,this.#Ni=e.splatCount||10,this.renderID=e?.renderID,this.#Ei=e.data,this.#Oe=this.#P.resources,this.#Ki=this.#P.isRTK,this.node=e?.node,this.#ki=e?.isEnv,this.#Zi=e?.sh,this._sp=void 0,this._rs=void 0,this.#qi=this.#Ee.Pass.CESIUM_3D_TILE,this.#ia=new this.#Ee.Matrix4,this._vs=void 0,this._fs=void 0,this.#sa=e?.matrix||new this.#Ee.Matrix4,this.#Xi=e?.prj2ECEF||new this.#Ee.Matrix3,this.#ea=null,this.#_t=this.#P?.meta?.data,this.#Fi={position:0},this.splatCount=e?.splatCount,this.dimensions=it(e?.splatCount),this.dataDimensions=it(2*e?.splatCount),this.shDimensions=it(4*this.splatCount),this.size=this.#ra(),e?.isEnv?(this.#_t.compressInfo.positionMin&&this.#_t.compressInfo.positionMax&&this.#N.set(this.#_t.compressInfo.positionMin,this.#_t.compressInfo.positionMax),n=this.#_t.compressInfo.positionMin,h=this.#_t.compressInfo.positionMax,s=this.#_t.compressInfo.compressedEnvScaleMin||s,i=this.#_t.compressInfo.compressedEnvScaleMax||i,a=this.#_t.compressInfo.compressedEnvSHMin||a,r=this.#_t.compressInfo.compressedEnvSHMax||a):(this.#N.copy(this.node.parent.getBBox()),n=this.#_t.min,h=this.#_t.max,s=this.#_t.compressInfo.compressedScaleMin,i=this.#_t.compressInfo.compressedScaleMax,a=this.#_t.compressInfo.compressedSHMin,r=this.#_t.compressInfo.compressedSHMax);const o=this.dimensions.x*this.dimensions.y;if(e.pos&&(this.pos=new Float32Array(e.pos.length),this.pos.set(e.pos,0),this.distances=new Int32Array(this.splatCount),this.indexes=new Int32Array(this.splatCount),this.#Yi=new Int32Array(this.splatCount)),this._sortInfos={totalDrawCount:at(o),lastDrawCount:0},this.#Ai=this.#na({compressedScaleMin:s,compressedScaleMax:i,compressedSHMin:a,compressedSHMax:r,positionMin:n,positionMax:h}),this.#ha(),this.#_t){const t=this.node.parent.getBBox(),e=this.#Ee.Matrix4.getTranslation(this.#sa,new this.#Ee.Cartesian3);this.setBoundingVolume(e,{max:t.max.toArray(),min:t.min.toArray()})}this.#ws(this.#zi)}get id(){return this.#M}get isInitialized(){return this.#Oi}get isFirstSorted(){return this.isInitialized}get isCached(){return this.#Ui}get isSorted(){return this.#Vi}get isSorting(){return this.#us}get show(){return this.#Ii}set show(t){this.#Ii=!!t}get transformsTexture(){return this.#ji}get indexRT(){return this.#oa()}get cmrPos(){return this.#mt}get sortTickLast(){return this.#as}#na(t){const{compressedScaleMin:e,compressedScaleMax:s,compressedSHMin:i,compressedSHMax:a,positionMin:r,positionMax:n}=t,h=new gt(r.z,n.z);return{dimensions:()=>({x:this.dimensions.x,y:this.dimensions.y}),dataDimensions:()=>({x:this.dataDimensions.x,y:this.dataDimensions.y}),shDimensions:()=>({x:this.shDimensions.x,y:this.shDimensions.y}),viewport:()=>({x:0,y:0}),focal:()=>0,cmrPos:()=>({x:0,y:0,z:0}),splatCount:()=>this.splatCount,pointsOnly:()=>0,useSH:()=>0,compressedSHMin:()=>i,compressedSHMax:()=>a,compressedScaleMax:()=>s,compressedScaleMin:()=>e,splatData:()=>this.#ji,splatIndexes:()=>this.#Gi,shRawTexture:()=>this.#Qi,customColors:()=>this.customColors,alpha:()=>1,useCustomColor:()=>0,heightRange:()=>h,clipPlane:()=>({x:0,y:0,z:0,w:0}),clipBoxMatrixInv:()=>this.#ia,clipBoxSide:()=>1,prj2ECEF:()=>this.#Xi,splatIndexesHost:()=>this.#Wi,useIndexHost:()=>!1}}#ha(){this._vs=Me(fe).vertexShaderSH,this._fs=ye(fe).fragmentShader}#la(t,e,s){const i=t.context,a=["INSTANCED","HAS_NOT_ATTRIBUTE_POSITION","LccShader"];this.#Ki&&a.push("IS_RTK");const r=new this.#Ee.ShaderSource({defines:a,sources:[e]}),n=new this.#Ee.ShaderSource({defines:a,sources:[s]});this._sp=this.#Ee.ShaderProgram.replaceCache({context:i,shaderProgram:this._sp,vertexShaderSource:r,fragmentShaderSource:n,attributeLocations:this.#Fi}),this._rs=this.#Ee.RenderState.fromCache({blending:this.#Ee.BlendingState.ALPHA_BLEND,depthTest:{enabled:!0,func:this.#Ee.WebGLConstants.ALWAYS},depthMask:!0,cull:{enabled:!1}}),this.#Ri=!0}#ra(){const t=this.dimensions,e=this.dataDimensions,s=this.shDimensions;let i=0,a=e.x*e.y*16,r=t.x*t.y*4,n=s.x*s.y*16;return i=a+r,this.hasUploadSH&&(i+=n),i}setSorted(t){this.#Vi=t,t&&(this.#us=!1,this.#Oi=!0,this.#$i=!1,this._sortInfos.lastDrawCount=0,this.#as=this.#hs)}setCPUSorted(t){if(this.#Vi=t,t){this.#us=!1,this.#Oi=!0,this.#as=this.#hs,this.#$i=!0,this.#ta=!0;let t=this.indexes;this.indexes=this.#Yi,this.#Yi=t}}startSorting(){this.getSortLocalCmrPos(),this.#us=!0}getSortLocalCmrPos(){return this.#mt.copy(this.#P.dynamicState.cmrPosLocal),this.#Ji.copy(this.#P.dynamicState.cmrForward),this.#hs=this.#P.dynamicState.tick,this.#us=!0,this.cmrPos}checkNeedSort(){if(this.#us)return!1;if(!this.isInitialized||!this.#Vi)return!0;const t=this.#P.dynamicState.cmrPosLocal,e=this.#P.dynamicState.cmrForward;this.#P.config.CameraAngleChangedSortThreshold;const s=this.#P.config.CameraPosChangedSortThreshold,i=t.distanceToSquared(this.#mt);if(e.dot(this.#Ji),i<s*s)return!1;const a=[0,160,320,480,640,800,960];return!(this.#P.dynamicState.tick-this.#as<a[Math.min(a.length-1,this.node.level)])}setModelMatrix(t){t&&(this.#sa=t)}setPrj2ECEFMatrix(t){t&&(this.prj2ECEF=t)}setTranslation(t){this.#sa?this.#Ee.Matrix4.setTranslation(this.#sa,t,this.#sa):this.#sa=this.#Ee.Matrix4.fromTranslation(t),this.updateBoundingVolume(t,!1)}setRotation(t){if(this.#sa){const e=this.#Ee.Matrix4.getTranslation(this.#sa,new this.#Ee.Cartesian3),s=this.#Ee.Transforms.eastNorthUpToFixedFrame(e),i=this.#Ee.Matrix3.multiply(this.#Ee.Matrix4.getRotation(s,new this.#Ee.Matrix3),t,new this.#Ee.Matrix3);this.#Ee.Matrix4.setRotation(this.#sa,i,this.#sa)}else this.#sa=this.#Ee.Matrix4.fromRotation(t)}setScale(t){this.#sa?(this.#Ee.Matrix4.setScale(this.#sa,t,this.#sa),this.updateBoundingVolume(!1,t)):this.#sa=this.#Ee.Matrix4.fromScale(t)}setTranslationOffset(t){if(this.#sa){const e=this.#Ee.Matrix4.fromTranslation(t);this.#Ee.Matrix4.multiply(this.#sa,e,this.#sa);const s=this.#Ee.Matrix4.getTranslation(this.#sa,new this.#Ee.Cartesian3);this.updateBoundingVolume(s,!1)}}getTranslation(){return this.#sa?this.#Ee.Matrix4.getTranslation(this.#sa,new this.#Ee.Cartesian3):null}setBoundingVolume(t,e,s){if(s){const t=s.flat();let e=Math.max(t[0],t[3],t[6],t[9],t[12],t[15],t[18],t[21]),i=Math.max(t[1],t[4],t[7],t[10],t[13],t[16],t[19],t[22]),a=Math.max(t[2],t[5],t[8],t[11],t[14],t[17],t[20],t[23]),r=Math.min(t[0],t[3],t[6],t[9],t[12],t[15],t[18],t[21]),n=Math.min(t[1],t[4],t[7],t[10],t[13],t[16],t[19],t[22]),h=Math.min(t[2],t[5],t[8],t[11],t[14],t[17],t[20],t[23]),o=new this.#Ee.Cartesian3((e+r)/2,(i+n)/2,(a+h)/2);const l=Math.max(e-r,i-n,a-h);return this.#ea=new this.#Ee.BoundingSphere(o,l/2),this.#ea}if(e){const s=1,{max:i,min:a}=e,r=[(i[0]+a[0])/2,(i[1]+a[1])/2,(i[2]+a[2])/2/s],n=Math.max(i[0]-a[0],i[1]-a[1],(i[2]-a[2])/s),h=new this.#Ee.Cartesian3(r[0],r[1],r[2]);this.#Ee.Matrix3.multiplyByVector(this.#Xi,h,h);const o=new this.#Ee.Cartesian3(t.x+h.x,t.y+h.y,t.z+h.z);return this.#ea=new this.#Ee.BoundingSphere(o,n/2),this.#aa=r,this.#ea}}updateBoundingVolume(t,e){if(this.#ea){const s=this.#ea.center,i=this.#ea.radius;if(t&&this.#aa){const e=new this.#Ee.Cartesian3(t.x+this.#aa[0],t.y+this.#aa[1],t.z+this.#aa[2]);this.#ea=new this.#Ee.BoundingSphere(e,i)}e&&(this.#ea=new this.#Ee.BoundingSphere(s,i*Math.max(e.x,e.y,e.z)))}}setPassIndex(t){t>-1&&(this.#qi=t)}getBBox(){return this.#N}intersectWithRay(t,e){const s=new J,i=new J,a=new J,r=e*e;let n=-1;const h=new Float32Array(this.#Ei.buffer);for(let e=0;e<this.splatCount;++e){const o=h[8*e+0],l=h[8*e+1],c=h[8*e+2],u=s.set(o,l,c),d=i.copy(u).sub(t.origin),m=d.dot(t.direction);if(m<0||m>t.length)continue;const p=a.copy(t.origin).addScaledVector(t.direction,m).sub(t.origin).sub(d);p.dot(p)>r||(t.length=m,n=m)}if(n<0)return null;return{point:t.origin.clone().addScaledVector(t.direction,n),distance:n}}#ca(t){const e=t.passes,s=this.#Ai,i=t.commandList;if(e.render){let t=this.#Hi;this.#Ee.defined(t)||(t=this.#Hi=new this.#Ee.DrawCommand),t.pass=this.#qi,this.#ea&&(t.boundingVolume=this.#ea),t.owner=this,t.uniformMap=s,t.vertexArray=this._va,t.shaderProgram=this._sp,t.renderState=this._rs,t.modelMatrix=this.#sa,this.#Li&&(t.count=6,t.instanceCount=this.#Ni),i.push(t)}}#ua(t){let e=t.cache.lccMesh_vertexBufferInstanced;return this.#Ee.defined(e)||(e=this.#Ee.Buffer.createVertexBuffer({context:t,typedArray:new Float32Array([1,1,0,-1,-1,0,-1,1,0,1,1,0,1,-1,0,-1,-1,0]),usage:this.#Ee.BufferUsage.STATIC_DRAW}),e.vertexArrayDestroyable=!1,t.cache.lccMesh_vertexBufferInstanced=e),e}#da(t){return[{index:0,componentsPerAttribute:3,componentDatatype:this.#Ee.ComponentDatatype.FLOAT,vertexBuffer:this.#ua(t),normalize:!1,offsetInBytes:0,strideInBytes:0,instanceDivisor:0}]}#ma(t,e){return this._va=new this.#Ee.VertexArray({context:t,attributes:e}),this._createVertexArray=!1,this._va}#pa(t,e){const s=this.dataDimensions.x,i=this.dataDimensions.y,a=new Float32Array(this.#Ei.buffer),r=new this.#Ee.Texture({context:t,width:s,height:i,flipY:!1,skipColorSpaceConversion:!0,pixelDatatype:this.#Ee.PixelDatatype.FLOAT,pixelFormat:this.#Ee.PixelFormat.RGBA,sampler:new this.#Ee.Sampler({wrapS:this.#Ee.TextureWrap.CLAMP_TO_EDGE,wrapT:this.#Ee.TextureWrap.CLAMP_TO_EDGE,minificationFilter:this.#Ee.TextureMinificationFilter.NEAREST,magnificationFilter:this.#Ee.TextureMagnificationFilter.NEAREST})});return this.#xa(2*this.splatCount,this.dataDimensions,r,a),r}#xa(t,e,s,i,a=4){const r=[],n=e.x;e.y;const h=Math.floor(t/n),o=t%n;if(h>0){const e=n*h*a;r.push({offsetX:0,offsetY:0,width:n,height:h,offsetCount:0,count:e}),o>0&&r.push({offsetX:0,OffsetY:h,width:o,height:1,offsetCount:e,count:t*a})}else r.push({offsetX:0,OffsetY:0,width:o,height:1,offsetCount:0,count:t*a});for(;r.length>0;){const t=r.shift(),{offsetX:e,offsetY:a,width:n,height:h,offsetCount:o,count:l}=t;s.copyFrom({xOffset:e,yOffset:a,source:{width:t.width,height:t.height,arrayBufferView:i.subarray(o,l)},skipColorSpaceConversion:!0,flipY:!1})}}#fa(t,e=4,s){const i=this.dimensions.x,a=this.dimensions.y;return new this.#Ee.Texture({context:t,width:i,height:a,flipY:!1,skipColorSpaceConversion:!0,pixelDatatype:this.#Ee.PixelDatatype.FLOAT,pixelFormat:1===e?this.#Ee.PixelFormat.RED:this.#Ee.PixelFormat.RGBA,sampler:new this.#Ee.Sampler({wrapS:this.#Ee.TextureWrap.CLAMP_TO_EDGE,wrapT:this.#Ee.TextureWrap.CLAMP_TO_EDGE,minificationFilter:this.#Ee.TextureMinificationFilter.NEAREST,magnificationFilter:this.#Ee.TextureMagnificationFilter.NEAREST})})}#ga(t,e){const s=this.dimensions.x,i=this.dimensions.y;return new this.#Ee.Texture({context:t,width:s,height:i,flipY:!1,skipColorSpaceConversion:!0,pixelDatatype:this.#Ee.PixelDatatype.FLOAT,pixelFormat:this.#Ee.PixelFormat.RED,sampler:new this.#Ee.Sampler({wrapS:this.#Ee.TextureWrap.CLAMP_TO_EDGE,wrapT:this.#Ee.TextureWrap.CLAMP_TO_EDGE,minificationFilter:this.#Ee.TextureMinificationFilter.NEAREST,magnificationFilter:this.#Ee.TextureMagnificationFilter.NEAREST})})}#Ma(t){if(!this.#Yi)return;const e=new Float32Array(this.#Yi.buffer);this.#xa(this.splatCount,this.dimensions,this.#Wi,e,1)}#ya(){const t=this.#P.dynamicState,e=t.useSH&&this.hasUploadSH,s=this.#$i,i=t.clipBoxMatrixInv.toCesiumMatrix4(this.#ia);this.#Ai.viewport=function(){return{x:t.viewport.x,y:t.viewport.y}},this.#Ai.focal=function(){return t.focal},this.#Ai.pointsOnly=function(){return t.pointsOnly},this.#Ai.alpha=function(){return t.alpha},this.#Ai.useSH=function(){return e},this.#Ai.useCustomColor=function(){return t.useCustomColor},this.#Ai.cmrPos=function(){return t.cmrPosModelLocal.clone()},this.#Ai.clipPlane=function(){return t.clipPlane},this.#Ai.clipBoxMatrixInv=function(){return i},this.#Ai.clipBoxSide=function(){return t.clipBoxSide},this.#Ai.useIndexHost=function(){return s},this._rs!==t.renderState&&(this._rs=t.renderState),this.#qi!==t.passIndex&&(this.#qi=t.passIndex)}_setSHTexture(t){if(this.isDestroyed())return;if(this.hasUploadSH)return;this.hasUploadSH=!0,this.size=this.#ra();const e=this.#zi,s=this.shDimensions.x,i=this.shDimensions.y,a=new Float32Array(t.buffer),r=new this.#Ee.Texture({context:e,width:s,height:i,flipY:!1,skipColorSpaceConversion:!0,pixelDatatype:this.#Ee.PixelDatatype.FLOAT,pixelFormat:this.#Ee.PixelFormat.RGBA,sampler:new this.#Ee.Sampler({wrapS:this.#Ee.TextureWrap.CLAMP_TO_EDGE,wrapT:this.#Ee.TextureWrap.CLAMP_TO_EDGE,minificationFilter:this.#Ee.TextureMinificationFilter.NEAREST,magnificationFilter:this.#Ee.TextureMagnificationFilter.NEAREST})});return this.#xa(4*this.splatCount,this.shDimensions,r,a),this.#Ai.shRawTexture=()=>r,r}#oa(){if(this.#Gi===this.#Oe.splatIndexTex){const t=this.#Gi=this.#fa(this.#zi);this.#Ai.splatIndexes=function(){return t}}return this.#Gi}#ws(t){const e=this.#ji=this.#pa(t,!0),s=this.#Gi=this.#Oe.splatIndexTex,i=this.#Wi=this.#ga(t,this.#Yi),a=this.#Oe.rainbowTex;let r;this.#ki&&this.#Zi?this.#Qi=r=this._setSHTexture(this.#Zi):this.#Qi=r=this.#Oe.shTex,this.#Ai.splatData=()=>e,this.#Ai.splatIndexes=()=>s,this.#Ai.shRawTexture=()=>r,this.#Ai.customColors=()=>a,this.#Ai.splatIndexesHost=()=>i,this.#Ui=!0}update(t){this.isDestroyed()||this.show&&(this.isCached||this.#ws(t),this.isInitialized&&(this.#ta&&(this.#Ma(t.context),this.#ta=!1),this.#ya(),this.#Li=t.context.instancedArrays,this._createVertexArray&&(this.#Bi=this.#da(t.context),this.#ma(t.context,this.#Bi)),this.#Ri||this.#la(t,this._vs,this._fs),this.#ca(t)))}isDestroyed(){return!1}destroy(){if(!this.isDestroyed())return this.#Ei=void 0,this.distances=void 0,this.indexes=void 0,this.#Yi=void 0,this.pos=void 0,this.#ji&&(!this.#ji.isDestroyed()&&this.#ji.destroy(),this.#ji=void 0),this.#Gi!==this.#Oe.splatIndexTex&&(!this.#Gi.isDestroyed()&&this.#Gi.destroy(),this.#Gi=void 0),this.#Wi&&(!this.#Wi.isDestroyed()&&this.#Wi.destroy(),this.#Wi=void 0),this.#Qi!==this.#Oe.shTex&&(!this.#Qi.isDestroyed()&&this.#Qi.destroy(),this.#Qi=void 0),this.#Oe=null,this._sp=this._sp&&this._sp.destroy(),this._va=this._va&&this._va.destroy(),this.#Ee.destroyObject(this)}}const He="#version 300 es\nprecision highp float;\nin vec3 position;\nvoid main() {\n     gl_Position = vec4( position, 1.0 );\n}\n";class qe{#m=!1;#ba;#Ls;#wa={x:1024,y:2048};#va=void 0;#Sa=void 0;#_a=void 0;#Ca;#Ta;#Da;constructor(t){this.#ba=t,this.#Pa()}#Pa(){this.#Ca=this.#za(He,"#version 300 es\nprecision highp float;\nprecision highp int;\nlayout(location = 0) out vec4 pc_FragColor;\n\nuniform highp sampler2D u_data;\n\nuniform int stage;\nuniform int pass;\nuniform ivec2 dimension;\n\nvec4 fetch(int x, int y) {\n    return texelFetch(u_data, ivec2(x, y), 0);\n}\n\nvoid main () {\n\n    int fx = int(gl_FragCoord.x);\n    int fy = int(gl_FragCoord.y);\n    int index = fx + fy * dimension.x;\n\n    int pairIndex = index ^ pass;\n\n    int dFx = pairIndex % dimension.x;\n    int dFy = pairIndex / dimension.x;\n\n    bool mask = index > pairIndex;\n\n    vec4 indexValue = fetch(fx, fy);\n    vec4 pairValue = fetch(dFx, dFy);\n\n    bool up = !((index & stage) == 0); // 降序\n\n    // int b1 = (index - pairIndex) / abs(index - pairIndex);\n\n    // int vv = indexValue.x - pairValue.x;\n\n    // int b2 = (vv) / abs(vv);\n\n    // int b3 = min(index & stage, 2) - 1;\n    \n    // int rs1 = b1 * b2 * b3;\n\n    // pc_FragColor = max(rs1 * indexValue, -rs1 * pairValue);\n\n    if(up) {\n        if(indexValue.x > pairValue.x){\n            if(mask) {\n                pc_FragColor = indexValue;\n            } else {\n                pc_FragColor = pairValue;\n            }\n        } else {\n            if(mask) {\n                pc_FragColor = pairValue;\n            } else {\n                pc_FragColor = indexValue;\n            }\n        }\n    } else {\n        if(indexValue.x < pairValue.x){\n            if(mask) {\n                pc_FragColor = indexValue;\n            } else {\n                pc_FragColor = pairValue;\n            }\n        } else {\n            if(mask) {\n                pc_FragColor = pairValue;\n            } else {\n                pc_FragColor = indexValue;\n            }\n        }\n    }\n\n    \n}\n\n\n"),this.#Ta=this.#za(He,"#version 300 es\nprecision highp float;\nprecision highp int;\nlayout(location = 0) out vec4 pc_FragColor;\n\nuniform sampler2D transforms;\n\nuniform int splatCount;\nuniform ivec2 dimension;\nuniform ivec2 dataDimensions;\nuniform vec3 cmrPos;\n\nvoid main() {\n\n\n    int fx = int(gl_FragCoord.x);\n    int fy = int(gl_FragCoord.y);\n\n    int index = fx + fy * dimension.x;\n\n    int id1 = int(index * 2);\n    int x1 = id1 % int(dataDimensions.x);\n    int y1 = id1 / int(dataDimensions.x);\n\n    if(index >= splatCount) {\n      pc_FragColor = vec4(10., float(index), .0, .0);\n    } else {\n      vec4 sampledTransform = texelFetch(transforms, ivec2(x1, y1), 0);\n      float distance = length(vec3(sampledTransform.xyz) - cmrPos) * 1000.0 + 1000.0;\n      pc_FragColor = vec4(distance, float(index), .0, .0);\n    }\n}\n\n"),this.#Da=this.#Ea(this.#ba),this.#Aa(this.#ba),this.#_a=this.#Ia(this.#ba)}#za(t,e){const s=this.#ba.createShader(this.#ba.VERTEX_SHADER);if(this.#ba.shaderSource(s,t),this.#ba.compileShader(s),!this.#ba.getShaderParameter(s,this.#ba.COMPILE_STATUS))return console.error("An error occurred compiling the vertex shader: "+this.#ba.getShaderInfoLog(s)),this.#ba.deleteShader(s),null;const i=this.#ba.createShader(this.#ba.FRAGMENT_SHADER);if(this.#ba.shaderSource(i,e),this.#ba.compileShader(i),!this.#ba.getShaderParameter(i,this.#ba.COMPILE_STATUS))return console.error("An error occurred compiling the fragment shader: "+this.#ba.getShaderInfoLog(i)),this.#ba.deleteShader(i),null;const a=this.#ba.createProgram();return this.#ba.attachShader(a,s),this.#ba.attachShader(a,i),this.#ba.linkProgram(a),this.#ba.getProgramParameter(a,this.#ba.LINK_STATUS)?a:(console.error("Unable to initialize the shader program: "+this.#ba.getProgramInfoLog(a)),null)}#Ea(t){const e=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),s=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),s}#Aa(t){const e=this.#wa.x,s=this.#wa.y;this.#va=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.#va),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,e,s,0,t.RGBA,t.FLOAT,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),this.#Sa=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.#Sa),t.texImage2D(t.TEXTURE_2D,0,t.RGBA32F,e,s,0,t.RGBA,t.FLOAT,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST)}#Ia(t){const e=t.createFramebuffer();return t.bindFramebuffer(t.FRAMEBUFFER,e),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.#va._texture,0),e}#Fa(t,e,s){const i=s.getSortLocalCmrPos(),a=s.splatCount,r=s.dimensions,n=s.dataDimensions,h=s.transformsTexture;t.useProgram(e);const o=t.getUniformLocation(e,"transforms"),l=t.getUniformLocation(e,"splatCount"),c=t.getUniformLocation(e,"dimension"),u=t.getUniformLocation(e,"dataDimensions"),d=t.getUniformLocation(e,"cmrPos"),m=t.getAttribLocation(e,"position"),p=this.#Da;t.bindBuffer(t.ARRAY_BUFFER,p),t.vertexAttribPointer(m,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(m),t.uniform1i(l,a),t.uniform2i(c,r.x,r.y),t.uniform2i(u,n.x,n.y),t.uniform3f(d,i.x,i.y,i.z),t.uniform1i(o,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,h._texture),t.disable(t.DEPTH_TEST),t.disable(t.STENCIL_TEST),t.depthMask(!1),t.bindFramebuffer(t.FRAMEBUFFER,this.#_a),t.viewport(0,0,r.x,r.y),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.#va,0),t.drawArrays(t.TRIANGLES,0,6)}#Os(t,e,s){t.useProgram(e),t.bindFramebuffer(t.FRAMEBUFFER,this.#_a);const i=s.dimensions,a=s._sortInfos,r=t.getAttribLocation(e,"position"),n=this.#Da;t.bindBuffer(t.ARRAY_BUFFER,n),t.vertexAttribPointer(r,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(r);const h=t.getUniformLocation(e,"stage"),o=t.getUniformLocation(e,"pass"),l=t.getUniformLocation(e,"dimension"),c=t.getUniformLocation(e,"u_data");t.uniform2i(l,i.x,i.y),t.uniform1i(c,0),t.activeTexture(t.TEXTURE0);const u=i.x*i.y;let d,m=0;const p=Math.min(a.lastDrawCount+50,a.totalDrawCount);console.log("sorting !");for(let e=2;e<=u;e<<=1)for(let r=e>>1;r>0;r>>=1)if(m<a.lastDrawCount)m++;else{if(m===p)return void(a.lastDrawCount=p);m++,t.uniform1i(h,e),t.uniform1i(o,r),t.bindTexture(t.TEXTURE_2D,this.#va),t.viewport(0,0,i.x,i.y),m===a.totalDrawCount?t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s.indexRT._texture,0):t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.#Sa,0),t.drawArrays(t.TRIANGLES,0,6),d=this.#Sa,this.#Sa=this.#va,this.#va=d}p===a.totalDrawCount&&(s.setSorted(!0),this.#Ls=null,console.log("sort finished!"))}update(){this.#m||this.#Ls&&(this.#Ls?.transformsTexture?(this.#Ls._sortInfos.lastDrawCount<1&&this.#Fa(this.#ba,this.#Ta,this.#Ls),this.#Os(this.#ba,this.#Ca,this.#Ls),this.#ba.useProgram(null),this.#ba.bindFramebuffer(this.#ba.FRAMEBUFFER,null)):this.#Ls=null)}triggerSorting(t){this.#Ls||(this.#Ls=t)}dispose(){this.#m||this.#ba&&(this.#va&&(this.#ba.deleteTexture(this.#va),this.#va=void 0),this.#Sa&&(this.#ba.deleteTexture(this.#Sa),this.#Sa=void 0),this.#_a&&(this.#ba.deleteFramebuffer(this.#_a),this.#_a=void 0),this.#Da&&(this.#ba.deleteBuffer(this.#Da),this.#Da=void 0),this.#Ca&&(this.#ba.deleteProgram(this.#Ca),this.#Ca=void 0),this.#Ta&&(this.#ba.deleteProgram(this.#Ta),this.#Ta=void 0))}}class Oe{#m=!1;#Ee=void 0;#zi=void 0;#P=void 0;#Us=void 0;#W=void 0;#Gs=void 0;#$s;#Ra;#Ws=[];#Qs=[];#Zs=[];#Xs=[];#js=void 0;#Vs=void 0;#Et;constructor(t,e,s,i){this.#Et=t,this.#Ee=e,this.#P=s,this.#Us=this.#P.gpuCache,this.#W=this.#P.cpuCache,this.#zi=s.lccParam.scene.context,this.#$s=i,this.#Vs=new Ce(this.#P.config.CpuSortThreadNum),this.#P.config.WebglSortingEnable&&(this.#js=new qe(this.#zi._gl,this.#Ee))}setModelMatrix(t){t&&(this.#$s=t)}setPrj2ECEFMatrix(t){t&&(this.#Ra=t)}#Js(){if(this.#Gs)return this.#Gs;const t=this.#P.meta,e=this.#W.queryEnv(this.#P.renderID);if(!e||!t)return null;const{splatCounts:s,data:i,sh:a,pos:r}=e;return this.#Gs=new Be(this.#P,{context:this.#zi,matrix:this.#$s,prj2ECEF:this.#Ra,node:e,splatCount:s,data:i,pos:r,sh:a,isEnv:!0,meta:t,renderID:this.#Et}),this.#Gs}getEnvMesh(t=!0){return this.#Gs||this.#Js(),this.#Gs?this.#Gs:null}getMesh(t,e=!0){let s=this.#Us.queryMesh(t.renderID,t.id);if(s&&(!e||s.isInitialized))return s}clearCacheSHQueue(){this.#Qs=[]}pushCacheSHQueue(t){this.#Qs.push(t)}pushCacheQueue(t){this.#Ws.push(t)}clearCacheQueue(){this.#Ws=[]}pushSortQueue(t){this.#Zs.push(t)}clearSortQueue(){this.#Zs=[]}update(){if(this.#m)return;let t=null,i=null,a=null;for(let s=0;s<this.#Ws.length;s++)if(t=this.#Ws[s],!this.#Us.hasMesh(t.renderID,t.id)&&t?.isCache(e)){i=t.queryCache();const e=i.pos;a=new Be(this.#P,{context:this.#zi,matrix:this.#$s,prj2ECEF:this.#Ra,splatCount:t.points,data:i.data,pos:e,sh:i.sh,node:t,renderID:this.#Et}),this.#Us.pushMesh(t.renderID,t.id,a,a.size);break}for(let t=0;t<this.#Qs.length;++t){const e=this.#Qs[t],i=e.node;if(e.hasUploadSH||!i||!i.isCache(s))continue;const{sh:a}=i.queryCache();e._setSHTexture(a),this.#Us.flushMesh(this.#Et,i.id,e,e.size)}const r=this.#Zs;for(let t=0;t<r.length;++t){const e=r[t];if(e?.isSorting)continue;let s=!1;if(this.#Vs.isReady()){s=!0;const t=new _e;t.splatCount=e.splatCount,t.distances=e.distances,t.indexes=e.indexes,t.transforms=e.pos,t.mesh=e,t.beginCallback=t=>{const s=e.getSortLocalCmrPos();t.camPos={x:s.x,y:s.y,z:s.z},t.mesh.startSorting()},t.endCalllback=t=>{t.mesh.pos=t.transforms,t.mesh.indexes=t.indexes,t.mesh.distances=t.distances,t.mesh.setCPUSorted(!0)},this.#Vs.triggerSorting(t)}this.#P.config.WebglSortingEnable&&!s&&this.#js.triggerSorting(e)}this.#P.config.WebglSortingEnable&&this.#js.update()}dispose(){this.#m||(this.#m=!0,this.#P=void 0,this.#Us=void 0,this.#W=void 0,this.#zi=void 0,this.#$s=void 0,this.#Vs&&(this.#Vs.dispose(),this.#Vs=void 0),this.#js&&(this.#js.dispose(),this.#js=void 0),this.#Gs&&(this.#Gs.destroy(),this.#Gs=void 0))}}class Ue extends ot{static GlobalID=0;#m=!1;#M;#Ee;#bt;#ai;#ze;#W;#Us;#wt;#ri;#ka;#Na;#qi;#ni;#hi=[];#sa;#Ra;#La;#yt=new ht;#P;#It=!1;#ci=!0;#oi=new ze;#ui;#li=!1;#Ba=new J;constructor(t){super(),this.#M=Ue.GlobalID++,this.#P=t,this.#P.renderID=this.#M,this.#ze=this.#P.lccParam,this.#bt=this.#P.cameraMgr,this.#W=this.#P.cpuCache,this.#Us=this.#P.gpuCache,this.#wt=this.#P.dataLoader,this.#yt=this.#P.config,this.#Ee=this.#P.lccParam.renderLib,this.#sa=this.#ze.modelMatrix,this.#Ra,this.#ai=new xe(this.#P,this.#bt,this.#wt),this.#ka=ke(),this.#Na=this.#Ha(),this.#qi=this.#Ee.Pass.CESIUM_3D_TILE,this.#ri=new Oe(this.#M,this.#ze.renderLib,this.#P,this.#sa),this.#ni=new this.#Ee.PrimitiveCollection({destroyPrimitives:!1}),this.#ze.scene.primitives.add(this.#ni)}get id(){return this.#M}get root(){return this.#ni}get maxLoadSplatCount(){return this.#yt.maxLoadSplatCount}set maxLoadSplatCount(t){this.#yt.maxLoadSplatCount=t}get matrixWorld(){return(new jt).fromCesiumMatrix4(this.#sa)}get matrixWorldInverse(){return this.matrixWorld.invert()}get modelMatrix(){return this.#sa}set modelMatrix(t){this.#sa=t}get modelOffsetLocal(){}#Ha(){return this.#Ee.RenderState.fromCache({blending:this.#Ee.BlendingState.ALPHA_BLEND,depthTest:{enabled:!0,func:this.#Ee.WebGLConstants.ALWAYS},depthMask:!0,cull:{enabled:!1}})}setTranslation(){if(this.modelMatrix?this.#Ee.Matrix4.setTranslation(this.modelMatrix,translation,this.modelMatrix):this.modelMatrix=this.#Ee.Matrix4.fromTranslation(translation),this.#P.isRTK){this.#Ee.Transforms.eastNorthUpToFixedFrame(translation).clone(this.#Ra),this.#La.fromCesiumMatrix4(this.#Ra).invert();const t=this.#qa(translation);this.#Ba.copy(t)}}setRotation(t){if(this.modelMatrix){const e=this.#Ee.Matrix4.getTranslation(this.modelMatrix,new this.#Ee.Cartesian3),s=this.#Ee.Transforms.eastNorthUpToFixedFrame(e),i=this.#Ee.Matrix3.multiply(this.#Ee.Matrix4.getRotation(s,new this.#Ee.Matrix3),t,new this.#Ee.Matrix3);this.#Ee.Matrix4.setRotation(this.modelMatrix,i,this.modelMatrix)}else this.modelMatrix=this.#Ee.Matrix4.fromRotation(t)}setScale(t){this.modelMatrix?this.#Ee.Matrix4.setScale(this.modelMatrix,t,this.modelMatrix):this.modelMatrix=this.#Ee.Matrix4.fromScale(t)}setTranslationOffset(t){if(this.modelMatrix){const e=this.#Ee.Matrix4.fromTranslation(t);this.#Ee.Matrix4.multiply(this.modelMatrix,e,this.modelMatrix);const s=this.#Ee.Matrix4.getTranslation(this.modelMatrix,new this.#Ee.Cartesian3);if(this.#P.isRTK){this.#Ee.Transforms.eastNorthUpToFixedFrame(s).clone(this.#Ra),this.#La.fromCesiumMatrix4(this.#Ra).invert();const t=this.#qa(s);this.#Ba.copy(t)}}}getTranslation(){return this.modelMatrix?this.#Ee.Matrix4.getTranslation(this.modelMatrix,new this.#Ee.Cartesian3):null}getInstancedMesh(){return this}getEnvInstancedMesh(){return this}togglePointsDisplayMode(){this.#yt.pointsOnly=!this.#yt.pointsOnly}useEnvironment(t){this.#yt.useEnv=t,this.#ai.setConfigDirty()}useShcoef(t,e){this.#yt.useSH=t,this.#ai.setConfigDirty(),this.#It?t&&this.#ci&&(this.#ci=!1,this.#ai.loadSH((()=>{}),(t=>{e&&e(t)}),(()=>{console.error("load sh failed...")}))):console.error("meta is not ready")}setVisible(t){this.#yt.visible=t}setAlpha(t){t=Z.clamp(t,0,1),this.#yt.alpha=t}setClipBox(t){if(!(t&&t.scale&&t.rotation&&t.position))return void console.error("set failed !!!");const e=t.clipSide||1,s=rt("scale",t),i=rt("rotation",t),a=rt("position",t);s&&i&&a?this.#oi.update(a,i,s,e):console.error("set failed !!!")}setClipPlane(t,e){Array.isArray(t)&&"number"==typeof e?this.#P.dynamicState.clipPlane.set(t[0],t[1],t[2],e):console.error("setClipPlane failed: param error")}setStartLod(t){isNaN(t)||t<0?console.error("set failed !!!"):(this.#yt.MinLodUsed=t,this.#ai.setConfigDirty())}setMaxDistance(t){isNaN(t)||t<0?console.error("set failed !!!"):(this.#yt.MaxDistaneLimit=t,this.#ai.setConfigDirty())}setMaxSplats(t){isNaN(t)||t<0?console.error("set failed !!!"):(this.#yt.maxLoadSplatCount=t,this.#ai.setConfigDirty())}getCurrentConfig(){return this.#yt.getUserConfig()}getProjectionCoordinateSystemInfos(){const t=this.#P.meta?.data;if(t)return{epsg:t?.epsg,offset:{x:t.offset[0],y:t.offset[1],z:t.offset[2]}}}updateCurrentConfig(t){this.#yt.setUserConfig(t),this.#ai.setConfigDirty()}update(t){if(this.#m)return;if(this.#hi=[],this.#ni.removeAll(),this.#pi(t),this.#ai.update(t),!this.#It)return;const e=this.#ai.getRenderNodes();if(this.#xi(e),this.#gi(),this.#P.dynamicState.useEnv){const t=this.#ri.getEnvMesh();t&&(t.isInitialized&&this.#li&&this.#ni.add(t),t.checkNeedSort()&&this.#ri.pushSortQueue(t))}this.#ni._primitives.reverse(),this.#hi.forEach((t=>{this.#yt.useSH&&!t.hasUploadSH&&this.#ri.pushCacheSHQueue(t)})),this.#ri.update(t),this.#ni.show=this.#yt.visible,this.#Mi()}load(t,e,s,i){console.log("load ..."),this.#ai.load(t,(t=>{this.#It=!0,this.#Oa(t),console.log("meta: ",t),this.#pi(Date.now())}),(()=>{console.log("loading ready ..."),this.#li=!0,this.getInstancedMesh(),e&&e(this)}),(t=>{s&&s(t)}),(()=>{i&&i()}),(t=>{if(!t)return!0;let e=this.#Us.queryMesh(t.renderID,t.id);return!(!e||!e.isFirstSorted)}))}#Oa(t){!t.epsg||t.epsg<1?this.#P.isRTK=!1:this.#P.isRTK=!0;const{epsg:e,offset:s}=t;if(e>0){let i=`EPSG:${e}`,a="EPSG:4326",r=(new J).fromArray(s),n=this.#ka(i,a,r.toArray()),h=this.#Ee.Cartesian3.fromDegrees(n[0],n[1],n[2]);t.srcCode=i,t.targetCode=a,t.metaOffset=r,t.wgs84BLH=(new J).fromArray(n),t.wgs84Offset=(new J).copy(h),t.ecefMatrix=this.#Ee.Transforms.eastNorthUpToFixedFrame(h),t.prj2EcefMatrix=(new jt).fromCesiumMatrix4(t.ecefMatrix),t.prj2EcefMatrixInverse=t.prj2EcefMatrix.clone().invert(),this.#sa=this.#Ee.Matrix4.fromTranslation(h),this.#Ra=t.ecefMatrix,this.#La=t.prj2EcefMatrixInverse,this.#Ba.copy(r),this.#ri.setModelMatrix(this.#sa),this.#ri.setPrj2ECEFMatrix(this.#Ee.Matrix4.getMatrix3(this.#Ra,new this.#Ee.Matrix3))}else this.#ri.setModelMatrix(this.#sa),this.#Ra=this.#sa,this.#ri.setPrj2ECEFMatrix(this.#Ee.Matrix4.getMatrix3(this.#Ra,new this.#Ee.Matrix3))}#Ua(t){const e=[t.x,t.y,t.z],s=this.#P.meta.data.srcCode,i=this.#P.meta.data.targetCode,a=this.#ka(s,i,e);return this.#Ee.Cartesian3.fromDegrees(a[0],a[1],a[2])}#qa(t){var e=this.#Ee.Cartographic.fromCartesian(t);const s=[this.#Ee.Math.toDegrees(e.longitude),this.#Ee.Math.toDegrees(e.latitude),e.height],i=this.#P.meta.data.srcCode,a=this.#P.meta.data.targetCode,r=this.#ka(a,i,s);return(new J).fromArray(r)}raycast(t){if(this.#m)return console.error("The renderer had been dispose !!!"),null;if(!t||!t.evt||st(t.evt.x)||st(t.evt.y)||st(t.maxDistance)||st(t.radius))return null;if(t.maxDistance<0||t.radius<0)return null;const e=this.#bt.projectionMatrix.clone().invert(),s=nt(this.#ze.canvas,t.evt);s.applyMatrix4(e).applyMatrix4(this.#bt.cam2WorldMatrix);const i=this.#bt.position.clone(),a=s.sub(i).normalize();return this.raycastFromOrigin({origin:{x:i.x,y:i.y,z:i.z},direction:{x:a.x,y:a.y,z:a.z},maxDistance:t.maxDistance,radius:t.radius})}raycastFromOrigin(t){if(this.#m)return console.error("The renderer had been dispose !!!"),null;if(!t||!t.origin||!t.direction||st(t.maxDistance)||st(t.radius))return null;if(st(t.origin.x)||st(t.origin.y)||st(t.origin.z))return null;if(st(t.direction.x)||st(t.direction.y)||st(t.direction.z))return null;if(t.maxDistance<0||t.radius<0)return null;const e=new J(t.origin.x,t.origin.y,t.origin.z),s=new J(t.direction.x,t.direction.y,t.direction.z).normalize(),i=new we(e,s,t.maxDistance);let a,r;this.#P.isRTK?(a=i.clone().applyMatrix4((new jt).copy(this.#La)),r=i.clone().applyMatrix4((new jt).copy(this.matrixWorldInverse))):a=r=i.clone().applyMatrix4((new jt).copy(this.matrixWorldInverse));const n=t.radius;let h=[];this.#hi.forEach((t=>{if(t.isEnv)return;const e=t.getBBox(),s=a.intersectBox(e);s&&h.push({mesh:t,distance:s.distance})})),h.sort(((t,e)=>t.distance-e.distance));for(let t=0;t<h.length;++t){let e=h[t].mesh.intersectWithRay(r,n);if(e){const t=e.point;return t.applyMatrix4(this.matrixWorld),{x:t.x,y:t.y,z:t.z}}}return null}_paramToRay(t){const e=this.#bt.projectionMatrix.clone().invert(),s=nt(this.#ze.canvas,t.evt);s.applyMatrix4(e).applyMatrix4(this.#bt.cam2WorldMatrix);const i=this.#bt.position.clone(),a=s.sub(i).normalize();return new we(i,a,t.maxDistance)}_paramToRayFromOrigin(t){const e=new J(t.origin.x,t.origin.y,t.origin.z),s=new J(t.direction.x,t.direction.y,t.direction.z).normalize();return new we(e,s,t.maxDistance)}setRenderState(t){if(!t)return;t.hasOwnProperty("passIndex")&&t.passIndex!==this.#qi&&(this.#qi=t.passIndex);const e={blending:this.#Ee.BlendingState.ALPHA_BLEND,depthTest:{enabled:this.#Na.depthTest.enabled,func:this.#Na.depthTest.func},depthMask:this.#Na.depthMask,cull:{enabled:!1}};let s=!1;if(t.hasOwnProperty("depthTest")){const i=t.depthTest;i&&(i.hasOwnProperty("enabled")&&e.depthTest.enabled!==t.depthTest.enabled&&(e.depthTest.enabled=t.depthTest.enabled,s=!0),i.hasOwnProperty("func")&&e.depthTest.func!==t.depthTest.func&&(e.depthTest.func=t.depthTest.func,s=!0))}t.hasOwnProperty("depthMask")&&e.depthMask!==t.depthMask&&(e.depthMask=t.depthMask,s=!0),s&&(this.#Na=this.#Ee.RenderState.fromCache(e))}lowerToBottom(){this.#ze.scene.primitives.lowerToBottom(this.#ni)}raiseToTop(){this.#ze.scene.primitives.raiseToTop(this.#ni)}hasShcoef(){return!!this.#It&&this.#ai.hasSH}getBounds(){if(!this.#It)return null;const t=this.getTranslation();let e=this.#ai.bbox;if(!e)return null;let s=e.min,i=e.max;return{min:{x:s.x,y:s.y,z:s.z},max:{x:i.x,y:i.y,z:i.z},origin:{x:t.x,y:t.y,z:t.z}}}#di(t){const e=this.#bt.projectionMatrix.clone().invert(),s=nt(this.#ze.canvas,t.evt);s.applyMatrix4(e).applyMatrix4(this.#bt.cam2WorldMatrix);const i=this.#bt.position.clone(),a=s.sub(i).normalize();return new we(i,a,t.maxDistance).applyMatrix4((new jt).copy(this.matrixWorld).invert()).intersectBox(this.#ai.bbox)}getInstancedMesh(){return this.#ni}getEnvInstancedMesh(){return this.#ni}#pi(t){const e=this.#ze.canvas,s=this.#P.dynamicState,i=e.width,a=e.height,r=this.#bt.fov,n=this.#bt.projectionMatrix,h=this.#bt.cam2WorldMatrix,o=(new jt).copy(this.matrixWorld).invert(),c=(new jt).multiplyMatrices(o,h),u=this.#bt.position,d=new J(0,0,-1).applyMatrix4(h),m=this.#bt.position.clone().applyMatrix4(o);if(s.focal=Math.max(i,a)/2/Math.tan(r/2/180*Math.PI),s.viewport.x=i,s.viewport.y=a,s.cmrPos.copy(u),s.cmrForward.copy(d),s.cmrPosLocal.copy(m),s.cmrProjMatrix.copy(n),s.cmr2LocalMatrix.copy(c),s.frustum=new de,s.frustum.setFromProjectionMatrix(n),this.#P.isRTK){const t=this.#qa(u).sub(this.#Ba);s.cmrPosModelLocal.copy(t),s.cmr2ModelLocalMatrix.copy((new jt).multiplyMatrices(this.#La,h)),s.frustum.planes.forEach((t=>t.applyMatrix4(s.cmr2ModelLocalMatrix)))}else s.cmrPosModelLocal.copy(m),s.cmr2ModelLocalMatrix.copy(c),s.frustum.planes.forEach((t=>t.applyMatrix4(c)));s.alpha=this.#yt.alpha,s.visible=this.#yt.visible,s.useEnv=this.#yt.useEnv,s.useSH=this.#yt.useSH,s.pointsOnly=this.#yt.pointsOnly,s.useCustomColor=!(this.#yt.pointsColor!==l),s.clipBoxSide=this.#oi.clipSide,s.clipBoxMatrixInv.copy(this.#oi.matrixInverse),s.renderState=this.#Na,s.passIndex=this.#qi,s.tick=t}#xi(t){if(0!=t.length){this.#ri.clearCacheQueue(),this.#ri.clearCacheSHQueue(),this.#ri.clearSortQueue();for(let s=0;s<t.length;++s){const i=t[s];if(!i)continue;const a=i.parent,r=i.level,n=a.nodes.length;let h,o=this.#Us.queryMesh(i.renderID,i.id);if(!o&&i.isCache(e)?this.#ri.pushCacheQueue(i):o&&o.checkNeedSort()?this.#ri.pushSortQueue(o):o?.isFirstSorted&&(h=o),!h){let t=0;for(let e=r;e<n;e++){const s=a.nodes[e];if(!s||s.points<this.#yt.MinValidSplatsInNode)continue;const i=this.#Us.queryMesh(s.renderID,s.id);if(!i||!i.isInitialized)continue;const r=i.sortTickLast;r>t&&(t=r,h=i)}}h&&(this.#hi.push(h),this.#ni.add(h))}}}#gi(){if(this.#li)return;const t=this.#ai.getLoadingNodes();for(let s=0;s<t.length;++s){const i=t[s];if(!i)continue;let a=this.#Us.queryMesh(i.renderID,i.id);!a&&i.isCache(e)?this.#ri.pushCacheQueue(i):a&&!a.isFirstSorted&&this.#ri.pushSortQueue(a)}}#Mi(){let t=0,e=0,s=1e9;this.#hi.forEach((i=>{t+=i.splatCount,e=Math.max(e,i.splatCount),s=Math.min(s,i.splatCount)}));const i=this.#P.performance;i.totalPoints=t,i.maxPoints=e,i.minPoints=s,i.meshNum=this.#hi.length;const a=this.#P.dynamicState.tick;void 0===this.#ui&&(this.#ui=a),a-this.#ui>2e3&&(this.#ui=a)}dispose(){if(this.#m)return;this.#m=!0,this.#ni&&!this.#ni.isDestroyed()&&(this.#ze.scene.primitives.remove(this.#ni),this.#ni=void 0),this.#ri.dispose();const t=[];this.#ai.getAllNodeID(t),this.#ai.dispose(),this.#W.clear(this.id,t),this.#Us.clear(this.id,t)}}class Ve{#ze;#Ee;#Ae;#Va;#ja;#Ga;#zi;get rainbowTex(){return this.#Ae}get shTex(){return this.#Va}get indexHostTex(){return this.#ja}get splatIndexTex(){return this.#Ga}constructor(t){this.#ze=t,this.#Ee=this.#ze.renderLib,this.#zi=this.#ze.scene.context,this.#Le(),this.#Wa(),this.#Qa()}_dispose(){this.#Ae&&(!this.#Ae.isDestroyed()&&this.#Ae.destroy(),this.#Ae=void 0),this.#Va&&(!this.#Va.isDestroyed()&&this.#Va.destroy(),this.#Va=void 0),this.#Ga&&(!this.#Ga.isDestroyed()&&this.#Ga.destroy(),this.#Ga=void 0),this.#ze=void 0,this.#Ee=void 0,this.#zi=void 0}#Le(){const t=new Image;t.src=h[1],t.onload=()=>{this.#Ae=new this.#Ee.Texture({context:this.#zi,width:t.width,height:t.height,flipY:!1,skipColorSpaceConversion:!1,source:t,pixelDatatype:this.#Ee.PixelDatatype.UNSIGNED_BYTE,pixelFormat:this.#Ee.PixelFormat.RGBA,sampler:new this.#Ee.Sampler({wrapS:this.#Ee.TextureWrap.CLAMP_TO_EDGE,wrapT:this.#Ee.TextureWrap.CLAMP_TO_EDGE,minificationFilter:this.#Ee.TextureMinificationFilter.NEAREST,magnificationFilter:this.#Ee.TextureMagnificationFilter.NEAREST})})}}#Wa(){if(this.#Va)return;this.#Va=new this.#Ee.Texture({context:this.#zi,width:1,height:1,flipY:!1,skipColorSpaceConversion:!0,source:{arrayBufferView:new Float32Array(4)},pixelDatatype:this.#Ee.PixelDatatype.FLOAT,pixelFormat:this.#Ee.PixelFormat.RGBA,sampler:new this.#Ee.Sampler({wrapS:this.#Ee.TextureWrap.CLAMP_TO_EDGE,wrapT:this.#Ee.TextureWrap.CLAMP_TO_EDGE,minificationFilter:this.#Ee.TextureMinificationFilter.NEAREST,magnificationFilter:this.#Ee.TextureMagnificationFilter.NEAREST})})}#Xa(){if(this.#ja)return;this.#ja=new this.#Ee.Texture({context:this.#zi,width:1,height:1,flipY:!1,skipColorSpaceConversion:!0,source:{arrayBufferView:new Float32Array(1)},pixelDatatype:this.#Ee.PixelDatatype.FLOAT,pixelFormat:this.#Ee.PixelFormat.RED,sampler:new this.#Ee.Sampler({wrapS:this.#Ee.TextureWrap.CLAMP_TO_EDGE,wrapT:this.#Ee.TextureWrap.CLAMP_TO_EDGE,minificationFilter:this.#Ee.TextureMinificationFilter.NEAREST,magnificationFilter:this.#Ee.TextureMagnificationFilter.NEAREST})})}#Qa(){if(this.#Ga)return;this.#Ga=new this.#Ee.Texture({context:this.#zi,width:1,height:1,flipY:!1,skipColorSpaceConversion:!0,source:{arrayBufferView:new Float32Array(4)},pixelDatatype:this.#Ee.PixelDatatype.FLOAT,pixelFormat:this.#Ee.PixelFormat.RGBA,sampler:new this.#Ee.Sampler({wrapS:this.#Ee.TextureWrap.CLAMP_TO_EDGE,wrapT:this.#Ee.TextureWrap.CLAMP_TO_EDGE,minificationFilter:this.#Ee.TextureMinificationFilter.NEAREST,magnificationFilter:this.#Ee.TextureMagnificationFilter.NEAREST})})}}class je extends Ot{#yi;#ze;#bt;#W;#Us;#wt;#Q;#bi=[];#Oe;isDispose=!1;constructor(t,e){super(),this.#yi=t,this.#ze=e,this.#Oe=new Ve(e),this.#bt=new Re(e),this.#W=new ut(this.#yi.MaxCPUCacheSize,void 0),this.#Us=new Ft(this.#yi.MaxGPUCacheSize,((t,e)=>{e&&e.destroy()})),this.#Q=new Le,this.#wt=new qt(this.#W,this.#Q,!0)}createRenderer(){let t=new ht(this.#yi);t.useEnv=this.#ze.useEnv,t.gpuAcceleration=this.#ze.gpuAcceleration,t.pointsColor=this.#ze.pointsColor;let e=new me;e.config=t,e.lccParam=this.#ze,e.cpuCache=this.#W,e.gpuCache=this.#Us,e.dataLoader=this.#wt,e.resources=this.#Oe,e.cameraMgr=this.#bt,e.platform=this.#yi;let s=new Ue(e);return this.#bi.push(s),s}update(t){this.#bt._update(t),this.#W.update(t),this.#Us.update(t),this.#wt.update(t),this.#Q?.update(t),this.#bi.forEach((e=>{e.update(t)}))}getAllRenderers(){return this.#bi}destroyRenderer(t){this.#bi.indexOf(t)<0||(this.#bi=this.#bi.filter((e=>e!==t)),t?.dispose())}dispose(){this.isDispose||(this.#bi.forEach((t=>{t.dispose()})),this.#bi=[],this.#wt.dispose(),this.#Q.dispose(),this.#Us.dispose(),this.#W.dispose(),this.#bt._dispose(),this.#Oe._dispose(),this.isDispose=!0)}raycast(t){if(0==this.#bi.length)return null;if(1==this.#bi.length)return this.#bi[0].raycast(t);const e=[];return this.#bi.forEach(((s,i,a)=>{let r=s._paramToRay(t),n=s.raycast(t);if(n){let t=r.origin.distanceToSquared(new J(n.x,n.y,n.z));e.push({intersect:n,distance:t,renderIndex:i})}})),e.sort(((t,e)=>t.distance-e.distance)),e.length>0?e[0].intersect:null}raycastFromOrigin(t){if(0==this.#bi.length)return null;if(1==this.#bi.length)return this.#bi[0].raycastFromOrigin(t);const e=[];return this.#bi.forEach(((s,i,a)=>{let r=s._paramToRayFromOrigin(t),n=s.raycastFromOrigin(t);if(n){let t=r.origin.distanceToSquared(new J(n.x,n.y,n.z));e.push({intersect:n,distance:t,renderIndex:i})}})),e.sort(((t,e)=>t.distance-e.distance)),e.length>0?e[0].intersect:null}}class Ge{#m=!1;#Za=null;#Ya=null;#Ka;constructor(t){if(!t)throw new Error("no params !");if(!t.scene)throw new Error("no scene !");if(!t.camera)throw new Error("no camera !");if(!t.canvas)throw new Error("no canvas !");if(!t.renderLib)throw new Error("no renderLib !");const e=new O(t.renderLib);if(e.libType===n)throw new Error("unknow engine type !");if(e.libType===a&&!t.renderer)throw new Error("no renderer !");this.#Ya=t;const s="boolean"!=typeof t.useEnv||t.useEnv,i="boolean"==typeof t.gpuAcceleration&&t.gpuAcceleration,r="default"===t.pointsColor?o:l;let h={scene:t.scene,camera:t.camera,canvas:t.canvas,renderLib:t.renderLib,renderer:t.renderer,modelMatrix:t.modelMatrix,useEnv:s,gpuAcceleration:i,pointsColor:r};e.libType===a?this.#Za=new Fe(e,h):(this.#Za=new je(e,h),this.#Ka=t.scene.render,this.#Ja(this.#Ya))}#Ja(t){if(t?.scene){const s=this.#Za;t.scene.render=(e=t.scene.render,function(){if(s&&!s?.isDispose){const t=Date.now();s.update(t)}e.apply(this,arguments)})}var e}#$a(t){t.scene.render=(()=>this.#Ka)(),this.#Ka=void 0}load(t,e,s,i){if(this.#m||!t)return;let a=this.#Za.createRenderer();return a.load(t,e,s,i),a}unload(t){!this.#m&&t&&this.#Za.destroyRenderer(t)}getAllRenderers(){return this.#m?[]:this.#Za.getAllRenderers()}update(){if(this.#m)return;const t=Date.now();this.#Za.update(t)}dispose(){this.#m?console.error("LccManager had been disposed !!!"):(this.#m=!0,this.#Ya?.scene&&this.#$a(),this.#Za.dispose(),this.#Za=null)}raycast(t){return this.#m||!t||!t.evt||st(t.evt.x)||st(t.evt.y)||st(t.maxDistance)||st(t.radius)||t.maxDistance<0||t.radius<0?null:this.#Za.raycast(t)}raycastFromOrigin(t){return this.#m?null:t&&t.origin&&t.direction&&!st(t.maxDistance)&&!st(t.radius)?st(t.origin.x)||st(t.origin.y)||st(t.origin.z)||st(t.direction.x)||st(t.direction.y)||st(t.direction.z)||t.maxDistance<0||t.radius<0?null:this.#Za.raycastFromOrigin(t):null}}let We=null;const Qe={load:function(t,e,s,i){return We||(We=new Ge(t)),We.load(t?.dataPath,e,s,i)},update:function(){We?.update()},unload:function(t){We?.unload(t)},raycast:function(t){return We?.raycast(t)},raycastFromOrigin:function(t){return We?.raycastFromOrigin(t)}};t.LCCRender=Qe}));
